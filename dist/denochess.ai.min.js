/*! Deno-Chess 0.6.0, (c) 2023, license: MIT */
var DenoChessAI=(()=>{var Tt=Object.defineProperty,he=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var Nt=Object.getOwnPropertySymbols;var Ie=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable,Ot=Math.pow,wt=(e,t,o)=>t in e?Tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Lt=(e,t)=>{for(var o in t||(t={}))Ie.call(t,o)&&wt(e,o,t[o]);if(Nt)for(var o of Nt(t))ke.call(t,o)&&wt(e,o,t[o]);return e},Kt=(e,t)=>he(e,xe(t)),_e=e=>Tt(e,"__esModule",{value:!0});var ge=(e,t)=>{_e(e);for(var o in t)Tt(e,o,{get:t[o],enumerable:!0})};var Yt=(e,t,o)=>{if(!t.has(e))throw TypeError("Cannot "+o)};var E=(e,t,o)=>(Yt(e,t,"read from private field"),o?o.call(e):t.get(e)),O=(e,t,o)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,o)},Y=(e,t,o,r)=>(Yt(e,t,"write to private field"),r?r.call(e,o):t.set(e,o),o);var so={};ge(so,{BeginnerAI:()=>kt});var f=0;function P(e){return e&7}function T(e){return e&8}function V(e){return Boolean(e&16)}function Mt(e){return e===f?e:e|16}function Ut(e,t){return e===f?e:e&248|t&7}var Pt=(e,t,o=!1)=>e|t|Number(o)<<4;var nt=class extends Error{};var at=class extends nt{};function U(e,t){if(!e)throw new nt(t)}var yt=0,ct=10;var Ft=20,Ht=21,Wt=22,Dt=23,Qt=24;var m=0,S=8;var y=1,A=2,k=3,h=4,x=5,I=6,be={[y]:"P",[A]:"B",[k]:"N",[h]:"R",[x]:"Q",[I]:"K"};function Vt(e){return be[e]}var qt=0,it=8,At=[16,1,-16,-1,17,-15,-17,15],$t=[31,33,14,18,-18,-14,-33,-31],Xt={[m]:[15,17],[S]:[-15,-17]};function pt(e,t,o){let r=e.current.attacks,s=o<<4;return Boolean(r[t|s|it]||r[t|s|qt])}function Zt(e,t,o,r){let s=e.current.attacks,n=e.current.board;switch(r){case y:for(let a of Xt[o])q(s,t+a,o,-1);break;case k:for(let a of $t)q(s,t+a,o,-1);break;case I:for(let a of At)q(s,t+a,o,-1);break;case A:for(let a=4;a<8;a++)F(s,n,t,o,a,0);break;case h:for(let a=0;a<4;a++)F(s,n,t,o,a,0);break;case x:for(let a=0;a<8;a++)F(s,n,t,o,a,0);break}jt(e,t,1)}function zt(e,t,o,r){let s=e.current.attacks,n=e.current.board;switch(jt(e,t,0),r){case y:for(let a of Xt[o])q(s,t+a,o,1);break;case k:for(let a of $t)q(s,t+a,o,1);break;case I:for(let a of At)q(s,t+a,o,1);break;case A:for(let a=4;a<8;a++)F(s,n,t,o,a,1);break;case h:for(let a=0;a<4;a++)F(s,n,t,o,a,1);break;case x:for(let a=0;a<8;a++)F(s,n,t,o,a,1);break}}function jt(e,t,o){let r=e.current.attacks,s=e.current.board;for(let n=0;n<=8;n+=8){let a=n<<4,i=r[t|a|it];for(let c=0;c<8;c++)i&1<<c&&F(r,s,t,n,c,o)}}function F(e,t,o,r,s,n){let a=At[s];for(;((o+=a)&136)==0&&(Re(e,o,r,s,n),t[o]===f););}function q(e,t,o,r){if(t&136)return;let s=o<<4;e[t|s|qt]+=r}function Re(e,t,o,r,s){let n=o<<4;s?e[t|n|it]|=1<<r:e[t|n|it]&=~(1<<r)}var Jt=8*8*2,G,g,X=class{constructor(){O(this,G,0);O(this,g,[te()]);this.current=E(this,g)[0]}reset(){Y(this,G,0);let t=this.current=E(this,g)[0];t.board.fill(f),t.attacks.fill(0),t.clock=0,t.moveNum=0,t.ep=136,t.status=yt,t.turn=m,t.seen={},t.castles=0,t.moveCache[m]=null,t.moveCache[S]=null,t.pieceList=[]}set(t,o){U((t&136)==0,"Invalid set() coord");let r=this.current.board[t];if(r!==f){let s=T(r),n=P(r);Zt(this,t,s,n)}if(this.current.board[t]=o,o!==f){let s=T(o),n=P(o);zt(this,t,s,n)}if(r===f!=(o===f)){let s=this.current.pieceList;if(r===f)s.push(t);else{let n=s.indexOf(t),a=s.length-1;if(n!==a){let i=s[a];s[a]=t,s[n]=i}s.pop()}}}get(t){return U((t&136)==0,"Invalid get() coord"),this.current.board[t]}putBoardHash(t){for(let o=E(this,G);o>=0;o--)if(t in E(this,g)[o].seen){let r=1+E(this,g)[o].seen[t];return this.current.seen[t]=r,r}return this.current.seen[t]=1,1}removeBoardHash(t){for(let o=E(this,G);o>=0;o--)if(t in E(this,g)[o].seen){this.current.seen[t]--;return}}save(){let t=Y(this,G,+E(this,G)+1);t===E(this,g).length&&E(this,g).push(te()),this.current=E(this,g)[t],ve(E(this,g)[t-1],this.current)}restore(){if(E(this,G)>0){let t=Y(this,G,+E(this,G)-1);this.current=E(this,g)[t]}}getPriorState(){let t=this.current;return{clock:t.clock,moveNum:t.moveNum,ep:t.ep,status:t.status,castles:t.castles}}};G=new WeakMap,g=new WeakMap;function te(){return{board:new Uint8Array(Jt).fill(f),attacks:new Uint8Array(Jt*2).fill(0),clock:0,moveNum:1,ep:136,status:yt,turn:m,seen:{},castles:0,moveCache:{[m]:null,[S]:null},pieceList:[]}}function ve(e,t){t.board.set(e.board),t.attacks.set(e.attacks),t.clock=e.clock,t.moveNum=e.moveNum,t.ep=e.ep,t.status=e.status,t.turn=e.turn,t.seen={},t.castles=e.castles,t.moveCache[m]=e.moveCache[m],t.moveCache[S]=e.moveCache[S],t.pieceList=e.pieceList.slice()}var Be=/^[a-h][1-8]$/i,Ge="abcdefgh",Ne="12345678",Oe=e=>[e&7,e>>>4],we=(e,t)=>(t&7)<<4|e&7,ee=e=>{U(Be.test(e),"Invalid coord");let t=e.toLowerCase(),o=t.charCodeAt(0)-97,r=t.charCodeAt(1)-49;return we(o,r)},ht=e=>{let[t,o]=Oe(e);return Ge[t]+Ne[o]};function oe(e,t,o,r){return t&15|(e&15)<<4|(r&15)<<8|(o&15)<<12}function re(e,t){return t===m?e&65280|136:e&255|34816}function xt(e,t){let o=t<64?0:8,r=o+4,s=t&15;if((e>>>o&15)===s){let n=e&~(15<<o),a=8<<o;return n|a}if((e>>>r&15)===s){let n=e&~(15<<r),a=8<<r;return n|a}return e}function w(e,t,o){let r=t+(o?0:4);return e>>>r&15}function se(e){let t=0,o=Array(8).fill(0),r=0;for(let a of e.current.pieceList){let i=e.get(a),c=P(i);if(c===y||c===h||c===x)return!1;t++,c===A&&(r+=(a>>>4^a)&1),o[c]++}if(t===2)return!0;let s=o[A],n=o[k];return t===3&&(s===1||n===1)||t===s+2&&(r===0||r===s)}var Le=" PBNRQK  pbnrqk";function ne(e){let t="",o=0;for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);if(i===f){o++;continue}o&&(t+=o,o=0);let c=i&15;t+=Le[c]}o&&(t+=o),t+=";";let r=e.current.castles;return t+=Z(w(r,m,!0)),t+=Z(w(r,m,!1)),t+=Z(w(r,S,!0)),t+=Z(w(r,S,!1)),t+=";"+Z((e.current.ep||136)&15),t}function Z(e){return e&8?"-":String(e)}function z(e,t){let o=8-t;for(let r of e.current.pieceList){let s=e.get(r);if(!(P(s)!==I||T(s)!==t)&&pt(e,r,o))return!0}return!1}function ae(e,t,o,r){return L(e,t,o,0,0,0,0,0,0,0,r)}function ce(e,t,o,r,s,n){return L(e,t,o,r,s,0,0,0,0,0,n)}function It(e,t,o,r,s,n,a){return L(e,t,o,0,0,r,s,n,0,0,a)}function L(e,t,o,r,s,n,a,i,c,p,u){return{what:e,from:t,dest:o,capture:r,captureCoord:s,castleRook:n,castleRookFrom:a,castleRookDest:i,promote:c,markEnPassant:p,prior:u}}function ie(e,t){return Kt(Lt({},e),{promote:t})}function j(e,t){let o=e.current;o.ep=136;let r=Mt(t.what),s=T(r),n=P(r);n===I&&(o.castles=re(o.castles,s)),n===h&&!V(t.what)&&(o.castles=xt(o.castles,t.from)),t.markEnPassant&&(o.ep=t.markEnPassant),t.promote&&(r=Ut(r,t.promote)),e.set(t.dest,r),e.set(t.from,f),t.capture&&t.captureCoord!==t.dest&&e.set(t.captureCoord,f),t.castleRook&&(e.set(t.castleRookDest,Mt(t.castleRook)),e.set(t.castleRookFrom,f)),T(r)&&o.moveNum++,t.capture||P(t.what)===y?o.clock=0:o.clock++,t.capture&&P(t.capture)===h&&!V(t.capture)&&(o.castles=xt(o.castles,t.captureCoord)),o.moveCache[m]=null,o.moveCache[S]=null,o.turn=8-o.turn}var ft=[16,1,-16,-1,17,-15,-17,15],Ke=[31,33,14,18,-18,-14,-33,-31],Ye=[-1,1],Ue=[x,h,k,A];function H(e,t){let o=e.current.moveCache[t];if(o)return o.slice();let r=[];for(let s of e.current.pieceList){let n=e.get(s);T(n)===t&&Fe(e,s,r)}return e.current.moveCache[t]=r,r}function Fe(e,t,o=[]){let r=e.get(t),s=e.getPriorState();switch(U(r!==f,"Listing moves of empty space"),e.save(),e.set(t,f),P(r)){case A:J(e,r,t,ft,4,8,8,o,s);break;case h:J(e,r,t,ft,0,4,8,o,s);break;case x:J(e,r,t,ft,0,8,8,o,s);break;case k:J(e,r,t,Ke,0,8,1,o,s);break;case I:J(e,r,t,ft,0,8,1,o,s),He(e,r,t,o,s);break;case y:We(e,r,t,o,s);break}return e.restore(),o}function J(e,t,o,r,s,n,a,i,c){let p=T(t),u=8-p;for(let d=s;d<n;d++){let M=r[d];for(let l=o+M,C=0;(l&136)==0&&C<a;l+=M,C++){let _=e.get(l);if(_===f){W(e,i,ae(t,o,l,c));continue}T(_)===u&&W(e,i,ce(t,o,l,_,l,c));break}}}function He(e,t,o,r,s){if(V(t))return;let n=T(t),a=e.current.castles,i=w(a,n,!0),c=w(a,n,!1),p=o&240;if((i&8)==0){let u=p|6,d=p|i,M=p|5;pe(e,r,It(t,o,u,e.get(d),d,M,s))}if((c&8)==0){let u=p|2,d=p|c,M=p|3;pe(e,r,It(t,o,u,e.get(d),d,M,s))}}function We(e,t,o,r,s){let n=T(t),a=8-n,i=n===m?1:-1,c=o+16*i,p=o+32*i;if(c&136)return r;let u=p&136?x:0;e.get(c)===f&&(W(e,r,L(t,o,c,0,0,0,0,0,u,0,s)),!V(t)&&(p&136)==0&&e.get(p)===f&&W(e,r,L(t,o,p,0,0,0,0,0,0,c,s)));let d=e.current.ep;for(let M of Ye){let l=c+M;if(l&136)continue;let C=e.get(l);if(l===d){let _=o+M,$=e.get(_);W(e,r,L(t,o,l,$,_,0,0,0,u,0,s))}else C!==f&&T(C)===a&&W(e,r,L(t,o,l,C,l,0,0,0,u,0,s))}return r}function W(e,t,o){let r=T(o.what);if(e.save(),j(e,o),!z(e,r))if(o.promote)for(let s of Ue)t.push(ie(o,s));else t.push(o);e.restore()}function pe(e,t,o){let r=T(o.what),s=Math.min(o.castleRookFrom,o.castleRookDest,o.from,o.dest),n=Math.max(o.castleRookFrom,o.castleRookDest,o.from,o.dest);for(let p=s;p<=n;p++){if(p===o.from||p===o.castleRookFrom)continue;if(e.get(p)!==f)return}e.save(),e.set(o.from,f),e.set(o.castleRookFrom,f);let a=Math.min(o.from,o.dest),i=Math.max(o.from,o.dest);for(let p=a;p<=i;p++)e.set(p,o.what);let c=z(e,r);e.restore(),!c&&W(e,t,o)}function mt(e,t){let o=8-t,r=z(e,o),s=H(e,o).length>0,n=e.putBoardHash(ne(e)),a=De(e,r,s,n);return{enemyInCheck:r,enemyCanMove:s,newGameStatus:a}}function De(e,t,o,r){let s=e.current.status;return o?e.current.clock>=100?Dt:r>=3?Wt:se(e)?Qt:s:t?ct:Ht}var Qe=/[1-8]/,Ve=/[PBNRQK]/,qe=/[pbnrqk]/,$e=/^((?:[pbnrqkPBNRQK1-8]{1,8}\/){7}[pbnrqkPBNRQK1-8]{1,8})\s+([wb])\s+(K?Q?k?q?|-)\s+([a-h][36]|-)\s+(\d+)\s+(\d+)$/;function fe(e,t){t&&t.reset();let o=t||new X;e=e.trim();let r=e.match($e);if(!r)throw new at("Bad FEN string");let s=r[1].split("/");for(let i=7;i>=0;i--){let c=0,p=s[7-i];for(let u=0;u<8;u++){let d=i<<4|u;if(c>=p.length)throw new at(`Bad FEN string: Rank ${i+1} had less than 8 files`);let M=p[c++];if(Qe.test(M)){let l=parseInt(M,10);for(let C=0;C<l;C++)o.set(d+C,f);u+=l-1}else if(Ve.test(M)){let l=me(M);o.set(d,ue(m,l,i))}else if(qe.test(M)){let l=me(M);o.set(d,ue(S,l,i))}}}let n=ze(r[2]);o.current.turn=n,o.current.castles=je(r[3]),r[4]!=="-"&&(o.current.ep=ee(r[4])),o.current.clock=parseInt(r[5],10),o.current.moveNum=parseInt(r[6],10);let a=mt(o,8-n);return o.current.status=a.newGameStatus,o}var Xe={p:y,b:A,n:k,r:h,q:x,k:I};function me(e){return Xe[e.toLowerCase()]}var Ze={w:m,b:S};function ze(e){return Ze[e]}function je(e){let t=136,o=136,r=136,s=136;if(e!=="-")for(let n=0;n<e.length;n++)switch(e[n]){case"K":o=7;break;case"Q":t=0;break;case"k":s=119;break;case"q":r=112;break}return oe(t,o,r,s)}function ue(e,t,o){return t===y?Pt(t,e,!(o===1&&e===m||o===6&&e===S)):Pt(t,e,!1)}var ut=Ot(2,32),lt=1e3;function le(e){if(isNaN(e)||e>lt||e<-lt||e===0)throw new Error("Out of range checkmate score: "+e);return e>0?ut+lt-e:-ut-lt-e}function Ce(e){if(isNaN(e)||e>=ut||e<=-ut)throw new Error("Out of range move score: "+e);return e}function Ee(e,t,o,r,s){return de(e,t,0,o,-Infinity,Infinity,r,s)}function de(e,t,o,r,s,n,a,i){let c=8-t,p=mt(e,c);if(p.newGameStatus===ct)return{score:le(c===m?o+1:-o-1),nodes:1};if(p.newGameStatus>=Ft)return{score:0,nodes:1};if(o>=r)return{score:Ce(i(e)),nodes:1};let u=t===m?-Infinity:Infinity,d=[],M=a(e),l=0;for(let C of M){e.save(),j(e,C);let{score:_,nodes:$}=de(e,c,o+1,r,s,n,a,i);if(e.restore(),l+=$,_===u)d.push(C);else if(t===m){if(_>u&&(u=_,d=[C]),u>=n)break;s<u&&(s=u)}else if(t===S){if(_<u&&(u=_,d=[C]),u<=s)break;n>u&&(n=_)}}return o?{score:u,nodes:l}:{score:u,move:Je(d),nodes:l}}function Je(e){return e[Math.floor(Math.random()*e.length)]}function Se(e,t){let o=t.current.turn,s=H(t,o).map(n=>({move:n,score:to(e,t,n,o)}));return s.sort((n,a)=>a.score-n.score),s.map(({move:n})=>n)}function to({Material:e},t,o,r){let s=0;o.capture&&(s+=1e3+e[P(o.capture)]-e[P(o.what)]),o.promote&&(s+=e[o.promote]);let n=8-r;return pt(t,o.dest,n)&&(s-=e[P(o.what)]),s}var tt=[4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,4,0,2,2,2,2,0,4,0,0,0,0,0,0,0,0,4,0,2,1,1,2,0,4,0,0,0,0,0,0,0,0,4,0,2,1,1,2,0,4,0,0,0,0,0,0,0,0,4,0,2,2,2,2,0,4,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0],Ct=1,Te=2,eo=4;function Me(e,{PhaseOverride:t,Material:o,Mobility:r,PawnCenter:s,PawnCenterAttack:n,MinorCenter:a,QueenCenter:i,PieceCenterAttack:c,PieceOuterCenter:p,KingEndgameEdge:u,KingEndgameOuterCenter:d,KingEndgameCenter:M}){var _t,gt,bt,Rt;let l=t!=null?t:ro(e),C=0,_=H(e,m),$=H(e,S),B={};for(let b of _)(gt=B[_t=b.from])!=null||(B[_t]=[]),B[b.from].push(b);for(let b of $)(Rt=B[bt=b.from])!=null||(B[bt]=[]),B[b.from].push(b);for(let b=0;b<128;b+=16)for(let dt=0;dt<8;dt++){let N=b|dt,St=e.get(N);if(St===f)continue;let K=P(St),vt=T(St),R=vt===m?1:-1,st=B[N]||[];C+=R*o[K];let ye=K===y&&st.some(v=>v.markEnPassant)?st.length-1:st.length;if(C+=R*ye*r[K],l<2){let v=Math.min(1,2-l);if(tt[N]&Te&&(C+=R*v*p),K===y){if(tt[N]&Ct){let Ae=1-l;C+=R*Ae*s}let Bt=N+(vt===m?16:-16)&128,Gt=N&8;Bt>=48&&Bt<=64&&Gt>=2&&Gt<=5&&(C+=R*v*n)}else{tt[N]&Ct&&(K===A||k?C+=R*v*a:K===x&&(C+=R*v*i));for(let Q of st)tt[Q.dest]&Ct&&(C+=R*v*c)}}else{let v=Math.max(0,l-1);if(K===I){let Q=tt[N];Q&eo?C+=R*v*u:Q&Te?C+=R*v*d:Q&Ct&&(C+=R*v*M)}}}return C}var oo=[2,2,1.5,1,1,1,1,.5,0];function ro(e){let t=0,o=0;for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);i===f||P(i)===y||(T(i)===m?t++:o++)}let r=Math.min(t,o);return r>=8?0:r<=1?2:oo[r]}function Pe(e){return e==="white"?m:S}var D,et,Et,ot,rt=class{constructor(t,o){O(this,D,void 0);O(this,et,void 0);O(this,Et,new X);Y(this,D,t),Y(this,et,o)}static NewForGame(t,o){return new rt(t,Pe(o))}takeTurn(){let t=E(this,Et),o=E(this,D).toString("fen");fe(o,t);let r=E(this,D).getStatus();if(r.state!=="active"){console.warn("Game over");return}let s=Pe(r.turn);if(s!==E(this,et)){console.warn("Not my turn...");return}let n=performance.now(),a=Ee(t,s,4,c=>Se(E(rt,ot),c),c=>Me(c,E(rt,ot)));if(!a.move)throw new Error("Minimax didn't return move with score");let i=ht(a.move.from)+ht(a.move.dest)+(a.move.promote?Vt(a.move.promote):"");E(this,D).move(i)}},kt=rt;D=new WeakMap,et=new WeakMap,Et=new WeakMap,ot=new WeakMap,O(kt,ot,{Material:{[y]:100,[A]:300,[k]:300,[h]:500,[x]:900,[I]:2e4},Mobility:{[y]:5,[A]:10,[k]:10,[h]:10,[x]:10,[I]:10},PawnCenter:40,PawnCenterAttack:10,MinorCenter:20,QueenCenter:30,PieceCenterAttack:10,PieceOuterCenter:10,KingEndgameEdge:-10,KingEndgameOuterCenter:25,KingEndgameCenter:35});return so;})();
