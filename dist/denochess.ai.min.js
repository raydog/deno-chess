/*! Deno-Chess 0.3.0, (c) 2021, license: MIT */
var DenoChessAI=(()=>{var Gt=Object.defineProperty,xe=Object.defineProperties;var ke=Object.getOwnPropertyDescriptors;var Nt=Object.getOwnPropertySymbols;var Ie=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable,wt=Math.pow,Ot=(t,e,o)=>e in t?Gt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,Lt=(t,e)=>{for(var o in e||(e={}))Ie.call(e,o)&&Ot(t,o,e[o]);if(Nt)for(var o of Nt(e))_e.call(e,o)&&Ot(t,o,e[o]);return t},Yt=(t,e)=>xe(t,ke(e));var ge=(t,e)=>{for(var o in e)Gt(t,o,{get:e[o],enumerable:!0})};var Kt=(t,e,o)=>{if(!e.has(t))throw TypeError("Cannot "+o)};var d=(t,e,o)=>(Kt(t,e,"read from private field"),o?o.call(t):e.get(t)),w=(t,e,o)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,o)},F=(t,e,o,r)=>(Kt(t,e,"write to private field"),r?r.call(t,o):e.set(t,o),o);var eo={};ge(eo,{BeginnerAI:()=>kt});var f=0;function P(t){return t&7}function M(t){return t&8}function q(t){return Boolean(t&16)}function St(t){return t===f?t:t|16}function Ft(t,e){return t===f?t:t&248|e&7}var Mt=(t,e,o=!1)=>t|e|Number(o)<<4;var nt=class extends Error{};var B=class extends nt{};function U(t,e){if(!t)throw new nt(e)}var Pt=0,at=10;var Ut=20,Ht=21,Wt=22,Dt=23,Qt=24;var l=0,T=8;var y=1,A=2,I=3,h=4,x=5,k=6,be={[y]:"P",[A]:"B",[I]:"N",[h]:"R",[x]:"Q",[k]:"K"};function Vt(t){return be[t]}var qt=0,ct=8,yt=[16,1,-16,-1,17,-15,-17,15],$t=[31,33,14,18,-18,-14,-33,-31],Xt={[l]:[15,17],[T]:[-15,-17]};function it(t,e,o){let r=t.current.attacks,s=o<<4;return Boolean(r[e|s|ct]||r[e|s|qt])}function Zt(t,e,o,r){let s=t.current.attacks,a=t.current.board;switch(r){case y:for(let n of Xt[o])$(s,e+n,o,-1);break;case I:for(let n of $t)$(s,e+n,o,-1);break;case k:for(let n of yt)$(s,e+n,o,-1);break;case A:for(let n=4;n<8;n++)H(s,a,e,o,n,0);break;case h:for(let n=0;n<4;n++)H(s,a,e,o,n,0);break;case x:for(let n=0;n<8;n++)H(s,a,e,o,n,0);break}jt(t,e,1)}function zt(t,e,o,r){let s=t.current.attacks,a=t.current.board;switch(jt(t,e,0),r){case y:for(let n of Xt[o])$(s,e+n,o,1);break;case I:for(let n of $t)$(s,e+n,o,1);break;case k:for(let n of yt)$(s,e+n,o,1);break;case A:for(let n=4;n<8;n++)H(s,a,e,o,n,1);break;case h:for(let n=0;n<4;n++)H(s,a,e,o,n,1);break;case x:for(let n=0;n<8;n++)H(s,a,e,o,n,1);break}}function jt(t,e,o){let r=t.current.attacks,s=t.current.board;for(let a=0;a<=8;a+=8){let n=a<<4,c=r[e|n|ct];for(let i=0;i<8;i++)c&1<<i&&H(r,s,e,a,i,o)}}function H(t,e,o,r,s,a){let n=yt[s];for(;((o+=n)&136)==0&&(Re(t,o,r,s,a),e[o]===f););}function $(t,e,o,r){if(e&136)return;let s=o<<4;t[e|s|qt]+=r}function Re(t,e,o,r,s){let a=o<<4;s?t[e|a|ct]|=1<<r:t[e|a|ct]&=~(1<<r)}var Jt=8*8*2,O,_,X=class{constructor(){w(this,O,0);w(this,_,[te()]);this.current=d(this,_)[0]}reset(){F(this,O,0);let e=this.current=d(this,_)[0];e.board.fill(f),e.attacks.fill(0),e.clock=0,e.moveNum=0,e.ep=136,e.status=Pt,e.turn=l,e.seen={},e.castles=0,e.moveCache[l]=null,e.moveCache[T]=null}set(e,o){U((e&136)==0,"Invalid set() coord");let r=this.current.board[e];if(r!==f){let s=M(r),a=P(r);Zt(this,e,s,a)}if(this.current.board[e]=o,o!==f){let s=M(o),a=P(o);zt(this,e,s,a)}}get(e){return U((e&136)==0,"Invalid get() coord"),this.current.board[e]}putBoardHash(e){for(let o=d(this,O);o>=0;o--)if(e in d(this,_)[o].seen){let r=1+d(this,_)[o].seen[e];return this.current.seen[e]=r,r}return this.current.seen[e]=1,1}save(){let e=F(this,O,+d(this,O)+1);e===d(this,_).length&&d(this,_).push(te()),this.current=d(this,_)[e],Be(d(this,_)[e-1],this.current)}restore(){if(d(this,O)>0){let e=F(this,O,+d(this,O)-1);this.current=d(this,_)[e]}}};O=new WeakMap,_=new WeakMap;function te(){return{board:new Uint8Array(Jt).fill(f),attacks:new Uint8Array(Jt*2).fill(0),clock:0,moveNum:1,ep:136,status:Pt,turn:l,seen:{},castles:0,moveCache:{[l]:null,[T]:null}}}function Be(t,e){e.board.set(t.board),e.attacks.set(t.attacks),e.clock=t.clock,e.moveNum=t.moveNum,e.ep=t.ep,e.status=t.status,e.turn=t.turn,e.seen={},e.castles=t.castles,e.moveCache[l]=t.moveCache[l],e.moveCache[T]=t.moveCache[T]}var ve=/^[a-h][1-8]$/i,Ge="abcdefgh",Ne="12345678",we=t=>[t&7,t>>>4],Oe=(t,e)=>(e&7)<<4|t&7,ee=t=>{U(ve.test(t),"Invalid coord");let e=t.toLowerCase(),o=e.charCodeAt(0)-97,r=e.charCodeAt(1)-49;return Oe(o,r)},At=t=>{let[e,o]=we(t);return Ge[e]+Ne[o]};function oe(t,e,o,r){return e&15|(t&15)<<4|(r&15)<<8|(o&15)<<12}function re(t,e){return e===l?t&65280|136:t&255|34816}function ht(t,e){let o=e<64?0:8,r=o+4,s=e&15;if((t>>>o&15)===s){let a=t&~(15<<o),n=8<<o;return a|n}if((t>>>r&15)===s){let a=t&~(15<<r),n=8<<r;return a|n}return t}function L(t,e,o){let r=e+(o?0:4);return t>>>r&15}function se(t){let e=0,o=Array(8).fill(0),r=0;for(let n=0;n<128;n+=16)for(let c=0;c<8;c++){let i=n|c,m=t.get(i);if(m===f)continue;let p=P(m);if(p===y||p===h||p===x)return!1;e++,p===A&&(r+=(i>>>4^i)&1),o[p]++}if(e===2)return!0;let s=o[A],a=o[I];return e===3&&(s===1||a===1)||e===s+2&&(r===0||r===s)}var Le=" PBNRQK  pbnrqk";function ne(t){let e="",o=0;for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,c=t.get(n);if(c===f){o++;continue}o&&(e+=o,o=0);let i=c&15;e+=Le[i]}o&&(e+=o),e+=";";let r=t.current.castles;return e+=Z(L(r,l,!0)),e+=Z(L(r,l,!1)),e+=Z(L(r,T,!0)),e+=Z(L(r,T,!1)),e+=";"+Z((t.current.ep||136)&15),e}function Z(t){return t&8?"-":String(t)}function z(t,e){let o=8-e;for(let r=0;r<128;r+=16)for(let s=0;s<8;s++){let a=r|s,n=t.get(a);if(!(n===f||P(n)!==k||M(n)!==e)&&it(t,a,o))return!0}return!1}function ae(t,e,o){return Y(t,e,o,0,0,0,0,0,0,0)}function ce(t,e,o,r,s){return Y(t,e,o,r,s,0,0,0,0,0)}function xt(t,e,o,r,s,a){return Y(t,e,o,0,0,r,s,a,0,0)}function Y(t,e,o,r,s,a,n,c,i,m){return{what:t,from:e,dest:o,capture:r,captureCoord:s,castleRook:a,castleRookFrom:n,castleRookDest:c,promote:i,markEnPassant:m}}function ie(t,e){return Yt(Lt({},t),{promote:e})}function j(t,e){let o=t.current;o.ep=136;let r=St(e.what),s=M(r),a=P(r);a===k&&(o.castles=re(o.castles,s)),a===h&&!q(e.what)&&(o.castles=ht(o.castles,e.from)),e.markEnPassant&&(o.ep=e.markEnPassant),e.promote&&(r=Ft(r,e.promote)),t.set(e.dest,r),t.set(e.from,f),e.capture&&e.captureCoord!==e.dest&&t.set(e.captureCoord,f),e.castleRook&&(t.set(e.castleRookDest,St(e.castleRook)),t.set(e.castleRookFrom,f)),M(r)&&o.moveNum++,e.capture||P(r)===y?o.clock=0:o.clock++,e.capture&&P(e.capture)===h&&!q(e.capture)&&(o.castles=ht(o.castles,e.captureCoord)),o.moveCache[l]=null,o.moveCache[T]=null,o.turn=8-o.turn}var pt=[16,1,-16,-1,17,-15,-17,15],Ye=[31,33,14,18,-18,-14,-33,-31],Ke=[-1,1],Fe=[x,h,I,A];function W(t,e){let o=t.current.moveCache[e];if(o)return[...o];let r=[];for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,c=t.get(n);c!==f&&M(c)===e&&Ue(t,n,r)}return t.current.moveCache[e]=r,r}function Ue(t,e,o=[]){let r=t.get(e);switch(U(r!==f,"Listing moves of empty space"),t.save(),t.set(e,f),P(r)){case A:J(t,r,e,pt,4,8,8,o);break;case h:J(t,r,e,pt,0,4,8,o);break;case x:J(t,r,e,pt,0,8,8,o);break;case I:J(t,r,e,Ye,0,8,1,o);break;case k:J(t,r,e,pt,0,8,1,o),He(t,r,e,o);break;case y:We(t,r,e,o);break}return t.restore(),o}function J(t,e,o,r,s,a,n,c){let i=M(e),m=8-i;for(let p=s;p<a;p++){let S=r[p];for(let C=o+S,E=0;(C&136)==0&&E<n;C+=S,E++){let u=t.get(C);if(u===f){D(t,c,ae(e,o,C));continue}M(u)===m&&D(t,c,ce(e,o,C,u,C));break}}}function He(t,e,o,r){if(q(e))return;let s=M(e),a=t.current.castles,n=L(a,s,!0),c=L(a,s,!1),i=o&240;if((n&8)==0){let m=i|6,p=i|n,S=i|5;pe(t,r,xt(e,o,m,t.get(p),p,S))}if((c&8)==0){let m=i|2,p=i|c,S=i|3;pe(t,r,xt(e,o,m,t.get(p),p,S))}}function We(t,e,o,r){let s=M(e),a=8-s,n=s===l?1:-1,c=o+16*n,i=o+32*n;if(c&136)return r;let m=i&136?x:0;t.get(c)===f&&(D(t,r,Y(e,o,c,0,0,0,0,0,m,0)),!q(e)&&(i&136)==0&&t.get(i)===f&&D(t,r,Y(e,o,i,0,0,0,0,0,0,c)));let p=t.current.ep;for(let S of Ke){let C=c+S;if(C&136)continue;let E=t.get(C);if(C===p){let u=o+S,v=t.get(u);D(t,r,Y(e,o,C,v,u,0,0,0,m,0))}else E!==f&&M(E)===a&&D(t,r,Y(e,o,C,E,C,0,0,0,m,0))}return r}function D(t,e,o){let r=M(o.what);if(t.save(),j(t,o),!z(t,r))if(o.promote)for(let s of Fe)e.push(ie(o,s));else e.push(o);t.restore()}function pe(t,e,o){let r=M(o.what),s=Math.min(o.castleRookFrom,o.castleRookDest,o.from,o.dest),a=Math.max(o.castleRookFrom,o.castleRookDest,o.from,o.dest);for(let m=s;m<=a;m++){if(m===o.from||m===o.castleRookFrom)continue;if(t.get(m)!==f)return}t.save(),t.set(o.from,f),t.set(o.castleRookFrom,f);let n=Math.min(o.from,o.dest),c=Math.max(o.from,o.dest);for(let m=n;m<=c;m++)t.set(m,o.what);let i=z(t,r);t.restore(),!i&&D(t,e,o)}function ft(t,e){let o=8-e,r=z(t,o),s=W(t,o).length>0,a=t.putBoardHash(ne(t)),n=De(t,r,s,a);return{enemyInCheck:r,enemyCanMove:s,newGameStatus:n}}function De(t,e,o,r){let s=t.current.status;return o?t.current.clock>=100?Dt:r>=3?Wt:se(t)?Qt:s:e?at:Ht}var Qe=/[1-8]/,Ve=/[PBNRQK]/,qe=/[pbnrqk]/;function fe(t,e){e&&e.reset();let o=e||new X;t=t.trim();let r=t.split(/\s+/g);if(r.length!==6)throw new B("Bad FEN string: Wrong number of sections");let s=r[0].split("/");if(s.length!==8)throw new B("Bad FEN string: Board data should have 8 ranks");for(let c=7;c>=0;c--){let i=0,m=s[7-c];for(let p=0;p<8;p++){let S=c<<4|p;if(i>=m.length)throw new B(`Bad FEN string: Rank ${c+1} had less than 8 files`);let C=m[i++];if(Qe.test(C)){let E=parseInt(C,10);for(let u=0;u<E;u++)o.set(S+u,f);p+=E-1}else if(Ve.test(C)){let E=me(C);o.set(S,le(l,E,c))}else if(qe.test(C)){let E=me(C);o.set(S,le(T,E,c))}}if(i<m.length)throw new B(`Bad FEN string: Rank ${c+1} had more than 8 files`)}let a=$e(r[1]);o.current.turn=a,o.current.castles=Xe(r[2]),r[3]!=="-"&&(o.current.ep=ee(r[3])),o.current.clock=ue(r[4]),o.current.moveNum=ue(r[5]);let n=ft(o,8-a);return o.current.status=n.newGameStatus,o}function me(t){switch(t.toLowerCase()){case"p":return y;case"b":return A;case"n":return I;case"r":return h;case"q":return x;case"k":return k}throw new B("Bad FEN string: Unknown piece: "+t)}function $e(t){switch(t){case"w":return l;case"b":return T}throw new B("Bad FEN string: Invalid turn: "+t)}function Xe(t){if(t.length>4)throw new B("Bad FEN string: Castle eligibility list is too long");let e=136,o=136,r=136,s=136;if(t!=="-")for(let a=0;a<t.length;a++)switch(t[a]){case"K":o=7;break;case"Q":e=0;break;case"k":s=119;break;case"q":r=112;break;default:throw new B("Bad FEN string: Unknown character in castle eligibility list: "+t[a])}return oe(e,o,r,s)}function le(t,e,o){return e===y?Mt(e,t,!(o===1&&t===l||o===6&&t===T)):Mt(e,t,!1)}function ue(t){let e=parseInt(t,10);if(isNaN(e))throw new B("Bad FEN string: Bad number: "+t);return e}var mt=wt(2,32),lt=1e3;function Ce(t){if(isNaN(t)||t>lt||t<-lt||t===0)throw new Error("Out of range checkmate score: "+t);return t>0?mt+lt-t:-mt-lt-t}function Ee(t){if(isNaN(t)||t>=mt||t<=-mt)throw new Error("Out of range move score: "+t);return t}function de(t,e,o,r,s){return Te(t,e,0,o,-Infinity,Infinity,r,s)}function Te(t,e,o,r,s,a,n,c){let i=8-e,m=ft(t,i);if(m.newGameStatus===at)return{score:Ce(i===l?o+1:-o-1),nodes:1};if(m.newGameStatus>=Ut)return{score:0,nodes:1};if(o>=r)return{score:Ee(c(t)),nodes:1};let p=e===l?-Infinity:Infinity,S=[],C=n(t),E=0;for(let u of C){t.save(),j(t,u);let{score:v,nodes:Et}=Te(t,i,o+1,r,s,a,n,c);if(t.restore(),E+=Et,v===p)S.push(u);else if(e===l){if(v>p&&(p=v,S=[u]),p>=a)break;s<p&&(s=p)}else if(e===T){if(v<p&&(p=v,S=[u]),p<=s)break;a>p&&(a=v)}}return o?{score:p,nodes:E}:{score:p,move:Ze(S),nodes:E}}function Ze(t){return t[Math.floor(Math.random()*t.length)]}function Se(t,e){let o=e.current.turn,s=W(e,o).map(a=>({move:a,score:ze(t,e,a,o)}));return s.sort((a,n)=>n.score-a.score),s.map(({move:a})=>a)}function ze({Material:t},e,o,r){let s=0;o.capture&&(s+=1e3+t[P(o.capture)]-t[P(o.what)]),o.promote&&(s+=t[o.promote]);let a=8-r;return it(e,o.dest,a)&&(s-=t[P(o.what)]),s}var tt=[4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,4,0,2,2,2,2,0,4,0,0,0,0,0,0,0,0,4,0,2,1,1,2,0,4,0,0,0,0,0,0,0,0,4,0,2,1,1,2,0,4,0,0,0,0,0,0,0,0,4,0,2,2,2,2,0,4,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0],ut=1,Me=2,je=4;function Pe(t,{PhaseOverride:e,Material:o,Mobility:r,PawnCenter:s,PawnCenterAttack:a,MinorCenter:n,QueenCenter:c,PieceCenterAttack:i,PieceOuterCenter:m,KingEndgameEdge:p,KingEndgameOuterCenter:S,KingEndgameCenter:C}){var It,_t,gt,bt;let E=e!=null?e:to(t),u=0,v=W(t,l),Et=W(t,T),G={};for(let g of v)(_t=G[It=g.from])!=null||(G[It]=[]),G[g.from].push(g);for(let g of Et)(bt=G[gt=g.from])!=null||(G[gt]=[]),G[g.from].push(g);for(let g=0;g<128;g+=16)for(let dt=0;dt<8;dt++){let N=g|dt,Tt=t.get(N);if(Tt===f)continue;let K=P(Tt),Rt=M(Tt),b=Rt===l?1:-1,st=G[N]||[];u+=b*o[K];let Ae=K===y&&st.some(R=>R.markEnPassant)?st.length-1:st.length;if(u+=b*Ae*r[K],E<2){let R=Math.min(1,2-E);if(tt[N]&Me&&(u+=b*R*m),K===y){if(tt[N]&ut){let he=1-E;u+=b*he*s}let Bt=N+(Rt===l?16:-16)&128,vt=N&8;Bt>=48&&Bt<=64&&vt>=2&&vt<=5&&(u+=b*R*a)}else{tt[N]&ut&&(K===A||I?u+=b*R*n:K===x&&(u+=b*R*c));for(let V of st)tt[V.dest]&ut&&(u+=b*R*i)}}else{let R=Math.max(0,E-1);if(K===k){let V=tt[N];V&je?u+=b*R*p:V&Me?u+=b*R*S:V&ut&&(u+=b*R*C)}}}return u}var Je=[2,2,1.5,1,1,1,1,.5,0];function to(t){let e=0,o=0;for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,c=t.get(n);c===f||P(c)===y||(M(c)===l?e++:o++)}let r=Math.min(e,o);return r>=8?0:r<=1?2:Je[r]}function ye(t){return t==="white"?l:T}var Q,et,Ct,ot,rt=class{constructor(e,o){w(this,Q,void 0);w(this,et,void 0);w(this,Ct,new X);F(this,Q,e),F(this,et,o)}static NewForGame(e,o){return new rt(e,ye(o))}takeTurn(){let e=d(this,Ct),o=d(this,Q).toString("fen");fe(o,e);let r=d(this,Q).getStatus();if(r.state!=="active"){console.warn("Game over");return}let s=ye(r.turn);if(s!==d(this,et)){console.warn("Not my turn...");return}let a=performance.now(),n=de(e,s,4,i=>Se(d(rt,ot),i),i=>Pe(i,d(rt,ot)));if(!n.move)throw new Error("Minimax didn't return move with score");let c=At(n.move.from)+At(n.move.dest)+(n.move.promote?Vt(n.move.promote):"");d(this,Q).move(c)}},kt=rt;Q=new WeakMap,et=new WeakMap,Ct=new WeakMap,ot=new WeakMap,w(kt,ot,{Material:{[y]:100,[A]:300,[I]:300,[h]:500,[x]:900,[k]:2e4},Mobility:{[y]:5,[A]:10,[I]:10,[h]:10,[x]:10,[k]:10},PawnCenter:40,PawnCenterAttack:10,MinorCenter:20,QueenCenter:30,PieceCenterAttack:10,PieceOuterCenter:10,KingEndgameEdge:-10,KingEndgameOuterCenter:25,KingEndgameCenter:35});return eo;})();
