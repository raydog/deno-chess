/*! Deno-Chess 0.4.0, (c) 2021, license: MIT */
var DenoChessAI=(()=>{var Tt=Object.defineProperty,xe=Object.defineProperties;var ke=Object.getOwnPropertyDescriptors;var Nt=Object.getOwnPropertySymbols;var _e=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable,Ot=Math.pow,wt=(e,t,o)=>t in e?Tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Lt=(e,t)=>{for(var o in t||(t={}))_e.call(t,o)&&wt(e,o,t[o]);if(Nt)for(var o of Nt(t))Ie.call(t,o)&&wt(e,o,t[o]);return e},Kt=(e,t)=>xe(e,ke(t)),he=e=>Tt(e,"__esModule",{value:!0});var be=(e,t)=>{he(e);for(var o in t)Tt(e,o,{get:t[o],enumerable:!0})};var Yt=(e,t,o)=>{if(!t.has(e))throw TypeError("Cannot "+o)};var E=(e,t,o)=>(Yt(e,t,"read from private field"),o?o.call(e):t.get(e)),O=(e,t,o)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,o)},Y=(e,t,o,r)=>(Yt(e,t,"write to private field"),r?r.call(e,o):t.set(e,o),o);var so={};be(so,{BeginnerAI:()=>It});var m=0;function M(e){return e&7}function T(e){return e&8}function V(e){return Boolean(e&16)}function Pt(e){return e===m?e:e|16}function Ut(e,t){return e===m?e:e&248|t&7}var Mt=(e,t,o=!1)=>e|t|Number(o)<<4;var nt=class extends Error{};var at=class extends nt{};function U(e,t){if(!e)throw new nt(t)}var yt=0,ct=10;var Ft=20,Ht=21,Wt=22,Dt=23,Qt=24;var u=0,S=8;var y=1,A=2,I=3,x=4,k=5,_=6,ge={[y]:"P",[A]:"B",[I]:"N",[x]:"R",[k]:"Q",[_]:"K"};function Vt(e){return ge[e]}var qt=0,it=8,At=[16,1,-16,-1,17,-15,-17,15],$t=[31,33,14,18,-18,-14,-33,-31],Xt={[u]:[15,17],[S]:[-15,-17]};function pt(e,t,o){let r=e.current.attacks,s=o<<4;return Boolean(r[t|s|it]||r[t|s|qt])}function Zt(e,t,o,r){let s=e.current.attacks,a=e.current.board;switch(r){case y:for(let n of Xt[o])q(s,t+n,o,-1);break;case I:for(let n of $t)q(s,t+n,o,-1);break;case _:for(let n of At)q(s,t+n,o,-1);break;case A:for(let n=4;n<8;n++)F(s,a,t,o,n,0);break;case x:for(let n=0;n<4;n++)F(s,a,t,o,n,0);break;case k:for(let n=0;n<8;n++)F(s,a,t,o,n,0);break}jt(e,t,1)}function zt(e,t,o,r){let s=e.current.attacks,a=e.current.board;switch(jt(e,t,0),r){case y:for(let n of Xt[o])q(s,t+n,o,1);break;case I:for(let n of $t)q(s,t+n,o,1);break;case _:for(let n of At)q(s,t+n,o,1);break;case A:for(let n=4;n<8;n++)F(s,a,t,o,n,1);break;case x:for(let n=0;n<4;n++)F(s,a,t,o,n,1);break;case k:for(let n=0;n<8;n++)F(s,a,t,o,n,1);break}}function jt(e,t,o){let r=e.current.attacks,s=e.current.board;for(let a=0;a<=8;a+=8){let n=a<<4,c=r[t|n|it];for(let i=0;i<8;i++)c&1<<i&&F(r,s,t,a,i,o)}}function F(e,t,o,r,s,a){let n=At[s];for(;((o+=n)&136)==0&&(Re(e,o,r,s,a),t[o]===m););}function q(e,t,o,r){if(t&136)return;let s=o<<4;e[t|s|qt]+=r}function Re(e,t,o,r,s){let a=o<<4;s?e[t|a|it]|=1<<r:e[t|a|it]&=~(1<<r)}var Jt=8*8*2,G,b,X=class{constructor(){O(this,G,0);O(this,b,[te()]);this.current=E(this,b)[0]}reset(){Y(this,G,0);let t=this.current=E(this,b)[0];t.board.fill(m),t.attacks.fill(0),t.clock=0,t.moveNum=0,t.ep=136,t.status=yt,t.turn=u,t.seen={},t.castles=0,t.moveCache[u]=null,t.moveCache[S]=null}set(t,o){U((t&136)==0,"Invalid set() coord");let r=this.current.board[t];if(r!==m){let s=T(r),a=M(r);Zt(this,t,s,a)}if(this.current.board[t]=o,o!==m){let s=T(o),a=M(o);zt(this,t,s,a)}}get(t){return U((t&136)==0,"Invalid get() coord"),this.current.board[t]}putBoardHash(t){for(let o=E(this,G);o>=0;o--)if(t in E(this,b)[o].seen){let r=1+E(this,b)[o].seen[t];return this.current.seen[t]=r,r}return this.current.seen[t]=1,1}removeBoardHash(t){for(let o=E(this,G);o>=0;o--)if(t in E(this,b)[o].seen){this.current.seen[t]--;return}}save(){let t=Y(this,G,+E(this,G)+1);t===E(this,b).length&&E(this,b).push(te()),this.current=E(this,b)[t],ve(E(this,b)[t-1],this.current)}restore(){if(E(this,G)>0){let t=Y(this,G,+E(this,G)-1);this.current=E(this,b)[t]}}getPriorState(){let t=this.current;return{clock:t.clock,moveNum:t.moveNum,ep:t.ep,status:t.status,castles:t.castles}}};G=new WeakMap,b=new WeakMap;function te(){return{board:new Uint8Array(Jt).fill(m),attacks:new Uint8Array(Jt*2).fill(0),clock:0,moveNum:1,ep:136,status:yt,turn:u,seen:{},castles:0,moveCache:{[u]:null,[S]:null}}}function ve(e,t){t.board.set(e.board),t.attacks.set(e.attacks),t.clock=e.clock,t.moveNum=e.moveNum,t.ep=e.ep,t.status=e.status,t.turn=e.turn,t.seen={},t.castles=e.castles,t.moveCache[u]=e.moveCache[u],t.moveCache[S]=e.moveCache[S]}var Be=/^[a-h][1-8]$/i,Ge="abcdefgh",Ne="12345678",Oe=e=>[e&7,e>>>4],we=(e,t)=>(t&7)<<4|e&7,ee=e=>{U(Be.test(e),"Invalid coord");let t=e.toLowerCase(),o=t.charCodeAt(0)-97,r=t.charCodeAt(1)-49;return we(o,r)},xt=e=>{let[t,o]=Oe(e);return Ge[t]+Ne[o]};function oe(e,t,o,r){return t&15|(e&15)<<4|(r&15)<<8|(o&15)<<12}function re(e,t){return t===u?e&65280|136:e&255|34816}function kt(e,t){let o=t<64?0:8,r=o+4,s=t&15;if((e>>>o&15)===s){let a=e&~(15<<o),n=8<<o;return a|n}if((e>>>r&15)===s){let a=e&~(15<<r),n=8<<r;return a|n}return e}function w(e,t,o){let r=t+(o?0:4);return e>>>r&15}function se(e){let t=0,o=Array(8).fill(0),r=0;for(let n=0;n<128;n+=16)for(let c=0;c<8;c++){let i=n|c,f=e.get(i);if(f===m)continue;let p=M(f);if(p===y||p===x||p===k)return!1;t++,p===A&&(r+=(i>>>4^i)&1),o[p]++}if(t===2)return!0;let s=o[A],a=o[I];return t===3&&(s===1||a===1)||t===s+2&&(r===0||r===s)}var Le=" PBNRQK  pbnrqk";function ne(e){let t="",o=0;for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,c=e.get(n);if(c===m){o++;continue}o&&(t+=o,o=0);let i=c&15;t+=Le[i]}o&&(t+=o),t+=";";let r=e.current.castles;return t+=Z(w(r,u,!0)),t+=Z(w(r,u,!1)),t+=Z(w(r,S,!0)),t+=Z(w(r,S,!1)),t+=";"+Z((e.current.ep||136)&15),t}function Z(e){return e&8?"-":String(e)}function z(e,t){let o=8-t;for(let r=0;r<128;r+=16)for(let s=0;s<8;s++){let a=r|s,n=e.get(a);if(!(n===m||M(n)!==_||T(n)!==t)&&pt(e,a,o))return!0}return!1}function ae(e,t,o,r){return L(e,t,o,0,0,0,0,0,0,0,r)}function ce(e,t,o,r,s,a){return L(e,t,o,r,s,0,0,0,0,0,a)}function _t(e,t,o,r,s,a,n){return L(e,t,o,0,0,r,s,a,0,0,n)}function L(e,t,o,r,s,a,n,c,i,f,p){return{what:e,from:t,dest:o,capture:r,captureCoord:s,castleRook:a,castleRookFrom:n,castleRookDest:c,promote:i,markEnPassant:f,prior:p}}function ie(e,t){return Kt(Lt({},e),{promote:t})}function j(e,t){let o=e.current;o.ep=136;let r=Pt(t.what),s=T(r),a=M(r);a===_&&(o.castles=re(o.castles,s)),a===x&&!V(t.what)&&(o.castles=kt(o.castles,t.from)),t.markEnPassant&&(o.ep=t.markEnPassant),t.promote&&(r=Ut(r,t.promote)),e.set(t.dest,r),e.set(t.from,m),t.capture&&t.captureCoord!==t.dest&&e.set(t.captureCoord,m),t.castleRook&&(e.set(t.castleRookDest,Pt(t.castleRook)),e.set(t.castleRookFrom,m)),T(r)&&o.moveNum++,t.capture||M(t.what)===y?o.clock=0:o.clock++,t.capture&&M(t.capture)===x&&!V(t.capture)&&(o.castles=kt(o.castles,t.captureCoord)),o.moveCache[u]=null,o.moveCache[S]=null,o.turn=8-o.turn}var ft=[16,1,-16,-1,17,-15,-17,15],Ke=[31,33,14,18,-18,-14,-33,-31],Ye=[-1,1],Ue=[k,x,I,A];function H(e,t){let o=e.current.moveCache[t];if(o)return[...o];let r=[];for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,c=e.get(n);c!==m&&T(c)===t&&Fe(e,n,r)}return e.current.moveCache[t]=r,r}function Fe(e,t,o=[]){let r=e.get(t),s=e.getPriorState();switch(U(r!==m,"Listing moves of empty space"),e.save(),e.set(t,m),M(r)){case A:J(e,r,t,ft,4,8,8,o,s);break;case x:J(e,r,t,ft,0,4,8,o,s);break;case k:J(e,r,t,ft,0,8,8,o,s);break;case I:J(e,r,t,Ke,0,8,1,o,s);break;case _:J(e,r,t,ft,0,8,1,o,s),He(e,r,t,o,s);break;case y:We(e,r,t,o,s);break}return e.restore(),o}function J(e,t,o,r,s,a,n,c,i){let f=T(t),p=8-f;for(let d=s;d<a;d++){let P=r[d];for(let l=o+P,C=0;(l&136)==0&&C<n;l+=P,C++){let h=e.get(l);if(h===m){W(e,c,ae(t,o,l,i));continue}T(h)===p&&W(e,c,ce(t,o,l,h,l,i));break}}}function He(e,t,o,r,s){if(V(t))return;let a=T(t),n=e.current.castles,c=w(n,a,!0),i=w(n,a,!1),f=o&240;if((c&8)==0){let p=f|6,d=f|c,P=f|5;pe(e,r,_t(t,o,p,e.get(d),d,P,s))}if((i&8)==0){let p=f|2,d=f|i,P=f|3;pe(e,r,_t(t,o,p,e.get(d),d,P,s))}}function We(e,t,o,r,s){let a=T(t),n=8-a,c=a===u?1:-1,i=o+16*c,f=o+32*c;if(i&136)return r;let p=f&136?k:0;e.get(i)===m&&(W(e,r,L(t,o,i,0,0,0,0,0,p,0,s)),!V(t)&&(f&136)==0&&e.get(f)===m&&W(e,r,L(t,o,f,0,0,0,0,0,0,i,s)));let d=e.current.ep;for(let P of Ye){let l=i+P;if(l&136)continue;let C=e.get(l);if(l===d){let h=o+P,$=e.get(h);W(e,r,L(t,o,l,$,h,0,0,0,p,0,s))}else C!==m&&T(C)===n&&W(e,r,L(t,o,l,C,l,0,0,0,p,0,s))}return r}function W(e,t,o){let r=T(o.what);if(e.save(),j(e,o),!z(e,r))if(o.promote)for(let s of Ue)t.push(ie(o,s));else t.push(o);e.restore()}function pe(e,t,o){let r=T(o.what),s=Math.min(o.castleRookFrom,o.castleRookDest,o.from,o.dest),a=Math.max(o.castleRookFrom,o.castleRookDest,o.from,o.dest);for(let f=s;f<=a;f++){if(f===o.from||f===o.castleRookFrom)continue;if(e.get(f)!==m)return}e.save(),e.set(o.from,m),e.set(o.castleRookFrom,m);let n=Math.min(o.from,o.dest),c=Math.max(o.from,o.dest);for(let f=n;f<=c;f++)e.set(f,o.what);let i=z(e,r);e.restore(),!i&&W(e,t,o)}function mt(e,t){let o=8-t,r=z(e,o),s=H(e,o).length>0,a=e.putBoardHash(ne(e)),n=De(e,r,s,a);return{enemyInCheck:r,enemyCanMove:s,newGameStatus:n}}function De(e,t,o,r){let s=e.current.status;return o?e.current.clock>=100?Dt:r>=3?Wt:se(e)?Qt:s:t?ct:Ht}var Qe=/[1-8]/,Ve=/[PBNRQK]/,qe=/[pbnrqk]/,$e=/^((?:[pbnrqkPBNRQK1-8]{1,8}\/){7}[pbnrqkPBNRQK1-8]{1,8})\s+([wb])\s+(K?Q?k?q?|-)\s+([a-h][36]|-)\s+(\d+)\s+(\d+)$/;function fe(e,t){t&&t.reset();let o=t||new X;e=e.trim();let r=e.match($e);if(!r)throw new at("Bad FEN string");let s=r[1].split("/");for(let c=7;c>=0;c--){let i=0,f=s[7-c];for(let p=0;p<8;p++){let d=c<<4|p;if(i>=f.length)throw new at(`Bad FEN string: Rank ${c+1} had less than 8 files`);let P=f[i++];if(Qe.test(P)){let l=parseInt(P,10);for(let C=0;C<l;C++)o.set(d+C,m);p+=l-1}else if(Ve.test(P)){let l=me(P);o.set(d,ue(u,l,c))}else if(qe.test(P)){let l=me(P);o.set(d,ue(S,l,c))}}}let a=ze(r[2]);o.current.turn=a,o.current.castles=je(r[3]),r[4]!=="-"&&(o.current.ep=ee(r[4])),o.current.clock=parseInt(r[5],10),o.current.moveNum=parseInt(r[6],10);let n=mt(o,8-a);return o.current.status=n.newGameStatus,o}var Xe={p:y,b:A,n:I,r:x,q:k,k:_};function me(e){return Xe[e.toLowerCase()]}var Ze={w:u,b:S};function ze(e){return Ze[e]}function je(e){let t=136,o=136,r=136,s=136;if(e!=="-")for(let a=0;a<e.length;a++)switch(e[a]){case"K":o=7;break;case"Q":t=0;break;case"k":s=119;break;case"q":r=112;break}return oe(t,o,r,s)}function ue(e,t,o){return t===y?Mt(t,e,!(o===1&&e===u||o===6&&e===S)):Mt(t,e,!1)}var ut=Ot(2,32),lt=1e3;function le(e){if(isNaN(e)||e>lt||e<-lt||e===0)throw new Error("Out of range checkmate score: "+e);return e>0?ut+lt-e:-ut-lt-e}function Ce(e){if(isNaN(e)||e>=ut||e<=-ut)throw new Error("Out of range move score: "+e);return e}function Ee(e,t,o,r,s){return de(e,t,0,o,-Infinity,Infinity,r,s)}function de(e,t,o,r,s,a,n,c){let i=8-t,f=mt(e,i);if(f.newGameStatus===ct)return{score:le(i===u?o+1:-o-1),nodes:1};if(f.newGameStatus>=Ft)return{score:0,nodes:1};if(o>=r)return{score:Ce(c(e)),nodes:1};let p=t===u?-Infinity:Infinity,d=[],P=n(e),l=0;for(let C of P){e.save(),j(e,C);let{score:h,nodes:$}=de(e,i,o+1,r,s,a,n,c);if(e.restore(),l+=$,h===p)d.push(C);else if(t===u){if(h>p&&(p=h,d=[C]),p>=a)break;s<p&&(s=p)}else if(t===S){if(h<p&&(p=h,d=[C]),p<=s)break;a>p&&(a=h)}}return o?{score:p,nodes:l}:{score:p,move:Je(d),nodes:l}}function Je(e){return e[Math.floor(Math.random()*e.length)]}function Se(e,t){let o=t.current.turn,s=H(t,o).map(a=>({move:a,score:to(e,t,a,o)}));return s.sort((a,n)=>n.score-a.score),s.map(({move:a})=>a)}function to({Material:e},t,o,r){let s=0;o.capture&&(s+=1e3+e[M(o.capture)]-e[M(o.what)]),o.promote&&(s+=e[o.promote]);let a=8-r;return pt(t,o.dest,a)&&(s-=e[M(o.what)]),s}var tt=[4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,4,0,2,2,2,2,0,4,0,0,0,0,0,0,0,0,4,0,2,1,1,2,0,4,0,0,0,0,0,0,0,0,4,0,2,1,1,2,0,4,0,0,0,0,0,0,0,0,4,0,2,2,2,2,0,4,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0],Ct=1,Te=2,eo=4;function Pe(e,{PhaseOverride:t,Material:o,Mobility:r,PawnCenter:s,PawnCenterAttack:a,MinorCenter:n,QueenCenter:c,PieceCenterAttack:i,PieceOuterCenter:f,KingEndgameEdge:p,KingEndgameOuterCenter:d,KingEndgameCenter:P}){var ht,bt,gt,Rt;let l=t!=null?t:ro(e),C=0,h=H(e,u),$=H(e,S),B={};for(let g of h)(bt=B[ht=g.from])!=null||(B[ht]=[]),B[g.from].push(g);for(let g of $)(Rt=B[gt=g.from])!=null||(B[gt]=[]),B[g.from].push(g);for(let g=0;g<128;g+=16)for(let dt=0;dt<8;dt++){let N=g|dt,St=e.get(N);if(St===m)continue;let K=M(St),vt=T(St),R=vt===u?1:-1,st=B[N]||[];C+=R*o[K];let ye=K===y&&st.some(v=>v.markEnPassant)?st.length-1:st.length;if(C+=R*ye*r[K],l<2){let v=Math.min(1,2-l);if(tt[N]&Te&&(C+=R*v*f),K===y){if(tt[N]&Ct){let Ae=1-l;C+=R*Ae*s}let Bt=N+(vt===u?16:-16)&128,Gt=N&8;Bt>=48&&Bt<=64&&Gt>=2&&Gt<=5&&(C+=R*v*a)}else{tt[N]&Ct&&(K===A||I?C+=R*v*n:K===k&&(C+=R*v*c));for(let Q of st)tt[Q.dest]&Ct&&(C+=R*v*i)}}else{let v=Math.max(0,l-1);if(K===_){let Q=tt[N];Q&eo?C+=R*v*p:Q&Te?C+=R*v*d:Q&Ct&&(C+=R*v*P)}}}return C}var oo=[2,2,1.5,1,1,1,1,.5,0];function ro(e){let t=0,o=0;for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,c=e.get(n);c===m||M(c)===y||(T(c)===u?t++:o++)}let r=Math.min(t,o);return r>=8?0:r<=1?2:oo[r]}function Me(e){return e==="white"?u:S}var D,et,Et,ot,rt=class{constructor(t,o){O(this,D,void 0);O(this,et,void 0);O(this,Et,new X);Y(this,D,t),Y(this,et,o)}static NewForGame(t,o){return new rt(t,Me(o))}takeTurn(){let t=E(this,Et),o=E(this,D).toString("fen");fe(o,t);let r=E(this,D).getStatus();if(r.state!=="active"){console.warn("Game over");return}let s=Me(r.turn);if(s!==E(this,et)){console.warn("Not my turn...");return}let a=performance.now(),n=Ee(t,s,4,i=>Se(E(rt,ot),i),i=>Pe(i,E(rt,ot)));if(!n.move)throw new Error("Minimax didn't return move with score");let c=xt(n.move.from)+xt(n.move.dest)+(n.move.promote?Vt(n.move.promote):"");E(this,D).move(c)}},It=rt;D=new WeakMap,et=new WeakMap,Et=new WeakMap,ot=new WeakMap,O(It,ot,{Material:{[y]:100,[A]:300,[I]:300,[x]:500,[k]:900,[_]:2e4},Mobility:{[y]:5,[A]:10,[I]:10,[x]:10,[k]:10,[_]:10},PawnCenter:40,PawnCenterAttack:10,MinorCenter:20,QueenCenter:30,PieceCenterAttack:10,PieceOuterCenter:10,KingEndgameEdge:-10,KingEndgameOuterCenter:25,KingEndgameCenter:35});return so;})();
