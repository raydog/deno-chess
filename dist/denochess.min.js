/*! Deno-Chess 0.3.0, (c) 2021, license: MIT */
var DenoChess=(()=>{var Ot=Object.defineProperty,Me=Object.defineProperties;var Ae=Object.getOwnPropertyDescriptors;var Yt=Object.getOwnPropertySymbols;var we=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var Lt=(e,t,r)=>t in e?Ot(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,J=(e,t)=>{for(var r in t||(t={}))we.call(t,r)&&Lt(e,r,t[r]);if(Yt)for(var r of Yt(t))_e.call(t,r)&&Lt(e,r,t[r]);return e},Ft=(e,t)=>Me(e,Ae(t));var Kt=(e,t)=>{for(var r in t)Ot(e,r,{get:t[r],enumerable:!0})};var Ut=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var p=(e,t,r)=>(Ut(e,t,"read from private field"),r?r.call(e):t.get(e)),b=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},N=(e,t,r,o)=>(Ut(e,t,"write to private field"),o?o.call(e,r):t.set(e,r),r);var Mr={};Kt(Mr,{ChessGame:()=>Pe,errors:()=>Et});var f=0,T=8;var Et={};Kt(Et,{ChessBadInput:()=>H,ChessBadMove:()=>R,ChessError:()=>O,ChessGameOver:()=>X,ChessNeedsPromotion:()=>dt,ChessParseError:()=>m});var O=class extends Error{},X=class extends O{constructor(){super("Game is over")}},H=class extends O{constructor(t){super(`Unexpected input: ${t}`)}},R=class extends O{constructor(t){super("Bad move: "+t)}},dt=class extends O{constructor(){super("Promotion piece is required for this move")}},m=class extends O{};function V(e,t){if(!e)throw new O(t)}var Ie=/^[a-h][1-8]$/i,ke="abcdefgh",ve="12345678",st=e=>[e&7,e>>>4],kt=(e,t)=>(t&7)<<4|e&7,Y=e=>{V(Ie.test(e),"Invalid coord");let t=e.toLowerCase(),r=t.charCodeAt(0)-97,o=t.charCodeAt(1)-49;return kt(r,o)},k=e=>{let[t,r]=st(e);return ke[t]+ve[r]};var Ne=(e,t)=>e|t,xe=["","P","B","N","R","Q","K","","","p","b","n","r","q","k"];var l=0;function y(e){return e&7}function C(e){return e&8}function tt(e){return Boolean(e&16)}function vt(e){return e===l?e:e|16}function Dt(e,t){return e===l?e:e&248|t&7}var nt=(e,t,r=!1)=>e|t|Number(r)<<4;function Ct(e){if(e===l)return" ";let t=Ne(C(e),y(e));return xe[t]}var Wt=`   +------------------------+  
`,$t="     a  b  c  d  e  f  g  h    ",Ge={dim:e=>`[2m${e}[22m`,black:e=>`[30;2m${e}[39;22m`,darkBg:e=>`[44m${e}[49m`,lightBg:e=>`[46m${e}[49m`},Re={dim:e=>e,black:e=>e,darkBg:e=>e,lightBg:e=>e};function Nt(e,t){let r=t?Ge:Re,o=r.dim($t)+`
`+Wt;for(let s=7;s>=0;s--){let n=` ${r.dim(String(s+1))} |`;for(let a=0;a<8;a++){let i=kt(a,s),c=e.get(i);n+=Be(r,i,c)}o+=n+`| ${r.dim(String(s+1))}
`}return o+Wt+r.dim($t)}function Be(e,t,r){let o;if(r===l)o=e.dim("   ");else{let s=" "+Ct(r)+" ";o=C(r)===f?s:e.black(s)}return((t>>>4^t)&1)==0?e.darkBg(o):e.lightBg(o)}function ht(e,t,r,o){return t&15|(e&15)<<4|(o&15)<<8|(r&15)<<12}function Ht(e,t){return t===f?e&65280|136:e&255|34816}function xt(e,t){let r=t<64?0:8,o=r+4,s=t&15;if((e>>>r&15)===s){let n=e&~(15<<r),a=8<<r;return n|a}if((e>>>o&15)===s){let n=e&~(15<<o),a=8<<o;return n|a}return e}function v(e,t,r){let o=t+(r?0:4);return e>>>o&15}function Vt(e){let t="";for(let s=112;s>=0;s-=16){let n=0;for(let a=0;a<8;a++){let i=s|a,c=e.get(i);if(c===l){n++;continue}n&&(t+=n,n=0),t+=Ct(c)}n&&(t+=n),s&&(t+="/")}t+=e.current.turn===f?" w":" b";let r=e.current.castles;t+=" "+be(r);let o=e.current.ep;return t+=o&136?" -":" "+k(o),t+=" "+e.current.clock,t+=" "+e.current.moveNum,t}function be(e){let t="";return t+=v(e,f,!0)&8?"":"K",t+=v(e,f,!1)&8?"":"Q",t+=v(e,T,!0)&8?"":"k",t+=v(e,T,!1)&8?"":"q",t||"-"}var Q=0,at=10,it=11,F=20,et=21,Tt=22,yt=23,St=24;var M=1,S=2,P=3,h=4,g=5,w=6,Oe={[M]:"P",[S]:"B",[P]:"N",[h]:"R",[g]:"Q",[w]:"K"};function Qt(e){return Oe[e]}var qt=0,Pt=8,Gt=[16,1,-16,-1,17,-15,-17,15],jt=[31,33,14,18,-18,-14,-33,-31],zt={[f]:[15,17],[T]:[-15,-17]};function Zt(e,t,r){let o=e.current.attacks,s=r<<4;return Boolean(o[t|s|Pt]||o[t|s|qt])}function Jt(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(o){case M:for(let a of zt[r])rt(s,t+a,r,-1);break;case P:for(let a of jt)rt(s,t+a,r,-1);break;case w:for(let a of Gt)rt(s,t+a,r,-1);break;case S:for(let a=4;a<8;a++)q(s,n,t,r,a,0);break;case h:for(let a=0;a<4;a++)q(s,n,t,r,a,0);break;case g:for(let a=0;a<8;a++)q(s,n,t,r,a,0);break}te(e,t,1)}function Xt(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(te(e,t,0),o){case M:for(let a of zt[r])rt(s,t+a,r,1);break;case P:for(let a of jt)rt(s,t+a,r,1);break;case w:for(let a of Gt)rt(s,t+a,r,1);break;case S:for(let a=4;a<8;a++)q(s,n,t,r,a,1);break;case h:for(let a=0;a<4;a++)q(s,n,t,r,a,1);break;case g:for(let a=0;a<8;a++)q(s,n,t,r,a,1);break}}function te(e,t,r){let o=e.current.attacks,s=e.current.board;for(let n=0;n<=8;n+=8){let a=n<<4,i=o[t|a|Pt];for(let c=0;c<8;c++)i&1<<c&&q(o,s,t,n,c,r)}}function q(e,t,r,o,s,n){let a=Gt[s];for(;((r+=a)&136)==0&&(Ye(e,r,o,s,n),t[r]===l););}function rt(e,t,r,o){if(t&136)return;let s=r<<4;e[t|s|qt]+=o}function Ye(e,t,r,o,s){let n=r<<4;s?e[t|n|Pt]|=1<<o:e[t|n|Pt]&=~(1<<o)}var ee=8*8*2,K,x,ct=class{constructor(){b(this,K,0);b(this,x,[re()]);this.current=p(this,x)[0]}reset(){N(this,K,0);let t=this.current=p(this,x)[0];t.board.fill(l),t.attacks.fill(0),t.clock=0,t.moveNum=0,t.ep=136,t.status=Q,t.turn=f,t.seen={},t.castles=0,t.moveCache[f]=null,t.moveCache[T]=null}set(t,r){V((t&136)==0,"Invalid set() coord");let o=this.current.board[t];if(o!==l){let s=C(o),n=y(o);Jt(this,t,s,n)}if(this.current.board[t]=r,r!==l){let s=C(r),n=y(r);Xt(this,t,s,n)}}get(t){return V((t&136)==0,"Invalid get() coord"),this.current.board[t]}putBoardHash(t){for(let r=p(this,K);r>=0;r--)if(t in p(this,x)[r].seen){let o=1+p(this,x)[r].seen[t];return this.current.seen[t]=o,o}return this.current.seen[t]=1,1}save(){let t=N(this,K,+p(this,K)+1);t===p(this,x).length&&p(this,x).push(re()),this.current=p(this,x)[t],Le(p(this,x)[t-1],this.current)}restore(){if(p(this,K)>0){let t=N(this,K,+p(this,K)-1);this.current=p(this,x)[t]}}};K=new WeakMap,x=new WeakMap;function re(){return{board:new Uint8Array(ee).fill(l),attacks:new Uint8Array(ee*2).fill(0),clock:0,moveNum:1,ep:136,status:Q,turn:f,seen:{},castles:0,moveCache:{[f]:null,[T]:null}}}function Le(e,t){t.board.set(e.board),t.attacks.set(e.attacks),t.clock=e.clock,t.moveNum=e.moveNum,t.ep=e.ep,t.status=e.status,t.turn=e.turn,t.seen={},t.castles=e.castles,t.moveCache[f]=e.moveCache[f],t.moveCache[T]=e.moveCache[T]}var Fe=" PBNRQK  pbnrqk";function gt(e){let t="",r=0;for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);if(i===l){r++;continue}r&&(t+=r,r=0);let c=i&15;t+=Fe[c]}r&&(t+=r),t+=";";let o=e.current.castles;return t+=pt(v(o,f,!0)),t+=pt(v(o,f,!1)),t+=pt(v(o,T,!0)),t+=pt(v(o,T,!1)),t+=";"+pt((e.current.ep||136)&15),t}function pt(e){return e&8?"-":String(e)}var oe=[h,P,S,g,w,S,P,h],se=Array(8).fill(M);function Mt(){let e=new ct;return At(e,f,0,oe),At(e,f,16,se),At(e,T,96,se),At(e,T,112,oe),e.current.castles=ht(0,7,112,119),e.putBoardHash(gt(e)),e}function At(e,t,r,o){for(let s=0;s<8;s++)e.set(r|s,nt(o[s],t,!1))}function ne(e,t,r){return U(e,t,r,0,0,0,0,0,0,0)}function ae(e,t,r,o,s){return U(e,t,r,o,s,0,0,0,0,0)}function Rt(e,t,r,o,s,n){return U(e,t,r,0,0,o,s,n,0,0)}function U(e,t,r,o,s,n,a,i,c,u){return{what:e,from:t,dest:r,capture:o,captureCoord:s,castleRook:n,castleRookFrom:a,castleRookDest:i,promote:c,markEnPassant:u}}function ie(e,t){return Ft(J({},e),{promote:t})}function D(e,t){let r=e.current;r.ep=136;let o=vt(t.what),s=C(o),n=y(o);n===w&&(r.castles=Ht(r.castles,s)),n===h&&!tt(t.what)&&(r.castles=xt(r.castles,t.from)),t.markEnPassant&&(r.ep=t.markEnPassant),t.promote&&(o=Dt(o,t.promote)),e.set(t.dest,o),e.set(t.from,l),t.capture&&t.captureCoord!==t.dest&&e.set(t.captureCoord,l),t.castleRook&&(e.set(t.castleRookDest,vt(t.castleRook)),e.set(t.castleRookFrom,l)),C(o)&&r.moveNum++,t.capture||y(o)===M?r.clock=0:r.clock++,t.capture&&y(t.capture)===h&&!tt(t.capture)&&(r.castles=xt(r.castles,t.captureCoord)),r.moveCache[f]=null,r.moveCache[T]=null,r.turn=8-r.turn}function ut(e,t){let r=8-t;for(let o=0;o<128;o+=16)for(let s=0;s<8;s++){let n=o|s,a=e.get(n);if(!(a===l||y(a)!==w||C(a)!==t)&&Zt(e,n,r))return!0}return!1}var wt=[16,1,-16,-1,17,-15,-17,15],Ke=[31,33,14,18,-18,-14,-33,-31],Ue=[-1,1],De=[g,h,P,S];function L(e,t){let r=e.current.moveCache[t];if(r)return[...r];let o=[];for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);i!==l&&C(i)===t&&Bt(e,a,o)}return e.current.moveCache[t]=o,o}function Bt(e,t,r=[]){let o=e.get(t);switch(V(o!==l,"Listing moves of empty space"),e.save(),e.set(t,l),y(o)){case S:lt(e,o,t,wt,4,8,8,r);break;case h:lt(e,o,t,wt,0,4,8,r);break;case g:lt(e,o,t,wt,0,8,8,r);break;case P:lt(e,o,t,Ke,0,8,1,r);break;case w:lt(e,o,t,wt,0,8,1,r),We(e,o,t,r);break;case M:$e(e,o,t,r);break}return e.restore(),r}function lt(e,t,r,o,s,n,a,i){let c=C(t),u=8-c;for(let d=s;d<n;d++){let _=o[d];for(let E=r+_,I=0;(E&136)==0&&I<a;E+=_,I++){let G=e.get(E);if(G===l){j(e,i,ne(t,r,E));continue}C(G)===u&&j(e,i,ae(t,r,E,G,E));break}}}function We(e,t,r,o){if(tt(t))return;let s=C(t),n=e.current.castles,a=v(n,s,!0),i=v(n,s,!1),c=r&240;if((a&8)==0){let u=c|6,d=c|a,_=c|5;ce(e,o,Rt(t,r,u,e.get(d),d,_))}if((i&8)==0){let u=c|2,d=c|i,_=c|3;ce(e,o,Rt(t,r,u,e.get(d),d,_))}}function $e(e,t,r,o){let s=C(t),n=8-s,a=s===f?1:-1,i=r+16*a,c=r+32*a;if(i&136)return o;let u=c&136?g:0;e.get(i)===l&&(j(e,o,U(t,r,i,0,0,0,0,0,u,0)),!tt(t)&&(c&136)==0&&e.get(c)===l&&j(e,o,U(t,r,c,0,0,0,0,0,0,i)));let d=e.current.ep;for(let _ of Ue){let E=i+_;if(E&136)continue;let I=e.get(E);if(E===d){let G=r+_,ge=e.get(G);j(e,o,U(t,r,E,ge,G,0,0,0,u,0))}else I!==l&&C(I)===n&&j(e,o,U(t,r,E,I,E,0,0,0,u,0))}return o}function j(e,t,r){let o=C(r.what);if(e.save(),D(e,r),!ut(e,o))if(r.promote)for(let s of De)t.push(ie(r,s));else t.push(r);e.restore()}function ce(e,t,r){let o=C(r.what),s=Math.min(r.castleRookFrom,r.castleRookDest,r.from,r.dest),n=Math.max(r.castleRookFrom,r.castleRookDest,r.from,r.dest);for(let u=s;u<=n;u++){if(u===r.from||u===r.castleRookFrom)continue;if(e.get(u)!==l)return}e.save(),e.set(r.from,l),e.set(r.castleRookFrom,l);let a=Math.min(r.from,r.dest),i=Math.max(r.from,r.dest);for(let u=a;u<=i;u++)e.set(u,r.what);let c=ut(e,o);e.restore(),!c&&j(e,t,r)}function pe(e){let t=0,r=Array(8).fill(0),o=0;for(let a=0;a<128;a+=16)for(let i=0;i<8;i++){let c=a|i,u=e.get(c);if(u===l)continue;let d=y(u);if(d===M||d===h||d===g)return!1;t++,d===S&&(o+=(c>>>4^c)&1),r[d]++}if(t===2)return!0;let s=r[S],n=r[P];return t===3&&(s===1||n===1)||t===s+2&&(o===0||o===s)}function W(e,t){let r=8-t,o=ut(e,r),s=L(e,r).length>0,n=e.putBoardHash(gt(e)),a=He(e,o,s,n);return{enemyInCheck:o,enemyCanMove:s,newGameStatus:a}}function He(e,t,r,o){let s=e.current.status;return r?e.current.clock>=100?yt:o>=3?Tt:pe(e)?St:s:t?at:et}var Ve=/[1-8]/,Qe=/[PBNRQK]/,qe=/[pbnrqk]/;function _t(e,t){t&&t.reset();let r=t||new ct;e=e.trim();let o=e.split(/\s+/g);if(o.length!==6)throw new m("Bad FEN string: Wrong number of sections");let s=o[0].split("/");if(s.length!==8)throw new m("Bad FEN string: Board data should have 8 ranks");for(let i=7;i>=0;i--){let c=0,u=s[7-i];for(let d=0;d<8;d++){let _=i<<4|d;if(c>=u.length)throw new m(`Bad FEN string: Rank ${i+1} had less than 8 files`);let E=u[c++];if(Ve.test(E)){let I=parseInt(E,10);for(let G=0;G<I;G++)r.set(_+G,l);d+=I-1}else if(Qe.test(E)){let I=ue(E);r.set(_,le(f,I,i))}else if(qe.test(E)){let I=ue(E);r.set(_,le(T,I,i))}}if(c<u.length)throw new m(`Bad FEN string: Rank ${i+1} had more than 8 files`)}let n=je(o[1]);r.current.turn=n,r.current.castles=ze(o[2]),o[3]!=="-"&&(r.current.ep=Y(o[3])),r.current.clock=fe(o[4]),r.current.moveNum=fe(o[5]);let a=W(r,8-n);return r.current.status=a.newGameStatus,r}function ue(e){switch(e.toLowerCase()){case"p":return M;case"b":return S;case"n":return P;case"r":return h;case"q":return g;case"k":return w}throw new m("Bad FEN string: Unknown piece: "+e)}function je(e){switch(e){case"w":return f;case"b":return T}throw new m("Bad FEN string: Invalid turn: "+e)}function ze(e){if(e.length>4)throw new m("Bad FEN string: Castle eligibility list is too long");let t=136,r=136,o=136,s=136;if(e!=="-")for(let n=0;n<e.length;n++)switch(e[n]){case"K":r=7;break;case"Q":t=0;break;case"k":s=119;break;case"q":o=112;break;default:throw new m("Bad FEN string: Unknown character in castle eligibility list: "+e[n])}return ht(t,r,o,s)}function le(e,t,r){return t===M?nt(t,e,!(r===1&&e===f||r===6&&e===T)):nt(t,e,!1)}function fe(e){let t=parseInt(e,10);if(isNaN(t))throw new m("Bad FEN string: Bad number: "+e);return t}var me={"":M,B:S,N:P,R:h,Q:g,K:w},Ze=/^(O-O(?:-O)?|0-0(?:-0)?)(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/,Je=/^([BNRQK]?)([a-h]?)([1-8]?)(x?)([a-h][1-8])(?:=([BNRQ]))?(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/;function It(e,t){t=t.trim();let r=t.match(Ze);if(r)return de(e,t,r[1].length===5?n=>(n.castleRookDest&7)==3:n=>(n.castleRookDest&7)==5);let o=t.match(Je);if(!o)throw new R(`Couldn't parse: ${t}`);return de(e,t,n=>Y(o[5])===n.dest&&y(n.what)===me[o[1]]&&(o[2]?(n.from&7)==o[2].charCodeAt(0)-97:!0)&&(o[3]?(n.from>>>4&7)==o[3].charCodeAt(0)-49:!0)&&(o[4]?n.capture!==0:n.capture===0)&&(o[6]?n.promote===me[o[6]]:!0))}function de(e,t,r){let o=null;for(let s=0;s<e.length;s++){let n=e[s];if(r(n)){if(o)throw o.promote&&n.promote?new R(`${t} needs a promotion type`):new R(`${t} is ambiguous`);o=n}}if(o)return o;throw new R(`${t} is not a valid move`)}function bt(e,t,r){let o;if(t.castleRook)o=t.castleRookFrom<t.from?"O-O-O":"O-O";else{let n=Xe(e,t),a=Ee(y(t.what)),i=t.capture?"x":"",c=k(t.dest),u=t.promote?"="+Ee(t.promote):"";o=`${a}${n}${i}${c}${u}`}let s=r?tr(r):"";return`${o}${s}`}function Xe(e,t){let r=k(t.from);if(y(t.what)===M&&t.capture)return r[0];let o=e.filter(a=>a.from!==t.from&&a.dest===t.dest&&y(a.what)===y(t.what));if(!o.length)return"";let[s,n]=st(t.from);return o.every(a=>st(a.from)[0]!==s)?r[0]:o.every(a=>st(a.from)[1]!==n)?r[1]:r}function Ee(e){switch(e){case S:return"B";case P:return"N";case h:return"R";case g:return"Q";case w:return"K";default:return""}}function tr(e){return e.enemyInCheck?e.enemyCanMove?"+":"#":""}var er=/^([a-h][1-8])[- ]*([a-h][1-8])([bnrqBNRQ])?$/,rr={N:P,B:S,R:h,Q:g};function Ce(e,t){let r=t.match(er);return r?or(e,r[1],r[2],r[3]):sr(e,t)}function or(e,t,r,o){let s=Y(t),n=Y(r),a=0;if(o&&(a=rr[o.toUpperCase()],!a))throw new R(`Invalid promotion: ${o}`);let i=e.current.turn,c=L(e,i),u=c.find(E=>E.from===s&&E.dest===n&&(a?E.promote===a:!0));if(!u)throw new R(`Invalid move: ${t}${r}${o||""}`);if(u.promote&&!a)throw new dt;let d=e.current.moveNum;D(e,u);let _=W(e,i);return e.current.status=_.newGameStatus,{num:d,side:i===f?"white":"black",from:t,dest:r,san:bt(c,u,_),move:u}}function sr(e,t){let r=e.current.turn,o=L(e,r),s=It(o,t),n=e.current.moveNum;D(e,s);let a=W(e,r);return e.current.status=a.newGameStatus,{num:n,side:r===f?"white":"black",from:k(s.from),dest:k(s.dest),san:bt(o,s,a),move:s}}var nr=/^[A-Z][a-zA-Z0-9_]*$/,ar=/^[\u0020-\u007e]*$/;function z(e,t){if(!nr.test(e))throw new H("Invalid PGN tag name: "+e);if(!ar.test(t))throw new H("Invalid characters in PGN tag value")}var ir=/^\s/,cr=/^[\[\]().*]/,pr=/^\d/,ur=/^[a-z0-9]/i,lr=/^[-a-z0-9_+#=:/]/i,fr=/^\d+$/,mr=/^(1-0|0-1|1\/2-1\/2)$/;function he(e){var a;let t=yr(e),r={},o=[];for(;((a=t[0])==null?void 0:a.type)==="[";)dr(t,r);let s=r.SetUp==="1"&&r.FEN?_t(r.FEN):Mt();Er(t,s,o);let n=Cr(t,s);if(r.Result&&n!==r.Result)throw new m("PGN Result tag has an incorrect game status");return{board:s,tags:r,moves:o,winner:Tr(n)}}function dr(e,t){let r=e.shift();ft(r,"[");let o=e.shift();ft(o,"Sym");let s=e.shift();ft(s,"Str");let n=e.shift();if(ft(n,"]"),z(o.value,s.value),t[o.value])throw new m("Duplicate PGN tag: "+o.value);t[o.value]=s.value}function Er(e,t,r){for(;;){let o=e.shift();if(!o)throw new m("PGN move list didn't have a conclusion");if(o.type==="Int"){if(t.current.moveNum!==o.value)throw new m(`PGN move list expected it to be turn ${o.value}, but the board is on ${t.current.moveNum}'`);continue}if(o.type!=="."&&o.type!=="Nag"){if(o.type==="*"){e.unshift(o);break}if(o.type==="("){let s=1;for(;s;){let n=e.shift();if(!n)throw new m("PGN move list didn't have a conclusion");n.type==="("?s++:n.type===")"&&s--}continue}if(o.type==="Sym"){if(mr.test(o.value)){e.unshift(o);break}hr(t,r,o.value);continue}throw new m(`PGN data had unexpected data in the move list: ${Te(o)}`)}}}function Cr(e,t){let r=e.shift();if(!r)throw new m("PGN move list didn't have a conclusion");if(e.length)throw new m("PGN had extra moves after game ended");if(r.type==="*")return"*";ft(r,"Sym");let o=r;switch(o.value){case"1-0":case"0-1":return t.current.status===Q&&(t.current.status=it),o.value;case"1/2-1/2":{let s=W(t,8-t.current.turn);return t.current.status=s.newGameStatus>=F?s.newGameStatus:F,o.value}default:throw new m(`PGN had an unexpected game end: ${o.value}`)}}function hr(e,t,r){let o=e.current.turn,s=L(e,o),n=It(s,r);t.push({num:e.current.moveNum,turn:e.current.turn,move:n,san:r}),D(e,n);let a=W(e,o);e.current.turn=8-o,(a.newGameStatus<F||a.newGameStatus===et)&&(e.current.status=a.newGameStatus)}function Tr(e){switch(e){case"1-0":return"white";case"0-1":return"black";case"1/2-1/2":return"draw";default:return null}}function yr(e){let t=0,r=e.length,o=[],s=0;for(;t<r;){let n=e[t];if(ir.test(n)){t++,n===`
`&&(s=t);continue}if(t===s&&n==="%"){for(;t<r&&e[++t]!==`
`;);continue}if(n===";"){for(;t<r&&e[++t]!==`
`;);continue}if(n==="{"){for(;t<r&&e[++t]!=="}";);t++;continue}if(cr.test(n)){t++,o.push({type:n});continue}if(n==='"'){let a="";for(;;){let i=e[++t];if(t>=r)throw new m("Invalid PGN: String reached the end without being closed.");if(i==='"'){t++;break}if(i==="\\"){let u=e[++t];if(t>=r)throw new m("Invalid PGN: String reached the end without being closed.");if(u==='"'||u==="\\")a+=u;else throw new m(`Invalid PGN string escape: '\\${u}'. Can only be '\\\\' or '\\"'.`);continue}let c=i.charCodeAt(0);if(c<32||c>126)throw new m("PGN strings can only contain printable ASCII characters.");a+=i}if(a.length>=256)throw new m("PGN strings must be at most 255 characters long.");o.push({type:"Str",value:a});continue}if(n==="$"){let a="";for(;t<r;){let i=e[++t];if(!pr.test(i))break;a+=i}if(!a)throw new m("PGN $ characters must be followed by a digit");o.push({type:"Nag",value:parseInt(a,10)});continue}if(ur.test(n)){let a=n;for(;t<r;){let i=e[++t];if(t>=r||!lr.test(i))break;a+=i}if(fr.test(a)){o.push({type:"Int",value:parseInt(a,10)});continue}for(let i=0;i<2;i++){let c=e[t];if(c!=="!"&&c!=="?")break;a+=c,t++}if(a.length>=256)throw new m("PGN symbols must be at most 255 characters long.");o.push({type:"Sym",value:a});continue}throw new m(`PGN has invalid character: ${n} at ${e.slice(t-20,t+20)}`)}return o}function ft(e,t){(!e||e.type!==t)&&new m(`Expected a '${t}' token, but got ${Te(e)}.`)}function Te(e){if(!e)return"the end-of-file";switch(e.type){case"[":case"]":case"(":case")":case".":case"*":return`a '${e.type}`;case"Int":return`the Integer '${e.value}'`;case"Str":return`the String '${e.value}'`;case"Sym":return`the Symbol '${e.value}'`;case"Nag":return`the NAG Code $${e.value}`;default:return`the unknown symbol: ${JSON.stringify(e)}`}}var ye=80;function Se({winner:e,moves:t,tags:r}){let o=Pr(e);r=J({Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:o},r);let s="";for(let a of Object.keys(r))s+=Sr(a,r[a])+`
`;s+=`
`;let n=0;for(let a=0;a<t.length;a++){let i=t[a],c="";(!a||i.side==="white")&&(c+=i.num,c+=i.side==="white"?". ":"... "),c+=i.san,n+=c.length,n>ye&&(s+=`
`,n=c.length),s+=c,n<ye&&(s+=" ",n++)}return s+=o,s}function Sr(e,t){return z(e,t),t=t.replace(/["\\]/g,"\\$&"),`[${e} "${t}"]`}function Pr(e){switch(e){case"white":return"1-0";case"black":return"0-1";case"draw":return"1/2-1/2";default:return"*"}}var gr={[Q]:"active",[at]:"checkmate",[it]:"resigned",[F]:"draw-other",[et]:"draw-stalemate",[Tt]:"draw-repetition",[yt]:"draw-fifty-moves",[St]:"draw-no-material"},A,Z,B,ot,$,mt=class{constructor(t){b(this,A,void 0);b(this,Z,[]);b(this,B,null);b(this,ot,null);b(this,$,{});N(this,A,t),this.setTag("Date",new Date)}static NewStandardGame(){return new mt(Mt())}static NewFromFEN(t){let r=new mt(_t(t));return r.maybeRefreshWinner(),r.setTag("SetUp",!0),r.setTag("FEN",t),r}static NewFromPGN(t){let r=he(t),o=new mt(r.board);return N(o,$,r.tags),p(o,Z).push(...r.moves.map(s=>({num:s.num,side:s.turn===f?"white":"black",from:k(s.move.from),dest:k(s.move.dest),san:s.san,move:s.move}))),r.winner&&N(o,B,r.winner),o}getTags(){return J({},p(this,$))}setTag(t,r){if(r==null){z(t,""),delete p(this,$)[t];return}let o;typeof r=="boolean"?o=r?"1":"0":r instanceof Date?o=isNaN(r.valueOf())?"????.??.??":[r.getFullYear(),String(r.getMonth()+1).padStart(2,"0"),String(r.getDate()).padStart(2,"0")].join("."):o=String(r),z(t,o),p(this,$)[t]=o}history(){return p(this,Z).map(t=>({num:t.num,side:t.side,from:t.from,dest:t.dest,san:t.san}))}getStatus(){let t=p(this,A).current,r={state:gr[t.status],turn:t.turn===f?"white":"black"};return p(this,B)&&(r.winner=p(this,B)),p(this,ot)&&(r.reason=p(this,ot)),r}isGameOver(){return Boolean(p(this,A).current.status)}move(t){if(this.isGameOver())throw new X;let r=Ce(p(this,A),t);return p(this,Z).push(r),this.maybeRefreshWinner(),this}allMoves(t){if(this.isGameOver())return[];let r=p(this,A).current.turn,o;if(t==null)o=L(p(this,A),r);else{let s=Y(t),n=p(this,A).get(s);if(n===l||C(n)!==r)return[];o=Bt(p(this,A),s)}return o.map(s=>{let n=k(s.from),a=k(s.dest);return s.promote?{from:n,dest:a,promotion:Qt(s.promote)}:{from:n,dest:a}})}resignGame(t){if(this.isGameOver())throw new X;p(this,A).current.status=it,N(this,B,t==="white"?"black":"white")}drawGame(t){if(this.isGameOver())throw new X;p(this,A).current.status=F,t&&N(this,ot,t)}toString(t="ascii"){switch(t){case"ascii":return Nt(p(this,A),!1);case"terminal":return Nt(p(this,A),!0);case"fen":return Vt(p(this,A));case"pgn":return Se({board:p(this,A),winner:p(this,B),moves:p(this,Z),tags:p(this,$)});default:throw new H(t)}}maybeRefreshWinner(){let t=p(this,A).current.status,r=p(this,A).current.turn;t===at?N(this,B,r===f?"black":"white"):t>=F&&N(this,B,"draw")}},Pe=mt;A=new WeakMap,Z=new WeakMap,B=new WeakMap,ot=new WeakMap,$=new WeakMap;return Mr;})();
