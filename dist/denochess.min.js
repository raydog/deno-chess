/*! Deno-Chess 0.2.0, (c) 2021, license: MIT */
var DenoChess=(()=>{var Dt=Object.defineProperty;var Wt=Object.getOwnPropertySymbols;var Be=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable,$t=Math.pow,Ht=(t,e,r)=>e in t?Dt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,St=(t,e)=>{for(var r in e||(e={}))Be.call(e,r)&&Ht(t,r,e[r]);if(Wt)for(var r of Wt(e))be.call(e,r)&&Ht(t,r,e[r]);return t};var Vt=(t,e)=>{for(var r in e)Dt(t,r,{get:e[r],enumerable:!0})};var Qt=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var p=(t,e,r)=>(Qt(t,e,"read from private field"),r?r.call(t):e.get(t)),x=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},G=(t,e,r,o)=>(Qt(t,e,"write to private field"),o?o.call(t,r):e.set(t,r),r);var Or={};Vt(Or,{BeginnerAI:()=>Re,ChessGame:()=>_e,errors:()=>gt});var f=0,A=1;var gt={};Vt(gt,{ChessBadInput:()=>Q,ChessBadMove:()=>B,ChessError:()=>L,ChessGameOver:()=>ot,ChessNeedsPromotion:()=>yt,ChessParseError:()=>d});var L=class extends Error{},ot=class extends L{constructor(){super("Game is over")}},Q=class extends L{constructor(e){super(`Unexpected input: ${e}`)}},B=class extends L{constructor(e){super("Bad move: "+e)}},yt=class extends L{constructor(){super("Promotion piece is required for this move")}},d=class extends L{};function q(t,e){if(!t)throw new L(e)}var Oe=/^[a-h][1-8]$/i,Ye="abcdefgh",Fe="12345678",pt=t=>[t&7,t>>>4],Bt=(t,e)=>(e&7)<<4|t&7,U=t=>{q(Oe.test(t),"Invalid coord");let e=t.toLowerCase(),r=e.charCodeAt(0)-97,o=e.charCodeAt(1)-49;return Bt(r,o)},v=t=>{let[e,r]=pt(t);return Ye[e]+Fe[r]};var Ke=(t,e)=>t*6+e-1,Le=["P","B","N","R","Q","K","p","b","n","r","q","k"];var l=0;function E(t){return t&7}function C(t){return t>>>3&1}function ut(t){return Boolean(t&16)}function bt(t){return t===l?t:t|16}function qt(t,e){return t===l?t:t&248|e&7}var lt=(t,e,r=!1)=>t|e<<3|Number(r)<<4;function Mt(t){if(t===l)return" ";let e=Ke(C(t),E(t));return Le[e]}var jt=`   +------------------------+  
`,zt="     a  b  c  d  e  f  g  h    ",Ue={dim:t=>`[2m${t}[22m`,black:t=>`[30;2m${t}[39;22m`,darkBg:t=>`[44m${t}[49m`,lightBg:t=>`[46m${t}[49m`},De={dim:t=>t,black:t=>t,darkBg:t=>t,lightBg:t=>t};function Ot(t,e){let r=e?Ue:De,o=r.dim(zt)+`
`+jt;for(let s=7;s>=0;s--){let a=` ${r.dim(String(s+1))} |`;for(let n=0;n<8;n++){let i=Bt(n,s),c=t.get(i);a+=We(r,i,c)}o+=a+`| ${r.dim(String(s+1))}
`}return o+jt+r.dim(zt)}function We(t,e,r){let o;if(r===l)o=t.dim("   ");else{let s=" "+Mt(r)+" ";o=C(r)===f?s:t.black(s)}return((e>>>4^e)&1)==0?t.darkBg(o):t.lightBg(o)}function Pt(t,e,r,o){return e&15|(t&15)<<4|(o&15)<<8|(r&15)<<12}function Xt(t,e){return e===f?t&65280|136:t&255|34816}function Zt(t,e){let r=e<64?0:8,o=r+4,s=e&15;if((t>>>r&15)===s){let a=t&~(15<<r),n=8<<r;return a|n}if((t>>>o&15)===s){let a=t&~(15<<o),n=8<<o;return a|n}return t}function R(t,e,r){let o=(e<<3)+(r?0:4);return t>>>o&15}function Jt(t){let e="";for(let s=112;s>=0;s-=16){let a=0;for(let n=0;n<8;n++){let i=s|n,c=t.get(i);if(c===l){a++;continue}a&&(e+=a,a=0),e+=Mt(c)}a&&(e+=a),s&&(e+="/")}e+=t.current.turn===f?" w":" b";let r=t.current.castles;e+=" "+$e(r);let o=t.current.ep;return e+=o&136?" -":" "+v(o),e+=" "+t.current.clock,e+=" "+t.current.moveNum,e}function $e(t){let e="";return e+=R(t,f,!0)&8?"":"K",e+=R(t,f,!1)&8?"":"Q",e+=R(t,A,!0)&8?"":"k",e+=R(t,A,!1)&8?"":"q",e||"-"}var j=0,z=10,ft=11,D=20,st=21,At=22,wt=23,_t=24;var y=1,g=2,M=3,S=4,P=5,w=6;var te=0,vt=8,Yt=[16,1,-16,-1,17,-15,-17,15],ee=[31,33,14,18,-18,-14,-33,-31],re=[[15,17],[-15,-17]];function oe(t,e,r){let o=t.current.attacks,s=r<<7;return Boolean(o[e|s|vt]||o[e|s|te])}function se(t,e,r,o){let s=t.current.attacks,a=t.current.board;switch(o){case y:for(let n of re[r])nt(s,e+n,r,-1);break;case M:for(let n of ee)nt(s,e+n,r,-1);break;case w:for(let n of Yt)nt(s,e+n,r,-1);break;case g:for(let n=4;n<8;n++)X(s,a,e,r,n,0);break;case S:for(let n=0;n<4;n++)X(s,a,e,r,n,0);break;case P:for(let n=0;n<8;n++)X(s,a,e,r,n,0);break}ae(t,e,1)}function ne(t,e,r,o){let s=t.current.attacks,a=t.current.board;switch(ae(t,e,0),o){case y:for(let n of re[r])nt(s,e+n,r,1);break;case M:for(let n of ee)nt(s,e+n,r,1);break;case w:for(let n of Yt)nt(s,e+n,r,1);break;case g:for(let n=4;n<8;n++)X(s,a,e,r,n,1);break;case S:for(let n=0;n<4;n++)X(s,a,e,r,n,1);break;case P:for(let n=0;n<8;n++)X(s,a,e,r,n,1);break}}function ae(t,e,r){let o=t.current.attacks,s=t.current.board;for(let a=0;a<2;a++){let n=a<<7,i=o[e|n|vt];for(let c=0;c<8;c++)i&1<<c&&X(o,s,e,a,c,r)}}function X(t,e,r,o,s,a){let n=Yt[s];for(;((r+=n)&136)==0&&(He(t,r,o,s,a),e[r]===l););}function nt(t,e,r,o){if(e&136)return;let s=r<<7;t[e|s|te]+=o}function He(t,e,r,o,s){let a=r<<7;s?t[e|a|vt]|=1<<o:t[e|a|vt]&=~(1<<o)}var ie=8*8*2,W,b,Z=class{constructor(){x(this,W,0);x(this,b,[ce()]);this.current=p(this,b)[0]}reset(){G(this,W,0);let e=this.current=p(this,b)[0];e.board.fill(l),e.attacks.fill(0),e.clock=0,e.moveNum=0,e.ep=136,e.status=j,e.turn=f,e.seen={},e.castles=0}set(e,r){q((e&136)==0,"Invalid set() coord");let o=this.current.board[e];if(o!==l){let s=C(o),a=E(o);se(this,e,s,a)}if(this.current.board[e]=r,r!==l){let s=C(r),a=E(r);ne(this,e,s,a)}}get(e){return q((e&136)==0,"Invalid get() coord"),this.current.board[e]}putBoardHash(e){for(let r=p(this,W);r>=0;r--)if(e in p(this,b)[r].seen){let o=1+p(this,b)[r].seen[e];return this.current.seen[e]=o,o}return this.current.seen[e]=1,1}save(){let e=G(this,W,+p(this,W)+1);e===p(this,b).length&&p(this,b).push(ce()),this.current=p(this,b)[e],Ve(p(this,b)[e-1],this.current)}restore(){if(p(this,W)>0){let e=G(this,W,+p(this,W)-1);this.current=p(this,b)[e]}}};W=new WeakMap,b=new WeakMap;function ce(){return{board:new Uint8Array(ie).fill(l),attacks:new Uint8Array(ie*2).fill(0),clock:0,moveNum:1,ep:136,status:j,turn:f,seen:{},castles:0}}function Ve(t,e){e.board.set(t.board),e.attacks.set(t.attacks),e.clock=t.clock,e.moveNum=t.moveNum,e.ep=t.ep,e.status=t.status,e.turn=t.turn,e.seen={},e.castles=t.castles}var Qe=" PBNRQK  pbnrqk";function It(t){let e="",r=0;for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,i=t.get(n);if(i===l){r++;continue}r&&(e+=r,r=0);let c=i&15;e+=Qe[c]}r&&(e+=r),e+=";";let o=t.current.castles;return e+=mt(R(o,f,!0)),e+=mt(R(o,f,!1)),e+=mt(R(o,A,!0)),e+=mt(R(o,A,!1)),e+=";"+mt((t.current.ep||136)&15),e}function mt(t){return t&8?"-":String(t)}var pe=[S,M,g,P,w,g,M,S],ue=Array(8).fill(y);function kt(){let t=new Z;return Gt(t,f,0,pe),Gt(t,f,16,ue),Gt(t,A,96,ue),Gt(t,A,112,pe),t.current.castles=Pt(0,7,112,119),t.putBoardHash(It(t)),t}function Gt(t,e,r,o){for(let s=0;s<8;s++)t.set(r+s,lt(o[s],e,!1))}function le(t,e,r){return $(t,e,r,0,0,0,0,0,0,0)}function fe(t,e,r,o,s){return $(t,e,r,o,s,0,0,0,0,0)}function Ft(t,e,r,o,s,a){return $(t,e,r,0,0,o,s,a,0,0)}function $(t,e,r,o,s,a,n,i,c,u){return{what:t,from:e,dest:r,capture:o,captureCoord:s,castleRook:a,castleRookFrom:n,castleRookDest:i,promote:c,markEnPassant:u}}function Y(t,e){t.current.ep=136;let r=bt(e.what),o=C(r),s=E(r);s===w&&(t.current.castles=Xt(t.current.castles,o)),s===S&&!ut(e.what)&&(t.current.castles=Zt(t.current.castles,e.from)),e.markEnPassant&&(t.current.ep=e.markEnPassant),e.promote&&(r=qt(r,e.promote)),t.set(e.dest,r),t.set(e.from,l),e.capture&&e.captureCoord!==e.dest&&t.set(e.captureCoord,l),e.castleRook&&(t.set(e.castleRookDest,bt(e.castleRook)),t.set(e.castleRookFrom,l)),C(r)&&t.current.moveNum++,E(r)===y||e.capture?t.current.clock=0:t.current.clock++,t.current.turn=1-t.current.turn}function dt(t,e){let r=1-e;for(let o=0;o<128;o+=16)for(let s=0;s<8;s++){let a=o|s,n=t.get(a);if(!(n===l||E(n)!==w||C(n)!==e)&&oe(t,a,r))return!0}return!1}var Nt=[16,1,-16,-1,17,-15,-17,15],qe=[31,33,14,18,-18,-14,-33,-31],je=[-1,1];function N(t,e){let r=[];for(let o=0;o<128;o+=16)for(let s=0;s<8;s++){let a=o|s,n=t.get(a);n!==l&&C(n)===e&&Kt(t,a,r)}return r}function Kt(t,e,r=[]){let o=t.get(e);switch(q(o!==l,"Listing moves of empty space"),E(o)){case g:Et(t,o,e,Nt,4,8,8,r);break;case S:Et(t,o,e,Nt,0,4,8,r);break;case P:Et(t,o,e,Nt,0,8,8,r);break;case M:Et(t,o,e,qe,0,8,1,r);break;case w:Et(t,o,e,Nt,0,8,1,r),ze(t,o,e,r);break;case y:Xe(t,o,e,r);break}return r}function Et(t,e,r,o,s,a,n,i){let c=C(e),u=1-c;for(let m=s;m<a;m++){let T=o[m];for(let h=r+T,I=0;(h&136)==0&&I<n;h+=T,I++){let k=t.get(h);if(k===l){J(t,i,le(e,r,h));continue}C(k)===u&&J(t,i,fe(e,r,h,k,h));break}}}function ze(t,e,r,o){if(ut(e))return;let s=C(e),a=t.current.castles,n=R(a,s,!0),i=R(a,s,!1),c=r&240;if((n&8)==0){let u=c|6,m=c|n,T=c|5;me(t,o,Ft(e,r,u,t.get(m),m,T))}if((i&8)==0){let u=c|2,m=c|i,T=c|3;me(t,o,Ft(e,r,u,t.get(m),m,T))}}function Xe(t,e,r,o){let s=C(e),a=1-s,n=s===f?1:-1,i=r+16*n,c=r+32*n;if(i&136)return o;let u=c&136?P:0;t.get(i)===l&&(J(t,o,$(e,r,i,0,0,0,0,0,u,0)),!ut(e)&&(c&136)==0&&t.get(c)===l&&J(t,o,$(e,r,c,0,0,0,0,0,0,i)));let m=t.current.ep;for(let T of je){let h=i+T;if(h&136)continue;let I=t.get(h);if(h===m){let k=r+T,O=t.get(k);J(t,o,$(e,r,h,O,k,0,0,0,u,0))}else I!==l&&C(I)===a&&J(t,o,$(e,r,h,I,h,0,0,0,u,0))}return o}function J(t,e,r){let o=C(r.what);t.save(),Y(t,r),dt(t,o)||e.push(r),t.restore()}function me(t,e,r){let o=C(r.what),s=Math.min(r.castleRookFrom,r.castleRookDest,r.from,r.dest),a=Math.max(r.castleRookFrom,r.castleRookDest,r.from,r.dest);for(let u=s;u<=a;u++){if(u===r.from||u===r.castleRookFrom)continue;if(t.get(u)!==l)return}t.save(),t.set(r.from,l),t.set(r.castleRookFrom,l);let n=Math.min(r.from,r.dest),i=Math.max(r.from,r.dest);for(let u=n;u<=i;u++)t.set(u,r.what);let c=dt(t,o);t.restore(),!c&&J(t,e,r)}function de(t){let e=0,r=Array(8).fill(0),o=0;for(let n=0;n<128;n+=16)for(let i=0;i<8;i++){let c=n|i,u=t.get(c);if(u===l)continue;let m=E(u);if(m===y||m===S||m===P)return!1;e++,m===g&&(o+=(c>>>4^c)&1),r[m]++}if(e===2)return!0;let s=r[g],a=r[M];return e===3&&(s===1||a===1)||e===s+2&&(o===0||o===s)}function F(t,e){let r=1-e,o=dt(t,r),s=N(t,r).length>0,a=t.putBoardHash(It(t)),n=Ze(t,o,s,a);return{enemyInCheck:o,enemyCanMove:s,newGameStatus:n}}function Ze(t,e,r,o){let s=t.current.status;return r?t.current.clock>=100?wt:o>=3?At:de(t)?_t:s:e?z:st}var Je=/[1-8]/,tr=/[PBNRQK]/,er=/[pbnrqk]/;function at(t,e){e&&e.reset();let r=e||new Z;t=t.trim();let o=t.split(/\s+/g);if(o.length!==6)throw new d("Bad FEN string: Wrong number of sections");let s=o[0].split("/");if(s.length!==8)throw new d("Bad FEN string: Board data should have 8 ranks");for(let i=7;i>=0;i--){let c=0,u=s[7-i];for(let m=0;m<8;m++){let T=i<<4|m;if(c>=u.length)throw new d(`Bad FEN string: Rank ${i+1} had less than 8 files`);let h=u[c++];if(Je.test(h)){let I=parseInt(h,10);for(let k=0;k<I;k++)r.set(T+k,l);m+=I-1}else if(tr.test(h)){let I=Ee(h);r.set(T,Ce(f,I,i))}else if(er.test(h)){let I=Ee(h);r.set(T,Ce(A,I,i))}}if(c<u.length)throw new d(`Bad FEN string: Rank ${i+1} had more than 8 files`)}let a=rr(o[1]);r.current.turn=a,r.current.castles=or(o[2]),o[3]!=="-"&&(r.current.ep=U(o[3])),r.current.clock=he(o[4]),r.current.moveNum=he(o[5]);let n=F(r,1-a);return r.current.status=n.newGameStatus,r}function Ee(t){switch(t.toLowerCase()){case"p":return y;case"b":return g;case"n":return M;case"r":return S;case"q":return P;case"k":return w}throw new d("Bad FEN string: Unknown piece: "+t)}function rr(t){switch(t){case"w":return f;case"b":return A}throw new d("Bad FEN string: Invalid turn: "+t)}function or(t){if(t.length>4)throw new d("Bad FEN string: Castle eligibility list is too long");let e=136,r=136,o=136,s=136;if(t!=="-")for(let a=0;a<t.length;a++)switch(t[a]){case"K":r=7;break;case"Q":e=0;break;case"k":s=119;break;case"q":o=112;break;default:throw new d("Bad FEN string: Unknown character in castle eligibility list: "+t[a])}return Pt(e,r,o,s)}function Ce(t,e,r){return e===y?lt(e,t,!(r===1&&t===f||r===6&&t===A)):lt(e,t,!1)}function he(t){let e=parseInt(t,10);if(isNaN(e))throw new d("Bad FEN string: Bad number: "+t);return e}var Te={"":y,B:g,N:M,R:S,Q:P,K:w},sr=/^(?:O-O(?:-O)?|0-0(?:-0)?)$/,nr=/^([BNRQK]?)([a-h]?)([1-8]?)(x?)([a-h][1-8])(?:=([BNRQ]))?(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/;function xt(t,e){if(e=e.trim(),sr.test(e))return Se(t,e,e.length===5?s=>(s.castleRookDest&7)==3:s=>(s.castleRookDest&7)==5);let r=e.match(nr);if(!r)throw new B(`Couldn't parse: ${e}`);let o=Se(t,e,s=>U(r[5])===s.dest&&E(s.what)===Te[r[1]]&&(r[2]?(s.from&7)==r[2].charCodeAt(0)-97:!0)&&(r[3]?(s.from>>>4&7)==r[3].charCodeAt(0)-49:!0)&&(r[4]?s.capture!==0:s.capture===0));if(r[6]){if(E(o.what)!==y)throw new B(`Piece at ${r[5]} is not a pawn`);if(!o.promote)throw new B(`Pawn at ${r[5]} is not eligible for promotion`);o.promote=Te[r[6]]}return o}function Se(t,e,r){let o=null;for(let s=0;s<t.length;s++){let a=t[s];if(r(a)){if(o)throw new B(`${e} is ambiguous`);o=a}}if(o)return o;throw new B(`${e} is not a valid move`)}function Lt(t,e,r){let o;if(e.castleRook)o=e.castleRookFrom<e.from?"O-O-O":"O-O";else{let a=ar(t,e),n=ye(E(e.what)),i=e.capture?"x":"",c=v(e.dest),u=e.promote?"="+ye(e.promote):"";o=`${n}${a}${i}${c}${u}`}let s=r?ir(r):"";return`${o}${s}`}function ar(t,e){let r=v(e.from);if(E(e.what)===y&&e.capture)return r[0];let o=t.filter(n=>n.from!==e.from&&n.dest===e.dest&&E(n.what)===E(e.what));if(!o.length)return"";let[s,a]=pt(e.from);return o.every(n=>pt(n.from)[0]!==s)?r[0]:o.every(n=>pt(n.from)[1]!==a)?r[1]:r}function ye(t){switch(t){case g:return"B";case M:return"N";case S:return"R";case P:return"Q";case w:return"K";default:return""}}function ir(t){return t.enemyInCheck?t.enemyCanMove?"+":"#":""}var cr=/^([a-h][1-8])[- ]*([a-h][1-8])$/,pr={N:M,B:g,R:S,Q:P};function ge(t,e,r){let o=e.match(cr);return o?ur(t,o[1],o[2],r):lr(t,e)}function ur(t,e,r,o){let s=U(e),a=U(r);if(t.get(s)===l)throw new B(`Departure square (${e}) is empty`);let i=t.current.turn,c=N(t,i),u=c.find(h=>h.from===s&&h.dest===a);if(!u)throw new B(`Invalid move: ${e}${r}`);if(u.promote){if(o==null)throw new yt;if(u.promote=pr[o],!u.promote)throw new B(`Invalid promotion: ${o}`)}let m=t.current.moveNum;Y(t,u);let T=F(t,i);return t.current.status=T.newGameStatus,{num:m,side:i===f?"white":"black",from:e,dest:r,san:Lt(c,u,T),move:u}}function lr(t,e){let r=t.current.turn,o=N(t,r),s=xt(o,e),a=t.current.moveNum;Y(t,s);let n=F(t,r);return t.current.status=n.newGameStatus,{num:a,side:r===f?"white":"black",from:v(s.from),dest:v(s.dest),san:Lt(o,s,n),move:s}}var fr=/^[A-Z][a-zA-Z0-9_]*$/,mr=/^[\u0020-\u007e]*$/;function tt(t,e){if(!fr.test(t))throw new Q("Invalid PGN tag name: "+t);if(!mr.test(e))throw new Q("Invalid characters in PGN tag value")}var dr=/^\s/,Er=/^[\[\]().*]/,Cr=/^\d/,hr=/^[a-z0-9]/i,Tr=/^[-a-z0-9_+#=:/]/i,Sr=/^\d+$/,yr=/^(1-0|0-1|1\/2-1\/2)$/;function Me(t){var n;let e=_r(t),r={},o=[];for(;((n=e[0])==null?void 0:n.type)==="[";)gr(e,r);let s=r.SetUp==="1"&&r.FEN?at(r.FEN):kt();Mr(e,s,o);let a=Pr(e,s);if(r.Result&&a!==r.Result)throw new d("PGN Result tag has an incorrect game status");return{board:s,tags:r,moves:o,winner:wr(a)}}function gr(t,e){let r=t.shift();Ct(r,"[");let o=t.shift();Ct(o,"Sym");let s=t.shift();Ct(s,"Str");let a=t.shift();if(Ct(a,"]"),tt(o.value,s.value),e[o.value])throw new d("Duplicate PGN tag: "+o.value);e[o.value]=s.value}function Mr(t,e,r){for(;;){let o=t.shift();if(!o)throw new d("PGN move list didn't have a conclusion");if(o.type==="Int"){if(e.current.moveNum!==o.value)throw new d(`PGN move list expected it to be turn ${o.value}, but the board is on ${e.current.moveNum}'`);continue}if(o.type!=="."&&o.type!=="Nag"){if(o.type==="*"){t.unshift(o);break}if(o.type==="("){let s=1;for(;s;){let a=t.shift();if(!a)throw new d("PGN move list didn't have a conclusion");a.type==="("?s++:a.type===")"&&s--}continue}if(o.type==="Sym"){if(yr.test(o.value)){t.unshift(o);break}Ar(e,r,o.value);continue}throw new d(`PGN data had unexpected data in the move list: ${Pe(o)}`)}}}function Pr(t,e){let r=t.shift();if(!r)throw new d("PGN move list didn't have a conclusion");if(t.length)throw new d("PGN had extra moves after game ended");if(r.type==="*")return"*";Ct(r,"Sym");let o=r;switch(o.value){case"1-0":case"0-1":return e.current.status===j&&(e.current.status=ft),o.value;case"1/2-1/2":{let s=F(e,1-e.current.turn);return e.current.status=s.newGameStatus>=D?s.newGameStatus:D,o.value}default:throw new d(`PGN had an unexpected game end: ${o.value}`)}}function Ar(t,e,r){let o=t.current.turn,s=N(t,o),a=xt(s,r);e.push({num:t.current.moveNum,turn:t.current.turn,move:a,san:r}),Y(t,a);let n=F(t,o);t.current.turn=1-o,(n.newGameStatus<D||n.newGameStatus===st)&&(t.current.status=n.newGameStatus)}function wr(t){switch(t){case"1-0":return"white";case"0-1":return"black";case"1/2-1/2":return"draw";default:return null}}function _r(t){let e=0,r=t.length,o=[],s=0;for(;e<r;){let a=t[e];if(dr.test(a)){e++,a===`
`&&(s=e);continue}if(e===s&&a==="%"){for(;e<r&&t[++e]!==`
`;);continue}if(a===";"){for(;e<r&&t[++e]!==`
`;);continue}if(a==="{"){for(;e<r&&t[++e]!=="}";);e++;continue}if(Er.test(a)){e++,o.push({type:a});continue}if(a==='"'){let n="";for(;;){let i=t[++e];if(e>=r)throw new d("Invalid PGN: String reached the end without being closed.");if(i==='"'){e++;break}if(i==="\\"){let u=t[++e];if(e>=r)throw new d("Invalid PGN: String reached the end without being closed.");if(u==='"'||u==="\\")n+=u;else throw new d(`Invalid PGN string escape: '\\${u}'. Can only be '\\\\' or '\\"'.`);continue}let c=i.charCodeAt(0);if(c<32||c>126)throw new d("PGN strings can only contain printable ASCII characters.");n+=i}if(n.length>=256)throw new d("PGN strings must be at most 255 characters long.");o.push({type:"Str",value:n});continue}if(a==="$"){let n="";for(;e<r;){let i=t[++e];if(!Cr.test(i))break;n+=i}if(!n)throw new d("PGN $ characters must be followed by a digit");o.push({type:"Nag",value:parseInt(n,10)});continue}if(hr.test(a)){let n=a;for(;e<r;){let i=t[++e];if(e>=r||!Tr.test(i))break;n+=i}if(Sr.test(n)){o.push({type:"Int",value:parseInt(n,10)});continue}for(let i=0;i<2;i++){let c=t[e];if(c!=="!"&&c!=="?")break;n+=c,e++}if(n.length>=256)throw new d("PGN symbols must be at most 255 characters long.");o.push({type:"Sym",value:n});continue}throw new d(`PGN has invalid character: ${a} at ${t.slice(e-20,e+20)}`)}return o}function Ct(t,e){(!t||t.type!==e)&&new d(`Expected a '${e}' token, but got ${Pe(t)}.`)}function Pe(t){if(!t)return"the end-of-file";switch(t.type){case"[":case"]":case"(":case")":case".":case"*":return`a '${t.type}`;case"Int":return`the Integer '${t.value}'`;case"Str":return`the String '${t.value}'`;case"Sym":return`the Symbol '${t.value}'`;case"Nag":return`the NAG Code $${t.value}`;default:return`the unknown symbol: ${JSON.stringify(t)}`}}var Ae=80;function we({winner:t,moves:e,tags:r}){let o=Ir(t);r=St({Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:o},r);let s="";for(let n of Object.keys(r))s+=vr(n,r[n])+`
`;s+=`
`;let a=0;for(let n=0;n<e.length;n++){let i=e[n],c="";(!n||i.side==="white")&&(c+=i.num,c+=i.side==="white"?". ":"... "),c+=i.san,a+=c.length,a>Ae&&(s+=`
`,a=c.length),s+=c,a<Ae&&(s+=" ",a++)}return s+=o,s}function vr(t,e){return tt(t,e),e=e.replace(/["\\]/g,"\\$&"),`[${t} "${e}"]`}function Ir(t){switch(t){case"white":return"1-0";case"black":return"0-1";case"draw":return"1/2-1/2";default:return"*"}}var kr={[j]:"active",[z]:"checkmate",[ft]:"resigned",[D]:"draw-other",[st]:"draw-stalemate",[At]:"draw-repetition",[wt]:"draw-fifty-moves",[_t]:"draw-no-material"},_,et,K,it,H,ht=class{constructor(e){x(this,_,void 0);x(this,et,[]);x(this,K,null);x(this,it,null);x(this,H,{});G(this,_,e),this.setTag("Date",new Date)}static NewStandardGame(){return new ht(kt())}static NewFromFEN(e){let r=new ht(at(e));return r.maybeRefreshWinner(),r.setTag("SetUp",!0),r.setTag("FEN",e),r}static NewFromPGN(e){let r=Me(e),o=new ht(r.board);return G(o,H,r.tags),p(o,et).push(...r.moves.map(s=>({num:s.num,side:s.turn===f?"white":"black",from:v(s.move.from),dest:v(s.move.dest),san:s.san,move:s.move}))),r.winner&&G(o,K,r.winner),o}getTags(){return St({},p(this,H))}setTag(e,r){if(r==null){tt(e,""),delete p(this,H)[e];return}let o;typeof r=="boolean"?o=r?"1":"0":r instanceof Date?o=isNaN(r.valueOf())?"????.??.??":[r.getFullYear(),String(r.getMonth()+1).padStart(2,"0"),String(r.getDate()).padStart(2,"0")].join("."):o=String(r),tt(e,o),p(this,H)[e]=o}history(){return p(this,et).map(e=>({num:e.num,side:e.side,from:e.from,dest:e.dest,san:e.san}))}getStatus(){let e=p(this,_).current,r={state:kr[e.status],turn:e.turn===f?"white":"black"};return p(this,K)&&(r.winner=p(this,K)),p(this,it)&&(r.reason=p(this,it)),r}isGameOver(){return Boolean(p(this,_).current.status)}move(e,r){if(this.isGameOver())throw new ot;let o=ge(p(this,_),e,r);return p(this,et).push(o),this.maybeRefreshWinner(),this}allMoves(e){if(this.isGameOver())return[];let r=p(this,_).current.turn,o;if(e==null)o=N(p(this,_),r);else{let s=U(e),a=p(this,_).get(s);if(a===l||C(a)!==r)return[];o=Kt(p(this,_),s)}return o.map(s=>({from:v(s.from),dest:v(s.dest),promotion:Boolean(s.promote)}))}resignGame(e){if(this.isGameOver())throw new ot;p(this,_).current.status=ft,G(this,K,e==="white"?"black":"white")}drawGame(e){if(this.isGameOver())throw new ot;p(this,_).current.status=D,e&&G(this,it,e)}toString(e="ascii"){switch(e){case"ascii":return Ot(p(this,_),!1);case"terminal":return Ot(p(this,_),!0);case"fen":return Jt(p(this,_));case"pgn":return we({board:p(this,_),winner:p(this,K),moves:p(this,et),tags:p(this,H)});default:throw new Q(e)}}maybeRefreshWinner(){let e=p(this,_).current.status,r=p(this,_).current.turn;e===z?G(this,K,r===f?"black":"white"):e>=D&&G(this,K,"draw")}},_e=ht;_=new WeakMap,et=new WeakMap,K=new WeakMap,it=new WeakMap,H=new WeakMap;var V=$t(2,32),ct=1e3;function ve(t){if(isNaN(t)||t>ct||t<-ct||t===0)throw new Error("Out of range checkmate score: "+t);return t>0?V+ct-t:-V-ct-t}function Ie(t){if(isNaN(t)||t>=V||t<=-V)throw new Error("Out of range move score: "+t);return t}function ke(t){return t>=V?"+M"+(V+ct-t):t<=-V?"-M"+(t+V+ct):String(t)}function Ge(t,e,r,o,s){return Ne(t,e,0,r,-Infinity,Infinity,o,s)}function Ne(t,e,r,o,s,a,n,i){let c=1-e;if(F(t,c).newGameStatus===z)return{score:ve(-r)};if(r>=o)return{score:Ie(i(t))};let m=e===f?-Infinity:Infinity,T=[],I=[...N(t,e)].sort(n);for(let k of I){t.save(),Y(t,k);let{score:O}=Ne(t,c,r+1,o,s,a,n,i);if(t.restore(),O===m)T.push(k);else if(e===f){if(O>m&&(m=O,T=[k]),s<O&&(s=O),s>=a)break}else if(e===A&&(O<m&&(m=O,T=[k]),a>O&&(a=O),a<=s))break}return r?{score:m}:{score:m,move:Gr(T)}}function Gr(t){return t[Math.floor(Math.random()*t.length)]}function xe(t){return t==="white"?f:A}var rt,Tt,Rt,Ut=class{constructor(e,r){x(this,rt,void 0);x(this,Tt,void 0);x(this,Rt,new Z);G(this,rt,e),G(this,Tt,r)}static NewForGame(e,r){return new Ut(e,xe(r))}takeTurn(){let e=p(this,Rt),r=p(this,rt).getStatus();if(r.state!=="active"){console.warn("Game over");return}let o=xe(r.turn);if(o!==p(this,Tt)){console.warn("Not my turn...");return}let s=p(this,rt).toString("fen");at(s,e);let a=Date.now(),n=Ge(e,o,3,Nr,xr);if(!n.move)throw new Error("Need move list");let i=v(n.move.from)+v(n.move.dest);console.log("Best Move (%s) = [%s] in %d ms",ke(n.score),i,Date.now()-a),p(this,rt).move(i,"Q")}},Re=Ut;rt=new WeakMap,Tt=new WeakMap,Rt=new WeakMap;function Nr(t,e){return E(e.capture)-E(t.capture)}function xr(t){let e=Rr(t),r=Br(t);return e+.25*r}function Rr(t){let e=0;for(let r=0;r<128;r+=16)for(let o=0;o<8;o++){let s=r|o,a=t.get(s);if(a===l)continue;let n=br(E(a));C(a)===f?e+=n:e-=n}return e}function Br(t){return N(t,f).length-N(t,A).length}function br(t){switch(t){case y:return 1;case M:return 3;case g:return 3;case S:return 5;case P:return 9;case w:return 200;default:return 0}}return Or;})();
