/*! Deno-Chess 0.6.0, (c) 2023, license: MIT */
var DenoChess=(()=>{var Nt=Object.defineProperty,Ae=Object.defineProperties;var _e=Object.getOwnPropertyDescriptors;var Kt=Object.getOwnPropertySymbols;var Ie=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var Dt=(e,t,r)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,tt=(e,t)=>{for(var r in t||(t={}))Ie.call(t,r)&&Dt(e,r,t[r]);if(Kt)for(var r of Kt(t))ke.call(t,r)&&Dt(e,r,t[r]);return e},Ut=(e,t)=>Ae(e,_e(t)),ve=e=>Nt(e,"__esModule",{value:!0});var Ft=(e,t)=>{ve(e);for(var r in t)Nt(e,r,{get:t[r],enumerable:!0})};var Wt=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var p=(e,t,r)=>(Wt(e,t,"read from private field"),r?r.call(e):t.get(e)),L=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},w=(e,t,r,o)=>(Wt(e,t,"write to private field"),o?o.call(e,r):t.set(e,r),r);var Br={};Ft(Br,{ChessGame:()=>ge,errors:()=>ht});var u=0,m=8;var ht={};Ft(ht,{ChessBadInput:()=>Q,ChessBadMove:()=>x,ChessError:()=>Y,ChessGameOver:()=>et,ChessNeedsPromotion:()=>V,ChessParseError:()=>T});var Y=class extends Error{},et=class extends Y{constructor(){super("Game is over")}},Q=class extends Y{constructor(t){super(`Unexpected input: ${t}`)}},x=class extends Y{constructor(t){super("Bad move: "+t)}},V=class extends Y{constructor(){super("Promotion piece is required for this move")}},T=class extends Y{};function q(e,t){if(!e)throw new Y(t)}var we=/^[a-h][1-8]$/i,Ne="abcdefgh",Ge="12345678",it=e=>[e&7,e>>>4],Gt=(e,t)=>(t&7)<<4|e&7,R=e=>{q(we.test(e),"Invalid coord");let t=e.toLowerCase(),r=t.charCodeAt(0)-97,o=t.charCodeAt(1)-49;return Gt(r,o)},v=e=>{let[t,r]=it(e);return Ne[t]+Ge[r]};var Re=(e,t)=>e|t,xe=["","P","B","N","R","Q","K","","","p","b","n","r","q","k"];var l=0;function C(e){return e&7}function d(e){return e&8}function rt(e){return Boolean(e&16)}function Rt(e){return e===l?e:e|16}function $t(e,t){return e===l?e:e&248|t&7}var ct=(e,t,r=!1)=>e|t|Number(r)<<4;function Tt(e){if(e===l)return" ";let t=Re(d(e),C(e));return xe[t]}var Ht=`   +------------------------+  
`,Qt="     a  b  c  d  e  f  g  h    ",Be={dim:e=>`[2m${e}[22m`,black:e=>`[30;2m${e}[39;22m`,darkBg:e=>`[44m${e}[49m`,lightBg:e=>`[46m${e}[49m`},Oe={dim:e=>e,black:e=>e,darkBg:e=>e,lightBg:e=>e};function xt(e,t){let r=t?Be:Oe,o=r.dim(Qt)+`
`+Ht;for(let s=7;s>=0;s--){let n=` ${r.dim(String(s+1))} |`;for(let a=0;a<8;a++){let i=Gt(a,s),c=e.get(i);n+=be(r,i,c)}o+=n+`| ${r.dim(String(s+1))}
`}return o+Ht+r.dim(Qt)}function be(e,t,r){let o;if(r===l)o=e.dim("   ");else{let s=" "+Tt(r)+" ";o=d(r)===u?s:e.black(s)}return((t>>>4^t)&1)==0?e.darkBg(o):e.lightBg(o)}function St(e,t,r,o){return t&15|(e&15)<<4|(o&15)<<8|(r&15)<<12}function Vt(e,t){return t===u?e&65280|136:e&255|34816}function Bt(e,t){let r=t<64?0:8,o=r+4,s=t&15;if((e>>>r&15)===s){let n=e&~(15<<r),a=8<<r;return n|a}if((e>>>o&15)===s){let n=e&~(15<<o),a=8<<o;return n|a}return e}function N(e,t,r){let o=t+(r?0:4);return e>>>o&15}function qt(e){let t="";for(let s=112;s>=0;s-=16){let n=0;for(let a=0;a<8;a++){let i=s|a,c=e.get(i);if(c===l){n++;continue}n&&(t+=n,n=0),t+=Tt(c)}n&&(t+=n),s&&(t+="/")}t+=e.current.turn===u?" w":" b";let r=e.current.castles;t+=" "+Le(r);let o=e.current.ep;return t+=o&136?" -":" "+v(o),t+=" "+e.current.clock,t+=" "+e.current.moveNum,t}function Le(e){let t="";return t+=N(e,u,!0)&8?"":"K",t+=N(e,u,!1)&8?"":"Q",t+=N(e,m,!0)&8?"":"k",t+=N(e,m,!1)&8?"":"q",t||"-"}var j=0,pt=10,ut=11,F=20,ot=21,Pt=22,yt=23,gt=24;var _=1,S=2,M=3,h=4,A=5,k=6,Ye={[_]:"P",[S]:"B",[M]:"N",[h]:"R",[A]:"Q",[k]:"K"};function Ot(e){return Ye[e]}var jt=0,Mt=8,bt=[16,1,-16,-1,17,-15,-17,15],Xt=[31,33,14,18,-18,-14,-33,-31],Zt={[u]:[15,17],[m]:[-15,-17]};function zt(e,t,r){let o=e.current.attacks,s=r<<4;return Boolean(o[t|s|Mt]||o[t|s|jt])}function Jt(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(o){case _:for(let a of Zt[r])st(s,t+a,r,-1);break;case M:for(let a of Xt)st(s,t+a,r,-1);break;case k:for(let a of bt)st(s,t+a,r,-1);break;case S:for(let a=4;a<8;a++)X(s,n,t,r,a,0);break;case h:for(let a=0;a<4;a++)X(s,n,t,r,a,0);break;case A:for(let a=0;a<8;a++)X(s,n,t,r,a,0);break}ee(e,t,1)}function te(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(ee(e,t,0),o){case _:for(let a of Zt[r])st(s,t+a,r,1);break;case M:for(let a of Xt)st(s,t+a,r,1);break;case k:for(let a of bt)st(s,t+a,r,1);break;case S:for(let a=4;a<8;a++)X(s,n,t,r,a,1);break;case h:for(let a=0;a<4;a++)X(s,n,t,r,a,1);break;case A:for(let a=0;a<8;a++)X(s,n,t,r,a,1);break}}function ee(e,t,r){let o=e.current.attacks,s=e.current.board;for(let n=0;n<=8;n+=8){let a=n<<4,i=o[t|a|Mt];for(let c=0;c<8;c++)i&1<<c&&X(o,s,t,n,c,r)}}function X(e,t,r,o,s,n){let a=bt[s];for(;((r+=a)&136)==0&&(Ke(e,r,o,s,n),t[r]===l););}function st(e,t,r,o){if(t&136)return;let s=r<<4;e[t|s|jt]+=o}function Ke(e,t,r,o,s){let n=r<<4;s?e[t|n|Mt]|=1<<o:e[t|n|Mt]&=~(1<<o)}var re=8*8*2,K,G,lt=class{constructor(){L(this,K,0);L(this,G,[oe()]);this.current=p(this,G)[0]}reset(){w(this,K,0);let t=this.current=p(this,G)[0];t.board.fill(l),t.attacks.fill(0),t.clock=0,t.moveNum=0,t.ep=136,t.status=j,t.turn=u,t.seen={},t.castles=0,t.moveCache[u]=null,t.moveCache[m]=null,t.pieceList=[]}set(t,r){q((t&136)==0,"Invalid set() coord");let o=this.current.board[t];if(o!==l){let s=d(o),n=C(o);Jt(this,t,s,n)}if(this.current.board[t]=r,r!==l){let s=d(r),n=C(r);te(this,t,s,n)}if(o===l!=(r===l)){let s=this.current.pieceList;if(o===l)s.push(t);else{let n=s.indexOf(t),a=s.length-1;if(n!==a){let i=s[a];s[a]=t,s[n]=i}s.pop()}}}get(t){return q((t&136)==0,"Invalid get() coord"),this.current.board[t]}putBoardHash(t){for(let r=p(this,K);r>=0;r--)if(t in p(this,G)[r].seen){let o=1+p(this,G)[r].seen[t];return this.current.seen[t]=o,o}return this.current.seen[t]=1,1}removeBoardHash(t){for(let r=p(this,K);r>=0;r--)if(t in p(this,G)[r].seen){this.current.seen[t]--;return}}save(){let t=w(this,K,+p(this,K)+1);t===p(this,G).length&&p(this,G).push(oe()),this.current=p(this,G)[t],De(p(this,G)[t-1],this.current)}restore(){if(p(this,K)>0){let t=w(this,K,+p(this,K)-1);this.current=p(this,G)[t]}}getPriorState(){let t=this.current;return{clock:t.clock,moveNum:t.moveNum,ep:t.ep,status:t.status,castles:t.castles}}};K=new WeakMap,G=new WeakMap;function oe(){return{board:new Uint8Array(re).fill(l),attacks:new Uint8Array(re*2).fill(0),clock:0,moveNum:1,ep:136,status:j,turn:u,seen:{},castles:0,moveCache:{[u]:null,[m]:null},pieceList:[]}}function De(e,t){t.board.set(e.board),t.attacks.set(e.attacks),t.clock=e.clock,t.moveNum=e.moveNum,t.ep=e.ep,t.status=e.status,t.turn=e.turn,t.seen={},t.castles=e.castles,t.moveCache[u]=e.moveCache[u],t.moveCache[m]=e.moveCache[m],t.pieceList=e.pieceList.slice()}var Ue=" PBNRQK  pbnrqk";function nt(e){let t="",r=0;for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);if(i===l){r++;continue}r&&(t+=r,r=0);let c=i&15;t+=Ue[c]}r&&(t+=r),t+=";";let o=e.current.castles;return t+=ft(N(o,u,!0)),t+=ft(N(o,u,!1)),t+=ft(N(o,m,!0)),t+=ft(N(o,m,!1)),t+=";"+ft((e.current.ep||136)&15),t}function ft(e){return e&8?"-":String(e)}var se=[h,M,S,A,k,S,M,h],ne=Array(8).fill(_);function At(){let e=new lt;return _t(e,u,0,se),_t(e,u,16,ne),_t(e,m,96,ne),_t(e,m,112,se),e.current.castles=St(0,7,112,119),e.putBoardHash(nt(e)),e}function _t(e,t,r,o){for(let s=0;s<8;s++)e.set(r|s,ct(o[s],t,!1))}function ae(e,t,r,o){return W(e,t,r,0,0,0,0,0,0,0,o)}function ie(e,t,r,o,s,n){return W(e,t,r,o,s,0,0,0,0,0,n)}function Lt(e,t,r,o,s,n,a){return W(e,t,r,0,0,o,s,n,0,0,a)}function W(e,t,r,o,s,n,a,i,c,f,E){return{what:e,from:t,dest:r,capture:o,captureCoord:s,castleRook:n,castleRookFrom:a,castleRookDest:i,promote:c,markEnPassant:f,prior:E}}function ce(e,t){return Ut(tt({},e),{promote:t})}function D(e,t){let r=e.current;r.ep=136;let o=Rt(t.what),s=d(o),n=C(o);n===k&&(r.castles=Vt(r.castles,s)),n===h&&!rt(t.what)&&(r.castles=Bt(r.castles,t.from)),t.markEnPassant&&(r.ep=t.markEnPassant),t.promote&&(o=$t(o,t.promote)),e.set(t.dest,o),e.set(t.from,l),t.capture&&t.captureCoord!==t.dest&&e.set(t.captureCoord,l),t.castleRook&&(e.set(t.castleRookDest,Rt(t.castleRook)),e.set(t.castleRookFrom,l)),d(o)&&r.moveNum++,t.capture||C(t.what)===_?r.clock=0:r.clock++,t.capture&&C(t.capture)===h&&!rt(t.capture)&&(r.castles=Bt(r.castles,t.captureCoord)),r.moveCache[u]=null,r.moveCache[m]=null,r.turn=8-r.turn}function mt(e,t){let r=8-t;for(let o of e.current.pieceList){let s=e.get(o);if(!(C(s)!==k||d(s)!==t)&&zt(e,o,r))return!0}return!1}var It=[16,1,-16,-1,17,-15,-17,15],Fe=[31,33,14,18,-18,-14,-33,-31],We=[-1,1],$e=[A,h,M,S];function b(e,t){let r=e.current.moveCache[t];if(r)return r.slice();let o=[];for(let s of e.current.pieceList){let n=e.get(s);d(n)===t&&Yt(e,s,o)}return e.current.moveCache[t]=o,o}function Yt(e,t,r=[]){let o=e.get(t),s=e.getPriorState();switch(q(o!==l,"Listing moves of empty space"),e.save(),e.set(t,l),C(o)){case S:dt(e,o,t,It,4,8,8,r,s);break;case h:dt(e,o,t,It,0,4,8,r,s);break;case A:dt(e,o,t,It,0,8,8,r,s);break;case M:dt(e,o,t,Fe,0,8,1,r,s);break;case k:dt(e,o,t,It,0,8,1,r,s),He(e,o,t,r,s);break;case _:Qe(e,o,t,r,s);break}return e.restore(),r}function dt(e,t,r,o,s,n,a,i,c){let f=d(t),E=8-f;for(let I=s;I<n;I++){let y=o[I];for(let g=r+y,O=0;(g&136)==0&&O<a;g+=y,O++){let J=e.get(g);if(J===l){Z(e,i,ae(t,r,g,c));continue}d(J)===E&&Z(e,i,ie(t,r,g,J,g,c));break}}}function He(e,t,r,o,s){if(rt(t))return;let n=d(t),a=e.current.castles,i=N(a,n,!0),c=N(a,n,!1),f=r&240;if((i&8)==0){let E=f|6,I=f|i,y=f|5;pe(e,o,Lt(t,r,E,e.get(I),I,y,s))}if((c&8)==0){let E=f|2,I=f|c,y=f|3;pe(e,o,Lt(t,r,E,e.get(I),I,y,s))}}function Qe(e,t,r,o,s){let n=d(t),a=8-n,i=n===u?1:-1,c=r+16*i,f=r+32*i;if(c&136)return o;let E=f&136?A:0;e.get(c)===l&&(Z(e,o,W(t,r,c,0,0,0,0,0,E,0,s)),!rt(t)&&(f&136)==0&&e.get(f)===l&&Z(e,o,W(t,r,f,0,0,0,0,0,0,c,s)));let I=e.current.ep;for(let y of We){let g=c+y;if(g&136)continue;let O=e.get(g);if(g===I){let J=r+y,Me=e.get(J);Z(e,o,W(t,r,g,Me,J,0,0,0,E,0,s))}else O!==l&&d(O)===a&&Z(e,o,W(t,r,g,O,g,0,0,0,E,0,s))}return o}function Z(e,t,r){let o=d(r.what);if(e.save(),D(e,r),!mt(e,o))if(r.promote)for(let s of $e)t.push(ce(r,s));else t.push(r);e.restore()}function pe(e,t,r){let o=d(r.what),s=Math.min(r.castleRookFrom,r.castleRookDest,r.from,r.dest),n=Math.max(r.castleRookFrom,r.castleRookDest,r.from,r.dest);for(let f=s;f<=n;f++){if(f===r.from||f===r.castleRookFrom)continue;if(e.get(f)!==l)return}e.save(),e.set(r.from,l),e.set(r.castleRookFrom,l);let a=Math.min(r.from,r.dest),i=Math.max(r.from,r.dest);for(let f=a;f<=i;f++)e.set(f,r.what);let c=mt(e,o);e.restore(),!c&&Z(e,t,r)}function ue(e){let t=0,r=Array(8).fill(0),o=0;for(let a of e.current.pieceList){let i=e.get(a),c=C(i);if(c===_||c===h||c===A)return!1;t++,c===S&&(o+=(a>>>4^a)&1),r[c]++}if(t===2)return!0;let s=r[S],n=r[M];return t===3&&(s===1||n===1)||t===s+2&&(o===0||o===s)}function U(e,t){let r=8-t,o=mt(e,r),s=b(e,r).length>0,n=e.putBoardHash(nt(e)),a=Ve(e,o,s,n);return{enemyInCheck:o,enemyCanMove:s,newGameStatus:a}}function Ve(e,t,r,o){let s=e.current.status;return r?e.current.clock>=100?yt:o>=3?Pt:ue(e)?gt:s:t?pt:ot}var qe=/[1-8]/,je=/[PBNRQK]/,Xe=/[pbnrqk]/,Ze=/^((?:[pbnrqkPBNRQK1-8]{1,8}\/){7}[pbnrqkPBNRQK1-8]{1,8})\s+([wb])\s+(K?Q?k?q?|-)\s+([a-h][36]|-)\s+(\d+)\s+(\d+)$/;function kt(e,t){t&&t.reset();let r=t||new lt;e=e.trim();let o=e.match(Ze);if(!o)throw new T("Bad FEN string");let s=o[1].split("/");for(let i=7;i>=0;i--){let c=0,f=s[7-i];for(let E=0;E<8;E++){let I=i<<4|E;if(c>=f.length)throw new T(`Bad FEN string: Rank ${i+1} had less than 8 files`);let y=f[c++];if(qe.test(y)){let g=parseInt(y,10);for(let O=0;O<g;O++)r.set(I+O,l);E+=g-1}else if(je.test(y)){let g=le(y);r.set(I,fe(u,g,i))}else if(Xe.test(y)){let g=le(y);r.set(I,fe(m,g,i))}}}let n=tr(o[2]);r.current.turn=n,r.current.castles=er(o[3]),o[4]!=="-"&&(r.current.ep=R(o[4])),r.current.clock=parseInt(o[5],10),r.current.moveNum=parseInt(o[6],10);let a=U(r,8-n);return r.current.status=a.newGameStatus,r}var ze={p:_,b:S,n:M,r:h,q:A,k};function le(e){return ze[e.toLowerCase()]}var Je={w:u,b:m};function tr(e){return Je[e]}function er(e){let t=136,r=136,o=136,s=136;if(e!=="-")for(let n=0;n<e.length;n++)switch(e[n]){case"K":r=7;break;case"Q":t=0;break;case"k":s=119;break;case"q":o=112;break}return St(t,r,o,s)}function fe(e,t,r){return t===_?ct(t,e,!(r===1&&e===u||r===6&&e===m)):ct(t,e,!1)}var me={"":_,B:S,N:M,R:h,Q:A,K:k},rr=/^(O-O(?:-O)?|0-0(?:-0)?)(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|½)-(?:1|0|1\/2|½))*$/,or=/^([BNRQK]?)([a-h]?)([1-8]?)(x?)([a-h][1-8])(?:=([BNRQ]))?(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|½)-(?:1|0|1\/2|½))*$/;function vt(e,t){t=t.trim();let r=t.match(rr);if(r)return de(e,t,r[1].length===5?n=>(n.castleRookDest&7)==3:n=>(n.castleRookDest&7)==5);let o=t.match(or);if(!o)throw new x(`Couldn't parse: ${t}`);return de(e,t,n=>R(o[5])===n.dest&&C(n.what)===me[o[1]]&&(o[2]?(n.from&7)==o[2].charCodeAt(0)-97:!0)&&(o[3]?(n.from>>>4&7)==o[3].charCodeAt(0)-49:!0)&&(o[4]?n.capture!==0:n.capture===0)&&(o[6]?n.promote===me[o[6]]:!0))}function de(e,t,r){let o=null;for(let s=0;s<e.length;s++){let n=e[s];if(r(n)){if(o)throw o.promote&&n.promote?new V:new x(`${t} is ambiguous`);o=n}}if(o)return o;throw new x(`${t} is not a valid move`)}function wt(e,t,r){let o;if(t.castleRook)o=t.castleRookFrom<t.from?"O-O-O":"O-O";else{let n=sr(e,t),a=Ee(C(t.what)),i=t.capture?"x":"",c=v(t.dest),f=t.promote?"="+Ee(t.promote):"";o=`${a}${n}${i}${c}${f}`}let s=r?nr(r):"";return`${o}${s}`}function sr(e,t){let r=v(t.from);if(C(t.what)===_&&t.capture)return r[0];let o=e.filter(a=>a.from!==t.from&&a.dest===t.dest&&C(a.what)===C(t.what));if(!o.length)return"";let[s,n]=it(t.from);return o.every(a=>it(a.from)[0]!==s)?r[0]:o.every(a=>it(a.from)[1]!==n)?r[1]:r}function Ee(e){switch(e){case S:return"B";case M:return"N";case h:return"R";case A:return"Q";case k:return"K";default:return""}}function nr(e){return e.enemyInCheck?e.enemyCanMove?"+":"#":""}var ar=/^([a-h][1-8])[- ]*([a-h][1-8])([bnrqBNRQ])?$/,Ce={N:M,B:S,R:h,Q:A};function he(e,t){if(typeof t=="object")return pr(e,t);let r=t.match(ar);return r?ir(e,r[1],r[2],r[3]):cr(e,t)}function ir(e,t,r,o){let s=R(t),n=R(r),a=0;if(o&&(a=Ce[o.toUpperCase()],!a))throw new x(`Invalid promotion: ${o}`);let i=e.current.turn,c=b(e,i),f=c.find(y=>y.from===s&&y.dest===n&&(a?y.promote===a:!0));if(!f)throw new x(`Invalid move: ${t}${r}${o||""}`);if(f.promote&&!a)throw new V;let E=e.current.moveNum;D(e,f);let I=U(e,i);return e.current.status=I.newGameStatus,{num:E,side:i===u?"white":"black",from:t,dest:r,san:wt(c,f,I),move:f}}function cr(e,t){let r=e.current.turn,o=b(e,r),s=vt(o,t),n=e.current.moveNum;D(e,s);let a=U(e,r);return e.current.status=a.newGameStatus,{num:n,side:r===u?"white":"black",from:v(s.from),dest:v(s.dest),san:wt(o,s,a),move:s}}function pr(e,t){let r=R(t.from),o=R(t.dest),s=0;if(t.promotion&&(s=Ce[t.promotion.toUpperCase()],!s))throw new x(`Invalid promotion: ${t.promotion}`);let n=e.current.moveNum,a=e.current.turn,i=b(e,a),c=i.find(E=>E.from===r&&E.dest===o&&(s?E.promote===s:!0));if(!c)throw new x(`Invalid move: ${JSON.stringify(t)}`);if(c.promote&&!s)throw new V;D(e,c);let f=U(e,a);return e.current.status=f.newGameStatus,{num:n,side:a===u?"white":"black",from:v(c.from),dest:v(c.dest),san:wt(i,c,f),move:c}}var ur=/^[A-Z][a-zA-Z0-9_]*$/,lr=/^[\u0020-\u007e]*$/;function z(e,t){if(!ur.test(e))throw new Q("Invalid PGN tag name: "+e);if(!lr.test(t))throw new Q("Invalid characters in PGN tag value")}var fr=/^(1-0|0-1|1\/2-1\/2)$/;function Te(e){var a;let t=vr(e),r={},o=[];for(;((a=t[0])==null?void 0:a.type)==="[";)mr(t,r);let s=r.SetUp==="1"&&r.FEN?kt(r.FEN):At();dr(t,s,o);let n=Er(t,s);if(r.Result&&n!==r.Result)throw new T("PGN Result tag has an incorrect game status");return{board:s,tags:r,moves:o,winner:hr(n)}}function mr(e,t){let r=e.shift();Et(r,"[");let o=e.shift();Et(o,"Sym");let s=e.shift();Et(s,"Str");let n=e.shift();if(Et(n,"]"),z(o.value,s.value),t[o.value])throw new T("Duplicate PGN tag: "+o.value);t[o.value]=s.value}function dr(e,t,r){for(;;){let o=e.shift();if(!o)throw new T("PGN move list didn't have a conclusion");if(o.type==="Int"){if(t.current.moveNum!==o.value)throw new T(`PGN move list expected it to be turn ${o.value}, but the board is on ${t.current.moveNum}'`);continue}if(o.type!=="."&&o.type!=="Nag"){if(o.type==="*"){e.unshift(o);break}if(o.type==="("){let s=1;for(;s;){let n=e.shift();if(!n)throw new T("PGN move list didn't have a conclusion");n.type==="("?s++:n.type===")"&&s--}continue}if(o.type==="Sym"){if(fr.test(o.value)){e.unshift(o);break}Cr(t,r,o.value);continue}throw new T(`PGN data had unexpected data in the move list: ${Se(o)}`)}}}function Er(e,t){let r=e.shift();if(!r)throw new T("PGN move list didn't have a conclusion");if(e.length)throw new T("PGN had extra moves after game ended");if(r.type==="*")return"*";Et(r,"Sym");let o=r;switch(o.value){case"1-0":case"0-1":return t.current.status===j&&(t.current.status=ut),o.value;case"1/2-1/2":{let s=U(t,8-t.current.turn);return t.current.status=s.newGameStatus>=F?s.newGameStatus:F,o.value}default:throw new T(`PGN had an unexpected game end: ${o.value}`)}}function Cr(e,t,r){let o=e.current.turn,s=b(e,o),n=vt(s,r);t.push({num:e.current.moveNum,turn:e.current.turn,move:n,san:r}),D(e,n);let a=U(e,o);e.current.turn=8-o,(a.newGameStatus<F||a.newGameStatus===ot)&&(e.current.status=a.newGameStatus)}function hr(e){switch(e){case"1-0":return"white";case"0-1":return"black";case"1/2-1/2":return"draw";default:return null}}var Tr=/(?:^|\n)%[^\n]*/g,Sr=/^\s+/,Pr=/^(?:;[^\n]*\n|\{[^}]*\})/,yr=/^[\[\]().*]/,gr=/^"(?:[^\\"]|\\.)*"/,Mr=/^([a-z0-9][-a-z0-9_+#=:/]*)[!?]{0,2}/i,Ar=/^\$\d+/,_r=/^\d+$/,Ir=/\\(.)/g,kr=/[^\x20-\x7e]/;function vr(e){let t=e.replace(Tr,"")+`
`,r=[];for(;t;){let o;if(o=t.match(Sr)||t.match(Pr),o){t=t.slice(o[0].length);continue}if(o=t.match(yr),o){let s=o[0];r.push({type:s}),t=t.slice(s.length);continue}if(o=t.match(Mr),o){let s=o[0],n=o[1];_r.test(n)?r.push({type:"Int",value:parseInt(n,10)}):r.push({type:"Sym",value:n}),t=t.slice(s.length);continue}if(o=t.match(gr),o){let s=o[0];r.push({type:"Str",value:wr(s)}),t=t.slice(s.length);continue}if(o=t.match(Ar),o){let s=o[0];r.push({type:"Nag",value:parseInt(s.slice(1),10)}),t=t.slice(s.length);continue}throw t.startsWith('"')?new T("PGN string reached the end"):new T(`PGN had unexpected data: ${t.slice(0,10)}`)}return r}function wr(e){let t=e.slice(1,-1).replace(Ir,(r,o)=>{if(o!=="\\"&&o!=='"')throw new T(`Invalid PGN string escape: ${JSON.stringify(r)}`);return o});if(kr.test(t))throw new T("PGN strings can only contain printable ASCII characters");if(t.length>=256)throw new T("PGN strings must be 255 chars or less");return t}function Et(e,t){(!e||e.type!==t)&&new T(`Expected a '${t}' token, but got ${Se(e)}.`)}function Se(e){if(!e)return"the end-of-file";switch(e.type){case"[":case"]":case"(":case")":case".":case"*":return`a '${e.type}`;case"Int":return`the Integer '${e.value}'`;case"Str":return`the String '${e.value}'`;case"Sym":return`the Symbol '${e.value}'`;case"Nag":return`the NAG Code $${e.value}`;default:return`the unknown symbol: ${JSON.stringify(e)}`}}var Nr=80;function Pe({winner:e,moves:t,tags:r}){let o=Rr(e);r=tt({Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:o},r);let s="";for(let i of Object.keys(r))s+=Gr(i,r[i])+`
`;let n=1e3;function a(i){n+i.length+1>Nr?(n=i.length,s+=`
`+i):(n+=i.length+1,s+=" "+i)}for(let i=0;i<t.length;i++){let c=t[i];(!i||c.side==="white")&&a(`${c.num}${c.side==="white"?".":"..."}`),a(c.san)}return a(o),s}function Gr(e,t){return z(e,t),t=t.replace(/["\\]/g,"\\$&"),`[${e} "${t}"]`}function Rr(e){switch(e){case"white":return"1-0";case"black":return"0-1";case"draw":return"1/2-1/2";default:return"*"}}function ye(e,t){let r=nt(e);e.removeBoardHash(r);let o=e.current;e.set(t.from,t.what),e.set(t.dest,l),t.capture&&e.set(t.captureCoord,t.capture),t.castleRook&&(e.set(t.castleRookDest,l),e.set(t.castleRookFrom,t.castleRook));let s=t.prior;o.clock=s.clock,o.moveNum=s.moveNum,o.ep=s.ep,o.status=s.status,o.castles=s.castles,o.turn=8-o.turn,o.moveCache[u]=null,o.moveCache[m]=null}var xr={[j]:"active",[pt]:"checkmate",[ut]:"resigned",[F]:"draw-other",[ot]:"draw-stalemate",[Pt]:"draw-repetition",[yt]:"draw-fifty-moves",[gt]:"draw-no-material"},P,$,B,at,H,Ct=class{constructor(t){L(this,P,void 0);L(this,$,[]);L(this,B,null);L(this,at,null);L(this,H,{});w(this,P,t),this.setTag("Date",new Date)}static NewStandardGame(){return new Ct(At())}static NewFromFEN(t){let r=new Ct(kt(t));return r.maybeRefreshWinner(),r.setTag("SetUp",!0),r.setTag("FEN",t),r}static NewFromPGN(t){let r=Te(t),o=new Ct(r.board);return w(o,H,r.tags),p(o,$).push(...r.moves.map(s=>({num:s.num,side:s.turn===u?"white":"black",from:v(s.move.from),dest:v(s.move.dest),san:s.san,move:s.move}))),r.winner&&w(o,B,r.winner),o}getSpace(t){let r=R(t),o=p(this,P).get(r),s={coord:t};return o!==l&&(s.piece={color:d(o)===u?"white":"black",pieceType:Ot(C(o))}),s}getTags(){return tt({},p(this,H))}setTag(t,r){if(r==null){z(t,""),delete p(this,H)[t];return}let o;typeof r=="boolean"?o=r?"1":"0":r instanceof Date?o=isNaN(r.valueOf())?"????.??.??":[r.getFullYear(),String(r.getMonth()+1).padStart(2,"0"),String(r.getDate()).padStart(2,"0")].join("."):o=String(r),z(t,o),p(this,H)[t]=o}history(){return p(this,$).map(t=>({num:t.num,side:t.side,from:t.from,dest:t.dest,san:t.san}))}getStatus(){let t=p(this,P).current,r={state:xr[t.status],turn:t.turn===u?"white":"black"};return p(this,B)&&(r.winner=p(this,B)),p(this,at)&&(r.reason=p(this,at)),r}isGameOver(){return Boolean(p(this,P).current.status)}move(t){if(this.isGameOver())throw new et;let r=he(p(this,P),t);return p(this,$).push(r),this.maybeRefreshWinner(),this}undoMove(){let t=p(this,$).pop();return t&&(ye(p(this,P),t.move),w(this,B,null)),this}allMoves(t){if(this.isGameOver())return[];let r=p(this,P).current.turn,o;if(t==null)o=b(p(this,P),r);else{let s=R(t),n=p(this,P).get(s);if(n===l||d(n)!==r)return[];o=Yt(p(this,P),s)}return o.map(s=>{let n=v(s.from),a=v(s.dest);return s.promote?{from:n,dest:a,promotion:Ot(s.promote)}:{from:n,dest:a}})}resignGame(t){if(this.isGameOver())throw new et;p(this,P).current.status=ut,w(this,B,t==="white"?"black":"white")}drawGame(t){if(this.isGameOver())throw new et;p(this,P).current.status=F,t&&w(this,at,t)}toString(t="ascii"){switch(t){case"ascii":return xt(p(this,P),!1);case"terminal":return xt(p(this,P),!0);case"fen":return qt(p(this,P));case"pgn":return Pe({board:p(this,P),winner:p(this,B),moves:p(this,$),tags:p(this,H)});default:throw new Q(t)}}maybeRefreshWinner(){let t=p(this,P).current.status,r=p(this,P).current.turn;t===pt?w(this,B,r===u?"black":"white"):t>=F&&w(this,B,"draw")}},ge=Ct;P=new WeakMap,$=new WeakMap,B=new WeakMap,at=new WeakMap,H=new WeakMap;return Br;})();
