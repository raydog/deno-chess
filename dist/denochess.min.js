/*! Deno-Chess 0.4.0, (c) 2021, license: MIT */
var DenoChess=(()=>{var wt=Object.defineProperty,Ae=Object.defineProperties;var _e=Object.getOwnPropertyDescriptors;var Yt=Object.getOwnPropertySymbols;var Ie=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var Kt=(e,t,r)=>t in e?wt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,J=(e,t)=>{for(var r in t||(t={}))Ie.call(t,r)&&Kt(e,r,t[r]);if(Yt)for(var r of Yt(t))ke.call(t,r)&&Kt(e,r,t[r]);return e},Ut=(e,t)=>Ae(e,_e(t)),ve=e=>wt(e,"__esModule",{value:!0});var Ft=(e,t)=>{ve(e);for(var r in t)wt(e,r,{get:t[r],enumerable:!0})};var Dt=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var c=(e,t,r)=>(Dt(e,t,"read from private field"),r?r.call(e):t.get(e)),O=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},v=(e,t,r,o)=>(Dt(e,t,"write to private field"),o?o.call(e,r):t.set(e,r),r);var Gr={};Ft(Gr,{ChessGame:()=>ge,errors:()=>ht});var l=0,d=8;var ht={};Ft(ht,{ChessBadInput:()=>Q,ChessBadMove:()=>B,ChessError:()=>b,ChessGameOver:()=>tt,ChessNeedsPromotion:()=>Ct,ChessParseError:()=>h});var b=class extends Error{},tt=class extends b{constructor(){super("Game is over")}},Q=class extends b{constructor(t){super(`Unexpected input: ${t}`)}},B=class extends b{constructor(t){super("Bad move: "+t)}},Ct=class extends b{constructor(){super("Promotion piece is required for this move")}},h=class extends b{};function V(e,t){if(!e)throw new b(t)}var we=/^[a-h][1-8]$/i,Ne="abcdefgh",xe="12345678",at=e=>[e&7,e>>>4],Nt=(e,t)=>(t&7)<<4|e&7,L=e=>{V(we.test(e),"Invalid coord");let t=e.toLowerCase(),r=t.charCodeAt(0)-97,o=t.charCodeAt(1)-49;return Nt(r,o)},w=e=>{let[t,r]=at(e);return Ne[t]+xe[r]};var Re=(e,t)=>e|t,Ge=["","P","B","N","R","Q","K","","","p","b","n","r","q","k"];var u=0;function T(e){return e&7}function E(e){return e&8}function et(e){return Boolean(e&16)}function xt(e){return e===u?e:e|16}function Wt(e,t){return e===u?e:e&248|t&7}var it=(e,t,r=!1)=>e|t|Number(r)<<4;function Tt(e){if(e===u)return" ";let t=Re(E(e),T(e));return Ge[t]}var $t=`   +------------------------+  
`,Ht="     a  b  c  d  e  f  g  h    ",Be={dim:e=>`[2m${e}[22m`,black:e=>`[30;2m${e}[39;22m`,darkBg:e=>`[44m${e}[49m`,lightBg:e=>`[46m${e}[49m`},Oe={dim:e=>e,black:e=>e,darkBg:e=>e,lightBg:e=>e};function Rt(e,t){let r=t?Be:Oe,o=r.dim(Ht)+`
`+$t;for(let s=7;s>=0;s--){let n=` ${r.dim(String(s+1))} |`;for(let a=0;a<8;a++){let i=Nt(a,s),p=e.get(i);n+=be(r,i,p)}o+=n+`| ${r.dim(String(s+1))}
`}return o+$t+r.dim(Ht)}function be(e,t,r){let o;if(r===u)o=e.dim("   ");else{let s=" "+Tt(r)+" ";o=E(r)===l?s:e.black(s)}return((t>>>4^t)&1)==0?e.darkBg(o):e.lightBg(o)}function St(e,t,r,o){return t&15|(e&15)<<4|(o&15)<<8|(r&15)<<12}function Qt(e,t){return t===l?e&65280|136:e&255|34816}function Gt(e,t){let r=t<64?0:8,o=r+4,s=t&15;if((e>>>r&15)===s){let n=e&~(15<<r),a=8<<r;return n|a}if((e>>>o&15)===s){let n=e&~(15<<o),a=8<<o;return n|a}return e}function N(e,t,r){let o=t+(r?0:4);return e>>>o&15}function Vt(e){let t="";for(let s=112;s>=0;s-=16){let n=0;for(let a=0;a<8;a++){let i=s|a,p=e.get(i);if(p===u){n++;continue}n&&(t+=n,n=0),t+=Tt(p)}n&&(t+=n),s&&(t+="/")}t+=e.current.turn===l?" w":" b";let r=e.current.castles;t+=" "+Le(r);let o=e.current.ep;return t+=o&136?" -":" "+w(o),t+=" "+e.current.clock,t+=" "+e.current.moveNum,t}function Le(e){let t="";return t+=N(e,l,!0)&8?"":"K",t+=N(e,l,!1)&8?"":"Q",t+=N(e,d,!0)&8?"":"k",t+=N(e,d,!1)&8?"":"q",t||"-"}var q=0,ct=10,pt=11,U=20,rt=21,Pt=22,yt=23,gt=24;var I=1,S=2,g=3,C=4,M=5,k=6,Ye={[I]:"P",[S]:"B",[g]:"N",[C]:"R",[M]:"Q",[k]:"K"};function qt(e){return Ye[e]}var Xt=0,Mt=8,Bt=[16,1,-16,-1,17,-15,-17,15],jt=[31,33,14,18,-18,-14,-33,-31],Zt={[l]:[15,17],[d]:[-15,-17]};function zt(e,t,r){let o=e.current.attacks,s=r<<4;return Boolean(o[t|s|Mt]||o[t|s|Xt])}function Jt(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(o){case I:for(let a of Zt[r])ot(s,t+a,r,-1);break;case g:for(let a of jt)ot(s,t+a,r,-1);break;case k:for(let a of Bt)ot(s,t+a,r,-1);break;case S:for(let a=4;a<8;a++)X(s,n,t,r,a,0);break;case C:for(let a=0;a<4;a++)X(s,n,t,r,a,0);break;case M:for(let a=0;a<8;a++)X(s,n,t,r,a,0);break}ee(e,t,1)}function te(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(ee(e,t,0),o){case I:for(let a of Zt[r])ot(s,t+a,r,1);break;case g:for(let a of jt)ot(s,t+a,r,1);break;case k:for(let a of Bt)ot(s,t+a,r,1);break;case S:for(let a=4;a<8;a++)X(s,n,t,r,a,1);break;case C:for(let a=0;a<4;a++)X(s,n,t,r,a,1);break;case M:for(let a=0;a<8;a++)X(s,n,t,r,a,1);break}}function ee(e,t,r){let o=e.current.attacks,s=e.current.board;for(let n=0;n<=8;n+=8){let a=n<<4,i=o[t|a|Mt];for(let p=0;p<8;p++)i&1<<p&&X(o,s,t,n,p,r)}}function X(e,t,r,o,s,n){let a=Bt[s];for(;((r+=a)&136)==0&&(Ke(e,r,o,s,n),t[r]===u););}function ot(e,t,r,o){if(t&136)return;let s=r<<4;e[t|s|Xt]+=o}function Ke(e,t,r,o,s){let n=r<<4;s?e[t|n|Mt]|=1<<o:e[t|n|Mt]&=~(1<<o)}var re=8*8*2,Y,x,ut=class{constructor(){O(this,Y,0);O(this,x,[oe()]);this.current=c(this,x)[0]}reset(){v(this,Y,0);let t=this.current=c(this,x)[0];t.board.fill(u),t.attacks.fill(0),t.clock=0,t.moveNum=0,t.ep=136,t.status=q,t.turn=l,t.seen={},t.castles=0,t.moveCache[l]=null,t.moveCache[d]=null}set(t,r){V((t&136)==0,"Invalid set() coord");let o=this.current.board[t];if(o!==u){let s=E(o),n=T(o);Jt(this,t,s,n)}if(this.current.board[t]=r,r!==u){let s=E(r),n=T(r);te(this,t,s,n)}}get(t){return V((t&136)==0,"Invalid get() coord"),this.current.board[t]}putBoardHash(t){for(let r=c(this,Y);r>=0;r--)if(t in c(this,x)[r].seen){let o=1+c(this,x)[r].seen[t];return this.current.seen[t]=o,o}return this.current.seen[t]=1,1}removeBoardHash(t){for(let r=c(this,Y);r>=0;r--)if(t in c(this,x)[r].seen){this.current.seen[t]--;return}}save(){let t=v(this,Y,+c(this,Y)+1);t===c(this,x).length&&c(this,x).push(oe()),this.current=c(this,x)[t],Ue(c(this,x)[t-1],this.current)}restore(){if(c(this,Y)>0){let t=v(this,Y,+c(this,Y)-1);this.current=c(this,x)[t]}}getPriorState(){let t=this.current;return{clock:t.clock,moveNum:t.moveNum,ep:t.ep,status:t.status,castles:t.castles}}};Y=new WeakMap,x=new WeakMap;function oe(){return{board:new Uint8Array(re).fill(u),attacks:new Uint8Array(re*2).fill(0),clock:0,moveNum:1,ep:136,status:q,turn:l,seen:{},castles:0,moveCache:{[l]:null,[d]:null}}}function Ue(e,t){t.board.set(e.board),t.attacks.set(e.attacks),t.clock=e.clock,t.moveNum=e.moveNum,t.ep=e.ep,t.status=e.status,t.turn=e.turn,t.seen={},t.castles=e.castles,t.moveCache[l]=e.moveCache[l],t.moveCache[d]=e.moveCache[d]}var Fe=" PBNRQK  pbnrqk";function st(e){let t="",r=0;for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);if(i===u){r++;continue}r&&(t+=r,r=0);let p=i&15;t+=Fe[p]}r&&(t+=r),t+=";";let o=e.current.castles;return t+=lt(N(o,l,!0)),t+=lt(N(o,l,!1)),t+=lt(N(o,d,!0)),t+=lt(N(o,d,!1)),t+=";"+lt((e.current.ep||136)&15),t}function lt(e){return e&8?"-":String(e)}var se=[C,g,S,M,k,S,g,C],ne=Array(8).fill(I);function At(){let e=new ut;return _t(e,l,0,se),_t(e,l,16,ne),_t(e,d,96,ne),_t(e,d,112,se),e.current.castles=St(0,7,112,119),e.putBoardHash(st(e)),e}function _t(e,t,r,o){for(let s=0;s<8;s++)e.set(r|s,it(o[s],t,!1))}function ae(e,t,r,o){return F(e,t,r,0,0,0,0,0,0,0,o)}function ie(e,t,r,o,s,n){return F(e,t,r,o,s,0,0,0,0,0,n)}function Ot(e,t,r,o,s,n,a){return F(e,t,r,0,0,o,s,n,0,0,a)}function F(e,t,r,o,s,n,a,i,p,m,f){return{what:e,from:t,dest:r,capture:o,captureCoord:s,castleRook:n,castleRookFrom:a,castleRookDest:i,promote:p,markEnPassant:m,prior:f}}function ce(e,t){return Ut(J({},e),{promote:t})}function D(e,t){let r=e.current;r.ep=136;let o=xt(t.what),s=E(o),n=T(o);n===k&&(r.castles=Qt(r.castles,s)),n===C&&!et(t.what)&&(r.castles=Gt(r.castles,t.from)),t.markEnPassant&&(r.ep=t.markEnPassant),t.promote&&(o=Wt(o,t.promote)),e.set(t.dest,o),e.set(t.from,u),t.capture&&t.captureCoord!==t.dest&&e.set(t.captureCoord,u),t.castleRook&&(e.set(t.castleRookDest,xt(t.castleRook)),e.set(t.castleRookFrom,u)),E(o)&&r.moveNum++,t.capture||T(t.what)===I?r.clock=0:r.clock++,t.capture&&T(t.capture)===C&&!et(t.capture)&&(r.castles=Gt(r.castles,t.captureCoord)),r.moveCache[l]=null,r.moveCache[d]=null,r.turn=8-r.turn}function mt(e,t){let r=8-t;for(let o=0;o<128;o+=16)for(let s=0;s<8;s++){let n=o|s,a=e.get(n);if(!(a===u||T(a)!==k||E(a)!==t)&&zt(e,n,r))return!0}return!1}var It=[16,1,-16,-1,17,-15,-17,15],De=[31,33,14,18,-18,-14,-33,-31],We=[-1,1],$e=[M,C,g,S];function K(e,t){let r=e.current.moveCache[t];if(r)return[...r];let o=[];for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,i=e.get(a);i!==u&&E(i)===t&&bt(e,a,o)}return e.current.moveCache[t]=o,o}function bt(e,t,r=[]){let o=e.get(t),s=e.getPriorState();switch(V(o!==u,"Listing moves of empty space"),e.save(),e.set(t,u),T(o)){case S:ft(e,o,t,It,4,8,8,r,s);break;case C:ft(e,o,t,It,0,4,8,r,s);break;case M:ft(e,o,t,It,0,8,8,r,s);break;case g:ft(e,o,t,De,0,8,1,r,s);break;case k:ft(e,o,t,It,0,8,1,r,s),He(e,o,t,r,s);break;case I:Qe(e,o,t,r,s);break}return e.restore(),r}function ft(e,t,r,o,s,n,a,i,p){let m=E(t),f=8-m;for(let _=s;_<n;_++){let P=o[_];for(let y=r+P,G=0;(y&136)==0&&G<a;y+=P,G++){let z=e.get(y);if(z===u){j(e,i,ae(t,r,y,p));continue}E(z)===f&&j(e,i,ie(t,r,y,z,y,p));break}}}function He(e,t,r,o,s){if(et(t))return;let n=E(t),a=e.current.castles,i=N(a,n,!0),p=N(a,n,!1),m=r&240;if((i&8)==0){let f=m|6,_=m|i,P=m|5;pe(e,o,Ot(t,r,f,e.get(_),_,P,s))}if((p&8)==0){let f=m|2,_=m|p,P=m|3;pe(e,o,Ot(t,r,f,e.get(_),_,P,s))}}function Qe(e,t,r,o,s){let n=E(t),a=8-n,i=n===l?1:-1,p=r+16*i,m=r+32*i;if(p&136)return o;let f=m&136?M:0;e.get(p)===u&&(j(e,o,F(t,r,p,0,0,0,0,0,f,0,s)),!et(t)&&(m&136)==0&&e.get(m)===u&&j(e,o,F(t,r,m,0,0,0,0,0,0,p,s)));let _=e.current.ep;for(let P of We){let y=p+P;if(y&136)continue;let G=e.get(y);if(y===_){let z=r+P,Me=e.get(z);j(e,o,F(t,r,y,Me,z,0,0,0,f,0,s))}else G!==u&&E(G)===a&&j(e,o,F(t,r,y,G,y,0,0,0,f,0,s))}return o}function j(e,t,r){let o=E(r.what);if(e.save(),D(e,r),!mt(e,o))if(r.promote)for(let s of $e)t.push(ce(r,s));else t.push(r);e.restore()}function pe(e,t,r){let o=E(r.what),s=Math.min(r.castleRookFrom,r.castleRookDest,r.from,r.dest),n=Math.max(r.castleRookFrom,r.castleRookDest,r.from,r.dest);for(let m=s;m<=n;m++){if(m===r.from||m===r.castleRookFrom)continue;if(e.get(m)!==u)return}e.save(),e.set(r.from,u),e.set(r.castleRookFrom,u);let a=Math.min(r.from,r.dest),i=Math.max(r.from,r.dest);for(let m=a;m<=i;m++)e.set(m,r.what);let p=mt(e,o);e.restore(),!p&&j(e,t,r)}function ue(e){let t=0,r=Array(8).fill(0),o=0;for(let a=0;a<128;a+=16)for(let i=0;i<8;i++){let p=a|i,m=e.get(p);if(m===u)continue;let f=T(m);if(f===I||f===C||f===M)return!1;t++,f===S&&(o+=(p>>>4^p)&1),r[f]++}if(t===2)return!0;let s=r[S],n=r[g];return t===3&&(s===1||n===1)||t===s+2&&(o===0||o===s)}function W(e,t){let r=8-t,o=mt(e,r),s=K(e,r).length>0,n=e.putBoardHash(st(e)),a=Ve(e,o,s,n);return{enemyInCheck:o,enemyCanMove:s,newGameStatus:a}}function Ve(e,t,r,o){let s=e.current.status;return r?e.current.clock>=100?yt:o>=3?Pt:ue(e)?gt:s:t?ct:rt}var qe=/[1-8]/,Xe=/[PBNRQK]/,je=/[pbnrqk]/,Ze=/^((?:[pbnrqkPBNRQK1-8]{1,8}\/){7}[pbnrqkPBNRQK1-8]{1,8})\s+([wb])\s+(K?Q?k?q?|-)\s+([a-h][36]|-)\s+(\d+)\s+(\d+)$/;function kt(e,t){t&&t.reset();let r=t||new ut;e=e.trim();let o=e.match(Ze);if(!o)throw new h("Bad FEN string");let s=o[1].split("/");for(let i=7;i>=0;i--){let p=0,m=s[7-i];for(let f=0;f<8;f++){let _=i<<4|f;if(p>=m.length)throw new h(`Bad FEN string: Rank ${i+1} had less than 8 files`);let P=m[p++];if(qe.test(P)){let y=parseInt(P,10);for(let G=0;G<y;G++)r.set(_+G,u);f+=y-1}else if(Xe.test(P)){let y=le(P);r.set(_,me(l,y,i))}else if(je.test(P)){let y=le(P);r.set(_,me(d,y,i))}}}let n=tr(o[2]);r.current.turn=n,r.current.castles=er(o[3]),o[4]!=="-"&&(r.current.ep=L(o[4])),r.current.clock=parseInt(o[5],10),r.current.moveNum=parseInt(o[6],10);let a=W(r,8-n);return r.current.status=a.newGameStatus,r}var ze={p:I,b:S,n:g,r:C,q:M,k};function le(e){return ze[e.toLowerCase()]}var Je={w:l,b:d};function tr(e){return Je[e]}function er(e){let t=136,r=136,o=136,s=136;if(e!=="-")for(let n=0;n<e.length;n++)switch(e[n]){case"K":r=7;break;case"Q":t=0;break;case"k":s=119;break;case"q":o=112;break}return St(t,r,o,s)}function me(e,t,r){return t===I?it(t,e,!(r===1&&e===l||r===6&&e===d)):it(t,e,!1)}var fe={"":I,B:S,N:g,R:C,Q:M,K:k},rr=/^(O-O(?:-O)?|0-0(?:-0)?)(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/,or=/^([BNRQK]?)([a-h]?)([1-8]?)(x?)([a-h][1-8])(?:=([BNRQ]))?(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/;function vt(e,t){t=t.trim();let r=t.match(rr);if(r)return de(e,t,r[1].length===5?n=>(n.castleRookDest&7)==3:n=>(n.castleRookDest&7)==5);let o=t.match(or);if(!o)throw new B(`Couldn't parse: ${t}`);return de(e,t,n=>L(o[5])===n.dest&&T(n.what)===fe[o[1]]&&(o[2]?(n.from&7)==o[2].charCodeAt(0)-97:!0)&&(o[3]?(n.from>>>4&7)==o[3].charCodeAt(0)-49:!0)&&(o[4]?n.capture!==0:n.capture===0)&&(o[6]?n.promote===fe[o[6]]:!0))}function de(e,t,r){let o=null;for(let s=0;s<e.length;s++){let n=e[s];if(r(n)){if(o)throw o.promote&&n.promote?new B(`${t} needs a promotion type`):new B(`${t} is ambiguous`);o=n}}if(o)return o;throw new B(`${t} is not a valid move`)}function Lt(e,t,r){let o;if(t.castleRook)o=t.castleRookFrom<t.from?"O-O-O":"O-O";else{let n=sr(e,t),a=Ee(T(t.what)),i=t.capture?"x":"",p=w(t.dest),m=t.promote?"="+Ee(t.promote):"";o=`${a}${n}${i}${p}${m}`}let s=r?nr(r):"";return`${o}${s}`}function sr(e,t){let r=w(t.from);if(T(t.what)===I&&t.capture)return r[0];let o=e.filter(a=>a.from!==t.from&&a.dest===t.dest&&T(a.what)===T(t.what));if(!o.length)return"";let[s,n]=at(t.from);return o.every(a=>at(a.from)[0]!==s)?r[0]:o.every(a=>at(a.from)[1]!==n)?r[1]:r}function Ee(e){switch(e){case S:return"B";case g:return"N";case C:return"R";case M:return"Q";case k:return"K";default:return""}}function nr(e){return e.enemyInCheck?e.enemyCanMove?"+":"#":""}var ar=/^([a-h][1-8])[- ]*([a-h][1-8])([bnrqBNRQ])?$/,ir={N:g,B:S,R:C,Q:M};function Ce(e,t){let r=t.match(ar);return r?cr(e,r[1],r[2],r[3]):pr(e,t)}function cr(e,t,r,o){let s=L(t),n=L(r),a=0;if(o&&(a=ir[o.toUpperCase()],!a))throw new B(`Invalid promotion: ${o}`);let i=e.current.turn,p=K(e,i),m=p.find(P=>P.from===s&&P.dest===n&&(a?P.promote===a:!0));if(!m)throw new B(`Invalid move: ${t}${r}${o||""}`);if(m.promote&&!a)throw new Ct;let f=e.current.moveNum;D(e,m);let _=W(e,i);return e.current.status=_.newGameStatus,{num:f,side:i===l?"white":"black",from:t,dest:r,san:Lt(p,m,_),move:m}}function pr(e,t){let r=e.current.turn,o=K(e,r),s=vt(o,t),n=e.current.moveNum;D(e,s);let a=W(e,r);return e.current.status=a.newGameStatus,{num:n,side:r===l?"white":"black",from:w(s.from),dest:w(s.dest),san:Lt(o,s,a),move:s}}var ur=/^[A-Z][a-zA-Z0-9_]*$/,lr=/^[\u0020-\u007e]*$/;function Z(e,t){if(!ur.test(e))throw new Q("Invalid PGN tag name: "+e);if(!lr.test(t))throw new Q("Invalid characters in PGN tag value")}var mr=/^(1-0|0-1|1\/2-1\/2)$/;function he(e){var a;let t=vr(e),r={},o=[];for(;((a=t[0])==null?void 0:a.type)==="[";)fr(t,r);let s=r.SetUp==="1"&&r.FEN?kt(r.FEN):At();dr(t,s,o);let n=Er(t,s);if(r.Result&&n!==r.Result)throw new h("PGN Result tag has an incorrect game status");return{board:s,tags:r,moves:o,winner:hr(n)}}function fr(e,t){let r=e.shift();dt(r,"[");let o=e.shift();dt(o,"Sym");let s=e.shift();dt(s,"Str");let n=e.shift();if(dt(n,"]"),Z(o.value,s.value),t[o.value])throw new h("Duplicate PGN tag: "+o.value);t[o.value]=s.value}function dr(e,t,r){for(;;){let o=e.shift();if(!o)throw new h("PGN move list didn't have a conclusion");if(o.type==="Int"){if(t.current.moveNum!==o.value)throw new h(`PGN move list expected it to be turn ${o.value}, but the board is on ${t.current.moveNum}'`);continue}if(o.type!=="."&&o.type!=="Nag"){if(o.type==="*"){e.unshift(o);break}if(o.type==="("){let s=1;for(;s;){let n=e.shift();if(!n)throw new h("PGN move list didn't have a conclusion");n.type==="("?s++:n.type===")"&&s--}continue}if(o.type==="Sym"){if(mr.test(o.value)){e.unshift(o);break}Cr(t,r,o.value);continue}throw new h(`PGN data had unexpected data in the move list: ${Te(o)}`)}}}function Er(e,t){let r=e.shift();if(!r)throw new h("PGN move list didn't have a conclusion");if(e.length)throw new h("PGN had extra moves after game ended");if(r.type==="*")return"*";dt(r,"Sym");let o=r;switch(o.value){case"1-0":case"0-1":return t.current.status===q&&(t.current.status=pt),o.value;case"1/2-1/2":{let s=W(t,8-t.current.turn);return t.current.status=s.newGameStatus>=U?s.newGameStatus:U,o.value}default:throw new h(`PGN had an unexpected game end: ${o.value}`)}}function Cr(e,t,r){let o=e.current.turn,s=K(e,o),n=vt(s,r);t.push({num:e.current.moveNum,turn:e.current.turn,move:n,san:r}),D(e,n);let a=W(e,o);e.current.turn=8-o,(a.newGameStatus<U||a.newGameStatus===rt)&&(e.current.status=a.newGameStatus)}function hr(e){switch(e){case"1-0":return"white";case"0-1":return"black";case"1/2-1/2":return"draw";default:return null}}var Tr=/(?:^|\n)%[^\n]*/g,Sr=/^\s+/,Pr=/^(?:;[^\n]*\n|\{[^}]*\})/,yr=/^[\[\]().*]/,gr=/^"(?:[^\\"]|\\.)*"/,Mr=/^([a-z0-9][-a-z0-9_+#=:/]*)[!?]{0,2}/i,Ar=/^\$\d+/,_r=/^\d+$/,Ir=/\\(.)/g,kr=/[^\x20-\x7e]/;function vr(e){let t=e.replace(Tr,"")+`
`,r=[];for(;t;){let o;if(o=t.match(Sr)||t.match(Pr),o){t=t.slice(o[0].length);continue}if(o=t.match(yr),o){let s=o[0];r.push({type:s}),t=t.slice(s.length);continue}if(o=t.match(Mr),o){let s=o[0],n=o[1];_r.test(n)?r.push({type:"Int",value:parseInt(n,10)}):r.push({type:"Sym",value:n}),t=t.slice(s.length);continue}if(o=t.match(gr),o){let s=o[0];r.push({type:"Str",value:wr(s)}),t=t.slice(s.length);continue}if(o=t.match(Ar),o){let s=o[0];r.push({type:"Nag",value:parseInt(s.slice(1),10)}),t=t.slice(s.length);continue}throw t.startsWith('"')?new h("PGN string reached the end"):new h(`PGN had unexpected data: ${t.slice(0,10)}`)}return r}function wr(e){let t=e.slice(1,-1).replace(Ir,(r,o)=>{if(o!=="\\"&&o!=='"')throw new h(`Invalid PGN string escape: ${JSON.stringify(r)}`);return o});if(kr.test(t))throw new h("PGN strings can only contain printable ASCII characters");if(t.length>=256)throw new h("PGN strings must be 255 chars or less");return t}function dt(e,t){(!e||e.type!==t)&&new h(`Expected a '${t}' token, but got ${Te(e)}.`)}function Te(e){if(!e)return"the end-of-file";switch(e.type){case"[":case"]":case"(":case")":case".":case"*":return`a '${e.type}`;case"Int":return`the Integer '${e.value}'`;case"Str":return`the String '${e.value}'`;case"Sym":return`the Symbol '${e.value}'`;case"Nag":return`the NAG Code $${e.value}`;default:return`the unknown symbol: ${JSON.stringify(e)}`}}var Se=80;function Pe({winner:e,moves:t,tags:r}){let o=xr(e);r=J({Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:o},r);let s="";for(let a of Object.keys(r))s+=Nr(a,r[a])+`
`;s+=`
`;let n=0;for(let a=0;a<t.length;a++){let i=t[a],p="";(!a||i.side==="white")&&(p+=i.num,p+=i.side==="white"?". ":"... "),p+=i.san,n+=p.length,n>Se&&(s+=`
`,n=p.length),s+=p,n<Se&&(s+=" ",n++)}return s+=o,s}function Nr(e,t){return Z(e,t),t=t.replace(/["\\]/g,"\\$&"),`[${e} "${t}"]`}function xr(e){switch(e){case"white":return"1-0";case"black":return"0-1";case"draw":return"1/2-1/2";default:return"*"}}function ye(e,t){let r=st(e);e.removeBoardHash(r);let o=e.current;e.set(t.from,t.what),e.set(t.dest,u),t.capture&&e.set(t.captureCoord,t.capture),t.castleRook&&(e.set(t.castleRookDest,u),e.set(t.castleRookFrom,t.castleRook));let s=t.prior;o.clock=s.clock,o.moveNum=s.moveNum,o.ep=s.ep,o.status=s.status,o.castles=s.castles,o.turn=8-o.turn,o.moveCache[l]=null,o.moveCache[d]=null}var Rr={[q]:"active",[ct]:"checkmate",[pt]:"resigned",[U]:"draw-other",[rt]:"draw-stalemate",[Pt]:"draw-repetition",[yt]:"draw-fifty-moves",[gt]:"draw-no-material"},A,$,R,nt,H,Et=class{constructor(t){O(this,A,void 0);O(this,$,[]);O(this,R,null);O(this,nt,null);O(this,H,{});v(this,A,t),this.setTag("Date",new Date)}static NewStandardGame(){return new Et(At())}static NewFromFEN(t){let r=new Et(kt(t));return r.maybeRefreshWinner(),r.setTag("SetUp",!0),r.setTag("FEN",t),r}static NewFromPGN(t){let r=he(t),o=new Et(r.board);return v(o,H,r.tags),c(o,$).push(...r.moves.map(s=>({num:s.num,side:s.turn===l?"white":"black",from:w(s.move.from),dest:w(s.move.dest),san:s.san,move:s.move}))),r.winner&&v(o,R,r.winner),o}getTags(){return J({},c(this,H))}setTag(t,r){if(r==null){Z(t,""),delete c(this,H)[t];return}let o;typeof r=="boolean"?o=r?"1":"0":r instanceof Date?o=isNaN(r.valueOf())?"????.??.??":[r.getFullYear(),String(r.getMonth()+1).padStart(2,"0"),String(r.getDate()).padStart(2,"0")].join("."):o=String(r),Z(t,o),c(this,H)[t]=o}history(){return c(this,$).map(t=>({num:t.num,side:t.side,from:t.from,dest:t.dest,san:t.san}))}getStatus(){let t=c(this,A).current,r={state:Rr[t.status],turn:t.turn===l?"white":"black"};return c(this,R)&&(r.winner=c(this,R)),c(this,nt)&&(r.reason=c(this,nt)),r}isGameOver(){return Boolean(c(this,A).current.status)}move(t){if(this.isGameOver())throw new tt;let r=Ce(c(this,A),t);return c(this,$).push(r),this.maybeRefreshWinner(),this}undoMove(){let t=c(this,$).pop();return t&&(ye(c(this,A),t.move),v(this,R,null)),this}allMoves(t){if(this.isGameOver())return[];let r=c(this,A).current.turn,o;if(t==null)o=K(c(this,A),r);else{let s=L(t),n=c(this,A).get(s);if(n===u||E(n)!==r)return[];o=bt(c(this,A),s)}return o.map(s=>{let n=w(s.from),a=w(s.dest);return s.promote?{from:n,dest:a,promotion:qt(s.promote)}:{from:n,dest:a}})}resignGame(t){if(this.isGameOver())throw new tt;c(this,A).current.status=pt,v(this,R,t==="white"?"black":"white")}drawGame(t){if(this.isGameOver())throw new tt;c(this,A).current.status=U,t&&v(this,nt,t)}toString(t="ascii"){switch(t){case"ascii":return Rt(c(this,A),!1);case"terminal":return Rt(c(this,A),!0);case"fen":return Vt(c(this,A));case"pgn":return Pe({board:c(this,A),winner:c(this,R),moves:c(this,$),tags:c(this,H)});default:throw new Q(t)}}maybeRefreshWinner(){let t=c(this,A).current.status,r=c(this,A).current.turn;t===ct?v(this,R,r===l?"black":"white"):t>=U&&v(this,R,"draw")}},ge=Et;A=new WeakMap,$=new WeakMap,R=new WeakMap,nt=new WeakMap,H=new WeakMap;return Gr;})();
