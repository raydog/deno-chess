/*! Deno-Chess 0.5.0, (c) 2021, license: MIT */
var DenoChess=(()=>{var Nt=Object.defineProperty,_e=Object.defineProperties;var Ie=Object.getOwnPropertyDescriptors;var Yt=Object.getOwnPropertySymbols;var ve=Object.prototype.hasOwnProperty,we=Object.prototype.propertyIsEnumerable;var Kt=(e,t,r)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,tt=(e,t)=>{for(var r in t||(t={}))ve.call(t,r)&&Kt(e,r,t[r]);if(Yt)for(var r of Yt(t))we.call(t,r)&&Kt(e,r,t[r]);return e},Ut=(e,t)=>_e(e,Ie(t)),ke=e=>Nt(e,"__esModule",{value:!0});var Dt=(e,t)=>{ke(e);for(var r in t)Nt(e,r,{get:t[r],enumerable:!0})};var Ft=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var p=(e,t,r)=>(Ft(e,t,"read from private field"),r?r.call(e):t.get(e)),L=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},k=(e,t,r,o)=>(Ft(e,t,"write to private field"),o?o.call(e,r):t.set(e,r),r);var Br={};Dt(Br,{ChessGame:()=>Me,errors:()=>ht});var u=0,f=8;var ht={};Dt(ht,{ChessBadInput:()=>Q,ChessBadMove:()=>R,ChessError:()=>Y,ChessGameOver:()=>et,ChessNeedsPromotion:()=>V,ChessParseError:()=>h});var Y=class extends Error{},et=class extends Y{constructor(){super("Game is over")}},Q=class extends Y{constructor(t){super(`Unexpected input: ${t}`)}},R=class extends Y{constructor(t){super("Bad move: "+t)}},V=class extends Y{constructor(){super("Promotion piece is required for this move")}},h=class extends Y{};function q(e,t){if(!e)throw new Y(t)}var Ne=/^[a-h][1-8]$/i,Ge="abcdefgh",Re="12345678",it=e=>[e&7,e>>>4],Gt=(e,t)=>(t&7)<<4|e&7,x=e=>{q(Ne.test(e),"Invalid coord");let t=e.toLowerCase(),r=t.charCodeAt(0)-97,o=t.charCodeAt(1)-49;return Gt(r,o)},w=e=>{let[t,r]=it(e);return Ge[t]+Re[r]};var xe=(e,t)=>e|t,Be=["","P","B","N","R","Q","K","","","p","b","n","r","q","k"];var m=0;function T(e){return e&7}function E(e){return e&8}function rt(e){return Boolean(e&16)}function Rt(e){return e===m?e:e|16}function Wt(e,t){return e===m?e:e&248|t&7}var ct=(e,t,r=!1)=>e|t|Number(r)<<4;function Tt(e){if(e===m)return" ";let t=xe(E(e),T(e));return Be[t]}var $t=`   +------------------------+  
`,Ht="     a  b  c  d  e  f  g  h    ",Oe={dim:e=>`[2m${e}[22m`,black:e=>`[30;2m${e}[39;22m`,darkBg:e=>`[44m${e}[49m`,lightBg:e=>`[46m${e}[49m`},be={dim:e=>e,black:e=>e,darkBg:e=>e,lightBg:e=>e};function xt(e,t){let r=t?Oe:be,o=r.dim(Ht)+`
`+$t;for(let s=7;s>=0;s--){let n=` ${r.dim(String(s+1))} |`;for(let a=0;a<8;a++){let c=Gt(a,s),i=e.get(c);n+=Le(r,c,i)}o+=n+`| ${r.dim(String(s+1))}
`}return o+$t+r.dim(Ht)}function Le(e,t,r){let o;if(r===m)o=e.dim("   ");else{let s=" "+Tt(r)+" ";o=E(r)===u?s:e.black(s)}return((t>>>4^t)&1)==0?e.darkBg(o):e.lightBg(o)}function St(e,t,r,o){return t&15|(e&15)<<4|(o&15)<<8|(r&15)<<12}function Qt(e,t){return t===u?e&65280|136:e&255|34816}function Bt(e,t){let r=t<64?0:8,o=r+4,s=t&15;if((e>>>r&15)===s){let n=e&~(15<<r),a=8<<r;return n|a}if((e>>>o&15)===s){let n=e&~(15<<o),a=8<<o;return n|a}return e}function N(e,t,r){let o=t+(r?0:4);return e>>>o&15}function Vt(e){let t="";for(let s=112;s>=0;s-=16){let n=0;for(let a=0;a<8;a++){let c=s|a,i=e.get(c);if(i===m){n++;continue}n&&(t+=n,n=0),t+=Tt(i)}n&&(t+=n),s&&(t+="/")}t+=e.current.turn===u?" w":" b";let r=e.current.castles;t+=" "+Ye(r);let o=e.current.ep;return t+=o&136?" -":" "+w(o),t+=" "+e.current.clock,t+=" "+e.current.moveNum,t}function Ye(e){let t="";return t+=N(e,u,!0)&8?"":"K",t+=N(e,u,!1)&8?"":"Q",t+=N(e,f,!0)&8?"":"k",t+=N(e,f,!1)&8?"":"q",t||"-"}var j=0,pt=10,ut=11,F=20,ot=21,Pt=22,yt=23,gt=24;var _=1,S=2,g=3,C=4,M=5,v=6,Ke={[_]:"P",[S]:"B",[g]:"N",[C]:"R",[M]:"Q",[v]:"K"};function qt(e){return Ke[e]}var jt=0,Mt=8,Ot=[16,1,-16,-1,17,-15,-17,15],Xt=[31,33,14,18,-18,-14,-33,-31],Zt={[u]:[15,17],[f]:[-15,-17]};function zt(e,t,r){let o=e.current.attacks,s=r<<4;return Boolean(o[t|s|Mt]||o[t|s|jt])}function Jt(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(o){case _:for(let a of Zt[r])st(s,t+a,r,-1);break;case g:for(let a of Xt)st(s,t+a,r,-1);break;case v:for(let a of Ot)st(s,t+a,r,-1);break;case S:for(let a=4;a<8;a++)X(s,n,t,r,a,0);break;case C:for(let a=0;a<4;a++)X(s,n,t,r,a,0);break;case M:for(let a=0;a<8;a++)X(s,n,t,r,a,0);break}ee(e,t,1)}function te(e,t,r,o){let s=e.current.attacks,n=e.current.board;switch(ee(e,t,0),o){case _:for(let a of Zt[r])st(s,t+a,r,1);break;case g:for(let a of Xt)st(s,t+a,r,1);break;case v:for(let a of Ot)st(s,t+a,r,1);break;case S:for(let a=4;a<8;a++)X(s,n,t,r,a,1);break;case C:for(let a=0;a<4;a++)X(s,n,t,r,a,1);break;case M:for(let a=0;a<8;a++)X(s,n,t,r,a,1);break}}function ee(e,t,r){let o=e.current.attacks,s=e.current.board;for(let n=0;n<=8;n+=8){let a=n<<4,c=o[t|a|Mt];for(let i=0;i<8;i++)c&1<<i&&X(o,s,t,n,i,r)}}function X(e,t,r,o,s,n){let a=Ot[s];for(;((r+=a)&136)==0&&(Ue(e,r,o,s,n),t[r]===m););}function st(e,t,r,o){if(t&136)return;let s=r<<4;e[t|s|jt]+=o}function Ue(e,t,r,o,s){let n=r<<4;s?e[t|n|Mt]|=1<<o:e[t|n|Mt]&=~(1<<o)}var re=8*8*2,K,G,lt=class{constructor(){L(this,K,0);L(this,G,[oe()]);this.current=p(this,G)[0]}reset(){k(this,K,0);let t=this.current=p(this,G)[0];t.board.fill(m),t.attacks.fill(0),t.clock=0,t.moveNum=0,t.ep=136,t.status=j,t.turn=u,t.seen={},t.castles=0,t.moveCache[u]=null,t.moveCache[f]=null,t.pieceList=[]}set(t,r){q((t&136)==0,"Invalid set() coord");let o=this.current.board[t];if(o!==m){let s=E(o),n=T(o);Jt(this,t,s,n)}if(this.current.board[t]=r,r!==m){let s=E(r),n=T(r);te(this,t,s,n)}if(o===m!=(r===m)){let s=this.current.pieceList;if(o===m)s.push(t);else{let n=s.indexOf(t),a=s.length-1;if(n!==a){let c=s[a];s[a]=t,s[n]=c}s.pop()}}}get(t){return q((t&136)==0,"Invalid get() coord"),this.current.board[t]}putBoardHash(t){for(let r=p(this,K);r>=0;r--)if(t in p(this,G)[r].seen){let o=1+p(this,G)[r].seen[t];return this.current.seen[t]=o,o}return this.current.seen[t]=1,1}removeBoardHash(t){for(let r=p(this,K);r>=0;r--)if(t in p(this,G)[r].seen){this.current.seen[t]--;return}}save(){let t=k(this,K,+p(this,K)+1);t===p(this,G).length&&p(this,G).push(oe()),this.current=p(this,G)[t],De(p(this,G)[t-1],this.current)}restore(){if(p(this,K)>0){let t=k(this,K,+p(this,K)-1);this.current=p(this,G)[t]}}getPriorState(){let t=this.current;return{clock:t.clock,moveNum:t.moveNum,ep:t.ep,status:t.status,castles:t.castles}}};K=new WeakMap,G=new WeakMap;function oe(){return{board:new Uint8Array(re).fill(m),attacks:new Uint8Array(re*2).fill(0),clock:0,moveNum:1,ep:136,status:j,turn:u,seen:{},castles:0,moveCache:{[u]:null,[f]:null},pieceList:[]}}function De(e,t){t.board.set(e.board),t.attacks.set(e.attacks),t.clock=e.clock,t.moveNum=e.moveNum,t.ep=e.ep,t.status=e.status,t.turn=e.turn,t.seen={},t.castles=e.castles,t.moveCache[u]=e.moveCache[u],t.moveCache[f]=e.moveCache[f],t.pieceList=e.pieceList.slice()}var Fe=" PBNRQK  pbnrqk";function nt(e){let t="",r=0;for(let s=0;s<128;s+=16)for(let n=0;n<8;n++){let a=s|n,c=e.get(a);if(c===m){r++;continue}r&&(t+=r,r=0);let i=c&15;t+=Fe[i]}r&&(t+=r),t+=";";let o=e.current.castles;return t+=mt(N(o,u,!0)),t+=mt(N(o,u,!1)),t+=mt(N(o,f,!0)),t+=mt(N(o,f,!1)),t+=";"+mt((e.current.ep||136)&15),t}function mt(e){return e&8?"-":String(e)}var se=[C,g,S,M,v,S,g,C],ne=Array(8).fill(_);function At(){let e=new lt;return _t(e,u,0,se),_t(e,u,16,ne),_t(e,f,96,ne),_t(e,f,112,se),e.current.castles=St(0,7,112,119),e.putBoardHash(nt(e)),e}function _t(e,t,r,o){for(let s=0;s<8;s++)e.set(r|s,ct(o[s],t,!1))}function ae(e,t,r,o){return W(e,t,r,0,0,0,0,0,0,0,o)}function ie(e,t,r,o,s,n){return W(e,t,r,o,s,0,0,0,0,0,n)}function bt(e,t,r,o,s,n,a){return W(e,t,r,0,0,o,s,n,0,0,a)}function W(e,t,r,o,s,n,a,c,i,l,d){return{what:e,from:t,dest:r,capture:o,captureCoord:s,castleRook:n,castleRookFrom:a,castleRookDest:c,promote:i,markEnPassant:l,prior:d}}function ce(e,t){return Ut(tt({},e),{promote:t})}function U(e,t){let r=e.current;r.ep=136;let o=Rt(t.what),s=E(o),n=T(o);n===v&&(r.castles=Qt(r.castles,s)),n===C&&!rt(t.what)&&(r.castles=Bt(r.castles,t.from)),t.markEnPassant&&(r.ep=t.markEnPassant),t.promote&&(o=Wt(o,t.promote)),e.set(t.dest,o),e.set(t.from,m),t.capture&&t.captureCoord!==t.dest&&e.set(t.captureCoord,m),t.castleRook&&(e.set(t.castleRookDest,Rt(t.castleRook)),e.set(t.castleRookFrom,m)),E(o)&&r.moveNum++,t.capture||T(t.what)===_?r.clock=0:r.clock++,t.capture&&T(t.capture)===C&&!rt(t.capture)&&(r.castles=Bt(r.castles,t.captureCoord)),r.moveCache[u]=null,r.moveCache[f]=null,r.turn=8-r.turn}function ft(e,t){let r=8-t;for(let o of e.current.pieceList){let s=e.get(o);if(!(T(s)!==v||E(s)!==t)&&zt(e,o,r))return!0}return!1}var It=[16,1,-16,-1,17,-15,-17,15],We=[31,33,14,18,-18,-14,-33,-31],$e=[-1,1],He=[M,C,g,S];function b(e,t){let r=e.current.moveCache[t];if(r)return r.slice();let o=[];for(let s of e.current.pieceList){let n=e.get(s);E(n)===t&&Lt(e,s,o)}return e.current.moveCache[t]=o,o}function Lt(e,t,r=[]){let o=e.get(t),s=e.getPriorState();switch(q(o!==m,"Listing moves of empty space"),e.save(),e.set(t,m),T(o)){case S:dt(e,o,t,It,4,8,8,r,s);break;case C:dt(e,o,t,It,0,4,8,r,s);break;case M:dt(e,o,t,It,0,8,8,r,s);break;case g:dt(e,o,t,We,0,8,1,r,s);break;case v:dt(e,o,t,It,0,8,1,r,s),Qe(e,o,t,r,s);break;case _:Ve(e,o,t,r,s);break}return e.restore(),r}function dt(e,t,r,o,s,n,a,c,i){let l=E(t),d=8-l;for(let I=s;I<n;I++){let P=o[I];for(let y=r+P,O=0;(y&136)==0&&O<a;y+=P,O++){let J=e.get(y);if(J===m){Z(e,c,ae(t,r,y,i));continue}E(J)===d&&Z(e,c,ie(t,r,y,J,y,i));break}}}function Qe(e,t,r,o,s){if(rt(t))return;let n=E(t),a=e.current.castles,c=N(a,n,!0),i=N(a,n,!1),l=r&240;if((c&8)==0){let d=l|6,I=l|c,P=l|5;pe(e,o,bt(t,r,d,e.get(I),I,P,s))}if((i&8)==0){let d=l|2,I=l|i,P=l|3;pe(e,o,bt(t,r,d,e.get(I),I,P,s))}}function Ve(e,t,r,o,s){let n=E(t),a=8-n,c=n===u?1:-1,i=r+16*c,l=r+32*c;if(i&136)return o;let d=l&136?M:0;e.get(i)===m&&(Z(e,o,W(t,r,i,0,0,0,0,0,d,0,s)),!rt(t)&&(l&136)==0&&e.get(l)===m&&Z(e,o,W(t,r,l,0,0,0,0,0,0,i,s)));let I=e.current.ep;for(let P of $e){let y=i+P;if(y&136)continue;let O=e.get(y);if(y===I){let J=r+P,Ae=e.get(J);Z(e,o,W(t,r,y,Ae,J,0,0,0,d,0,s))}else O!==m&&E(O)===a&&Z(e,o,W(t,r,y,O,y,0,0,0,d,0,s))}return o}function Z(e,t,r){let o=E(r.what);if(e.save(),U(e,r),!ft(e,o))if(r.promote)for(let s of He)t.push(ce(r,s));else t.push(r);e.restore()}function pe(e,t,r){let o=E(r.what),s=Math.min(r.castleRookFrom,r.castleRookDest,r.from,r.dest),n=Math.max(r.castleRookFrom,r.castleRookDest,r.from,r.dest);for(let l=s;l<=n;l++){if(l===r.from||l===r.castleRookFrom)continue;if(e.get(l)!==m)return}e.save(),e.set(r.from,m),e.set(r.castleRookFrom,m);let a=Math.min(r.from,r.dest),c=Math.max(r.from,r.dest);for(let l=a;l<=c;l++)e.set(l,r.what);let i=ft(e,o);e.restore(),!i&&Z(e,t,r)}function ue(e){let t=0,r=Array(8).fill(0),o=0;for(let a of e.current.pieceList){let c=e.get(a),i=T(c);if(i===_||i===C||i===M)return!1;t++,i===S&&(o+=(a>>>4^a)&1),r[i]++}if(t===2)return!0;let s=r[S],n=r[g];return t===3&&(s===1||n===1)||t===s+2&&(o===0||o===s)}function D(e,t){let r=8-t,o=ft(e,r),s=b(e,r).length>0,n=e.putBoardHash(nt(e)),a=qe(e,o,s,n);return{enemyInCheck:o,enemyCanMove:s,newGameStatus:a}}function qe(e,t,r,o){let s=e.current.status;return r?e.current.clock>=100?yt:o>=3?Pt:ue(e)?gt:s:t?pt:ot}var je=/[1-8]/,Xe=/[PBNRQK]/,Ze=/[pbnrqk]/,ze=/^((?:[pbnrqkPBNRQK1-8]{1,8}\/){7}[pbnrqkPBNRQK1-8]{1,8})\s+([wb])\s+(K?Q?k?q?|-)\s+([a-h][36]|-)\s+(\d+)\s+(\d+)$/;function vt(e,t){t&&t.reset();let r=t||new lt;e=e.trim();let o=e.match(ze);if(!o)throw new h("Bad FEN string");let s=o[1].split("/");for(let c=7;c>=0;c--){let i=0,l=s[7-c];for(let d=0;d<8;d++){let I=c<<4|d;if(i>=l.length)throw new h(`Bad FEN string: Rank ${c+1} had less than 8 files`);let P=l[i++];if(je.test(P)){let y=parseInt(P,10);for(let O=0;O<y;O++)r.set(I+O,m);d+=y-1}else if(Xe.test(P)){let y=le(P);r.set(I,me(u,y,c))}else if(Ze.test(P)){let y=le(P);r.set(I,me(f,y,c))}}}let n=er(o[2]);r.current.turn=n,r.current.castles=rr(o[3]),o[4]!=="-"&&(r.current.ep=x(o[4])),r.current.clock=parseInt(o[5],10),r.current.moveNum=parseInt(o[6],10);let a=D(r,8-n);return r.current.status=a.newGameStatus,r}var Je={p:_,b:S,n:g,r:C,q:M,k:v};function le(e){return Je[e.toLowerCase()]}var tr={w:u,b:f};function er(e){return tr[e]}function rr(e){let t=136,r=136,o=136,s=136;if(e!=="-")for(let n=0;n<e.length;n++)switch(e[n]){case"K":r=7;break;case"Q":t=0;break;case"k":s=119;break;case"q":o=112;break}return St(t,r,o,s)}function me(e,t,r){return t===_?ct(t,e,!(r===1&&e===u||r===6&&e===f)):ct(t,e,!1)}var fe={"":_,B:S,N:g,R:C,Q:M,K:v},or=/^(O-O(?:-O)?|0-0(?:-0)?)(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/,sr=/^([BNRQK]?)([a-h]?)([1-8]?)(x?)([a-h][1-8])(?:=([BNRQ]))?(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/;function wt(e,t){t=t.trim();let r=t.match(or);if(r)return de(e,t,r[1].length===5?n=>(n.castleRookDest&7)==3:n=>(n.castleRookDest&7)==5);let o=t.match(sr);if(!o)throw new R(`Couldn't parse: ${t}`);return de(e,t,n=>x(o[5])===n.dest&&T(n.what)===fe[o[1]]&&(o[2]?(n.from&7)==o[2].charCodeAt(0)-97:!0)&&(o[3]?(n.from>>>4&7)==o[3].charCodeAt(0)-49:!0)&&(o[4]?n.capture!==0:n.capture===0)&&(o[6]?n.promote===fe[o[6]]:!0))}function de(e,t,r){let o=null;for(let s=0;s<e.length;s++){let n=e[s];if(r(n)){if(o)throw o.promote&&n.promote?new V:new R(`${t} is ambiguous`);o=n}}if(o)return o;throw new R(`${t} is not a valid move`)}function kt(e,t,r){let o;if(t.castleRook)o=t.castleRookFrom<t.from?"O-O-O":"O-O";else{let n=nr(e,t),a=Ee(T(t.what)),c=t.capture?"x":"",i=w(t.dest),l=t.promote?"="+Ee(t.promote):"";o=`${a}${n}${c}${i}${l}`}let s=r?ar(r):"";return`${o}${s}`}function nr(e,t){let r=w(t.from);if(T(t.what)===_&&t.capture)return r[0];let o=e.filter(a=>a.from!==t.from&&a.dest===t.dest&&T(a.what)===T(t.what));if(!o.length)return"";let[s,n]=it(t.from);return o.every(a=>it(a.from)[0]!==s)?r[0]:o.every(a=>it(a.from)[1]!==n)?r[1]:r}function Ee(e){switch(e){case S:return"B";case g:return"N";case C:return"R";case M:return"Q";case v:return"K";default:return""}}function ar(e){return e.enemyInCheck?e.enemyCanMove?"+":"#":""}var ir=/^([a-h][1-8])[- ]*([a-h][1-8])([bnrqBNRQ])?$/,Ce={N:g,B:S,R:C,Q:M};function he(e,t){if(typeof t=="object")return ur(e,t);let r=t.match(ir);return r?cr(e,r[1],r[2],r[3]):pr(e,t)}function cr(e,t,r,o){let s=x(t),n=x(r),a=0;if(o&&(a=Ce[o.toUpperCase()],!a))throw new R(`Invalid promotion: ${o}`);let c=e.current.turn,i=b(e,c),l=i.find(P=>P.from===s&&P.dest===n&&(a?P.promote===a:!0));if(!l)throw new R(`Invalid move: ${t}${r}${o||""}`);if(l.promote&&!a)throw new V;let d=e.current.moveNum;U(e,l);let I=D(e,c);return e.current.status=I.newGameStatus,{num:d,side:c===u?"white":"black",from:t,dest:r,san:kt(i,l,I),move:l}}function pr(e,t){let r=e.current.turn,o=b(e,r),s=wt(o,t),n=e.current.moveNum;U(e,s);let a=D(e,r);return e.current.status=a.newGameStatus,{num:n,side:r===u?"white":"black",from:w(s.from),dest:w(s.dest),san:kt(o,s,a),move:s}}function ur(e,t){let r=x(t.from),o=x(t.dest),s=0;if(t.promotion&&(s=Ce[t.promotion.toUpperCase()],!s))throw new R(`Invalid promotion: ${t.promotion}`);let n=e.current.moveNum,a=e.current.turn,c=b(e,a),i=c.find(d=>d.from===r&&d.dest===o&&(s?d.promote===s:!0));if(!i)throw new R(`Invalid move: ${JSON.stringify(t)}`);if(i.promote&&!s)throw new V;U(e,i);let l=D(e,a);return e.current.status=l.newGameStatus,{num:n,side:a===u?"white":"black",from:w(i.from),dest:w(i.dest),san:kt(c,i,l),move:i}}var lr=/^[A-Z][a-zA-Z0-9_]*$/,mr=/^[\u0020-\u007e]*$/;function z(e,t){if(!lr.test(e))throw new Q("Invalid PGN tag name: "+e);if(!mr.test(t))throw new Q("Invalid characters in PGN tag value")}var fr=/^(1-0|0-1|1\/2-1\/2)$/;function Te(e){var a;let t=kr(e),r={},o=[];for(;((a=t[0])==null?void 0:a.type)==="[";)dr(t,r);let s=r.SetUp==="1"&&r.FEN?vt(r.FEN):At();Er(t,s,o);let n=Cr(t,s);if(r.Result&&n!==r.Result)throw new h("PGN Result tag has an incorrect game status");return{board:s,tags:r,moves:o,winner:Tr(n)}}function dr(e,t){let r=e.shift();Et(r,"[");let o=e.shift();Et(o,"Sym");let s=e.shift();Et(s,"Str");let n=e.shift();if(Et(n,"]"),z(o.value,s.value),t[o.value])throw new h("Duplicate PGN tag: "+o.value);t[o.value]=s.value}function Er(e,t,r){for(;;){let o=e.shift();if(!o)throw new h("PGN move list didn't have a conclusion");if(o.type==="Int"){if(t.current.moveNum!==o.value)throw new h(`PGN move list expected it to be turn ${o.value}, but the board is on ${t.current.moveNum}'`);continue}if(o.type!=="."&&o.type!=="Nag"){if(o.type==="*"){e.unshift(o);break}if(o.type==="("){let s=1;for(;s;){let n=e.shift();if(!n)throw new h("PGN move list didn't have a conclusion");n.type==="("?s++:n.type===")"&&s--}continue}if(o.type==="Sym"){if(fr.test(o.value)){e.unshift(o);break}hr(t,r,o.value);continue}throw new h(`PGN data had unexpected data in the move list: ${Se(o)}`)}}}function Cr(e,t){let r=e.shift();if(!r)throw new h("PGN move list didn't have a conclusion");if(e.length)throw new h("PGN had extra moves after game ended");if(r.type==="*")return"*";Et(r,"Sym");let o=r;switch(o.value){case"1-0":case"0-1":return t.current.status===j&&(t.current.status=ut),o.value;case"1/2-1/2":{let s=D(t,8-t.current.turn);return t.current.status=s.newGameStatus>=F?s.newGameStatus:F,o.value}default:throw new h(`PGN had an unexpected game end: ${o.value}`)}}function hr(e,t,r){let o=e.current.turn,s=b(e,o),n=wt(s,r);t.push({num:e.current.moveNum,turn:e.current.turn,move:n,san:r}),U(e,n);let a=D(e,o);e.current.turn=8-o,(a.newGameStatus<F||a.newGameStatus===ot)&&(e.current.status=a.newGameStatus)}function Tr(e){switch(e){case"1-0":return"white";case"0-1":return"black";case"1/2-1/2":return"draw";default:return null}}var Sr=/(?:^|\n)%[^\n]*/g,Pr=/^\s+/,yr=/^(?:;[^\n]*\n|\{[^}]*\})/,gr=/^[\[\]().*]/,Mr=/^"(?:[^\\"]|\\.)*"/,Ar=/^([a-z0-9][-a-z0-9_+#=:/]*)[!?]{0,2}/i,_r=/^\$\d+/,Ir=/^\d+$/,vr=/\\(.)/g,wr=/[^\x20-\x7e]/;function kr(e){let t=e.replace(Sr,"")+`
`,r=[];for(;t;){let o;if(o=t.match(Pr)||t.match(yr),o){t=t.slice(o[0].length);continue}if(o=t.match(gr),o){let s=o[0];r.push({type:s}),t=t.slice(s.length);continue}if(o=t.match(Ar),o){let s=o[0],n=o[1];Ir.test(n)?r.push({type:"Int",value:parseInt(n,10)}):r.push({type:"Sym",value:n}),t=t.slice(s.length);continue}if(o=t.match(Mr),o){let s=o[0];r.push({type:"Str",value:Nr(s)}),t=t.slice(s.length);continue}if(o=t.match(_r),o){let s=o[0];r.push({type:"Nag",value:parseInt(s.slice(1),10)}),t=t.slice(s.length);continue}throw t.startsWith('"')?new h("PGN string reached the end"):new h(`PGN had unexpected data: ${t.slice(0,10)}`)}return r}function Nr(e){let t=e.slice(1,-1).replace(vr,(r,o)=>{if(o!=="\\"&&o!=='"')throw new h(`Invalid PGN string escape: ${JSON.stringify(r)}`);return o});if(wr.test(t))throw new h("PGN strings can only contain printable ASCII characters");if(t.length>=256)throw new h("PGN strings must be 255 chars or less");return t}function Et(e,t){(!e||e.type!==t)&&new h(`Expected a '${t}' token, but got ${Se(e)}.`)}function Se(e){if(!e)return"the end-of-file";switch(e.type){case"[":case"]":case"(":case")":case".":case"*":return`a '${e.type}`;case"Int":return`the Integer '${e.value}'`;case"Str":return`the String '${e.value}'`;case"Sym":return`the Symbol '${e.value}'`;case"Nag":return`the NAG Code $${e.value}`;default:return`the unknown symbol: ${JSON.stringify(e)}`}}var Pe=80;function ye({winner:e,moves:t,tags:r}){let o=Rr(e);r=tt({Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:o},r);let s="";for(let a of Object.keys(r))s+=Gr(a,r[a])+`
`;s+=`
`;let n=0;for(let a=0;a<t.length;a++){let c=t[a],i="";(!a||c.side==="white")&&(i+=c.num,i+=c.side==="white"?". ":"... "),i+=c.san,n+=i.length,n>Pe&&(s+=`
`,n=i.length),s+=i,n<Pe&&(s+=" ",n++)}return s+=o,s}function Gr(e,t){return z(e,t),t=t.replace(/["\\]/g,"\\$&"),`[${e} "${t}"]`}function Rr(e){switch(e){case"white":return"1-0";case"black":return"0-1";case"draw":return"1/2-1/2";default:return"*"}}function ge(e,t){let r=nt(e);e.removeBoardHash(r);let o=e.current;e.set(t.from,t.what),e.set(t.dest,m),t.capture&&e.set(t.captureCoord,t.capture),t.castleRook&&(e.set(t.castleRookDest,m),e.set(t.castleRookFrom,t.castleRook));let s=t.prior;o.clock=s.clock,o.moveNum=s.moveNum,o.ep=s.ep,o.status=s.status,o.castles=s.castles,o.turn=8-o.turn,o.moveCache[u]=null,o.moveCache[f]=null}var xr={[j]:"active",[pt]:"checkmate",[ut]:"resigned",[F]:"draw-other",[ot]:"draw-stalemate",[Pt]:"draw-repetition",[yt]:"draw-fifty-moves",[gt]:"draw-no-material"},A,$,B,at,H,Ct=class{constructor(t){L(this,A,void 0);L(this,$,[]);L(this,B,null);L(this,at,null);L(this,H,{});k(this,A,t),this.setTag("Date",new Date)}static NewStandardGame(){return new Ct(At())}static NewFromFEN(t){let r=new Ct(vt(t));return r.maybeRefreshWinner(),r.setTag("SetUp",!0),r.setTag("FEN",t),r}static NewFromPGN(t){let r=Te(t),o=new Ct(r.board);return k(o,H,r.tags),p(o,$).push(...r.moves.map(s=>({num:s.num,side:s.turn===u?"white":"black",from:w(s.move.from),dest:w(s.move.dest),san:s.san,move:s.move}))),r.winner&&k(o,B,r.winner),o}getTags(){return tt({},p(this,H))}setTag(t,r){if(r==null){z(t,""),delete p(this,H)[t];return}let o;typeof r=="boolean"?o=r?"1":"0":r instanceof Date?o=isNaN(r.valueOf())?"????.??.??":[r.getFullYear(),String(r.getMonth()+1).padStart(2,"0"),String(r.getDate()).padStart(2,"0")].join("."):o=String(r),z(t,o),p(this,H)[t]=o}history(){return p(this,$).map(t=>({num:t.num,side:t.side,from:t.from,dest:t.dest,san:t.san}))}getStatus(){let t=p(this,A).current,r={state:xr[t.status],turn:t.turn===u?"white":"black"};return p(this,B)&&(r.winner=p(this,B)),p(this,at)&&(r.reason=p(this,at)),r}isGameOver(){return Boolean(p(this,A).current.status)}move(t){if(this.isGameOver())throw new et;let r=he(p(this,A),t);return p(this,$).push(r),this.maybeRefreshWinner(),this}undoMove(){let t=p(this,$).pop();return t&&(ge(p(this,A),t.move),k(this,B,null)),this}allMoves(t){if(this.isGameOver())return[];let r=p(this,A).current.turn,o;if(t==null)o=b(p(this,A),r);else{let s=x(t),n=p(this,A).get(s);if(n===m||E(n)!==r)return[];o=Lt(p(this,A),s)}return o.map(s=>{let n=w(s.from),a=w(s.dest);return s.promote?{from:n,dest:a,promotion:qt(s.promote)}:{from:n,dest:a}})}resignGame(t){if(this.isGameOver())throw new et;p(this,A).current.status=ut,k(this,B,t==="white"?"black":"white")}drawGame(t){if(this.isGameOver())throw new et;p(this,A).current.status=F,t&&k(this,at,t)}toString(t="ascii"){switch(t){case"ascii":return xt(p(this,A),!1);case"terminal":return xt(p(this,A),!0);case"fen":return Vt(p(this,A));case"pgn":return ye({board:p(this,A),winner:p(this,B),moves:p(this,$),tags:p(this,H)});default:throw new Q(t)}}maybeRefreshWinner(){let t=p(this,A).current.status,r=p(this,A).current.turn;t===pt?k(this,B,r===u?"black":"white"):t>=F&&k(this,B,"draw")}},Me=Ct;A=new WeakMap,$=new WeakMap,B=new WeakMap,at=new WeakMap,H=new WeakMap;return Br;})();
