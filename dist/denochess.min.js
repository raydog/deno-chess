/*! Deno-Chess 0.2.1, (c) 2021, license: MIT */
var DenoChess=(()=>{var $t=Object.defineProperty;var Ht=Object.getOwnPropertySymbols;var be=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable,Vt=Math.pow,Qt=(t,e,r)=>e in t?$t(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,yt=(t,e)=>{for(var r in e||(e={}))be.call(e,r)&&Qt(t,r,e[r]);if(Ht)for(var r of Ht(e))Ye.call(e,r)&&Qt(t,r,e[r]);return t};var qt=(t,e)=>{for(var r in e)$t(t,r,{get:e[r],enumerable:!0})};var jt=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var p=(t,e,r)=>(jt(t,e,"read from private field"),r?r.call(t):e.get(t)),x=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},k=(t,e,r,o)=>(jt(t,e,"write to private field"),o?o.call(t,r):e.set(t,r),r);var Fr={};qt(Fr,{BeginnerAI:()=>Be,ChessGame:()=>ve,errors:()=>Mt});var f=0,A=1;var Mt={};qt(Mt,{ChessBadInput:()=>Q,ChessBadMove:()=>B,ChessError:()=>L,ChessGameOver:()=>st,ChessNeedsPromotion:()=>gt,ChessParseError:()=>d});var L=class extends Error{},st=class extends L{constructor(){super("Game is over")}},Q=class extends L{constructor(e){super(`Unexpected input: ${e}`)}},B=class extends L{constructor(e){super("Bad move: "+e)}},gt=class extends L{constructor(){super("Promotion piece is required for this move")}},d=class extends L{};function q(t,e){if(!t)throw new L(e)}var Fe=/^[a-h][1-8]$/i,Ke="abcdefgh",Le="12345678",lt=t=>[t&7,t>>>4],Ot=(t,e)=>(e&7)<<4|t&7,U=t=>{q(Fe.test(t),"Invalid coord");let e=t.toLowerCase(),r=e.charCodeAt(0)-97,o=e.charCodeAt(1)-49;return Ot(r,o)},v=t=>{let[e,r]=lt(t);return Ke[e]+Le[r]};var Ue=(t,e)=>t*6+e-1,De=["P","B","N","R","Q","K","p","b","n","r","q","k"];var l=0;function E(t){return t&7}function C(t){return t>>>3&1}function nt(t){return Boolean(t&16)}function bt(t){return t===l?t:t|16}function zt(t,e){return t===l?t:t&248|e&7}var ft=(t,e,r=!1)=>t|e<<3|Number(r)<<4;function Pt(t){if(t===l)return" ";let e=Ue(C(t),E(t));return De[e]}var Xt=`   +------------------------+  
`,Zt="     a  b  c  d  e  f  g  h    ",We={dim:t=>`[2m${t}[22m`,black:t=>`[30;2m${t}[39;22m`,darkBg:t=>`[44m${t}[49m`,lightBg:t=>`[46m${t}[49m`},$e={dim:t=>t,black:t=>t,darkBg:t=>t,lightBg:t=>t};function Yt(t,e){let r=e?We:$e,o=r.dim(Zt)+`
`+Xt;for(let s=7;s>=0;s--){let a=` ${r.dim(String(s+1))} |`;for(let n=0;n<8;n++){let i=Ot(n,s),c=t.get(i);a+=He(r,i,c)}o+=a+`| ${r.dim(String(s+1))}
`}return o+Xt+r.dim(Zt)}function He(t,e,r){let o;if(r===l)o=t.dim("   ");else{let s=" "+Pt(r)+" ";o=C(r)===f?s:t.black(s)}return((e>>>4^e)&1)==0?t.darkBg(o):t.lightBg(o)}function At(t,e,r,o){return e&15|(t&15)<<4|(o&15)<<8|(r&15)<<12}function Jt(t,e){return e===f?t&65280|136:t&255|34816}function Ft(t,e){let r=e<64?0:8,o=r+4,s=e&15;if((t>>>r&15)===s){let a=t&~(15<<r),n=8<<r;return a|n}if((t>>>o&15)===s){let a=t&~(15<<o),n=8<<o;return a|n}return t}function R(t,e,r){let o=(e<<3)+(r?0:4);return t>>>o&15}function te(t){let e="";for(let s=112;s>=0;s-=16){let a=0;for(let n=0;n<8;n++){let i=s|n,c=t.get(i);if(c===l){a++;continue}a&&(e+=a,a=0),e+=Pt(c)}a&&(e+=a),s&&(e+="/")}e+=t.current.turn===f?" w":" b";let r=t.current.castles;e+=" "+Ve(r);let o=t.current.ep;return e+=o&136?" -":" "+v(o),e+=" "+t.current.clock,e+=" "+t.current.moveNum,e}function Ve(t){let e="";return e+=R(t,f,!0)&8?"":"K",e+=R(t,f,!1)&8?"":"Q",e+=R(t,A,!0)&8?"":"k",e+=R(t,A,!1)&8?"":"q",e||"-"}var j=0,z=10,mt=11,D=20,at=21,wt=22,_t=23,vt=24;var y=1,g=2,M=3,T=4,P=5,w=6;var ee=0,It=8,Kt=[16,1,-16,-1,17,-15,-17,15],re=[31,33,14,18,-18,-14,-33,-31],oe=[[15,17],[-15,-17]];function se(t,e,r){let o=t.current.attacks,s=r<<7;return Boolean(o[e|s|It]||o[e|s|ee])}function ne(t,e,r,o){let s=t.current.attacks,a=t.current.board;switch(o){case y:for(let n of oe[r])it(s,e+n,r,-1);break;case M:for(let n of re)it(s,e+n,r,-1);break;case w:for(let n of Kt)it(s,e+n,r,-1);break;case g:for(let n=4;n<8;n++)X(s,a,e,r,n,0);break;case T:for(let n=0;n<4;n++)X(s,a,e,r,n,0);break;case P:for(let n=0;n<8;n++)X(s,a,e,r,n,0);break}ie(t,e,1)}function ae(t,e,r,o){let s=t.current.attacks,a=t.current.board;switch(ie(t,e,0),o){case y:for(let n of oe[r])it(s,e+n,r,1);break;case M:for(let n of re)it(s,e+n,r,1);break;case w:for(let n of Kt)it(s,e+n,r,1);break;case g:for(let n=4;n<8;n++)X(s,a,e,r,n,1);break;case T:for(let n=0;n<4;n++)X(s,a,e,r,n,1);break;case P:for(let n=0;n<8;n++)X(s,a,e,r,n,1);break}}function ie(t,e,r){let o=t.current.attacks,s=t.current.board;for(let a=0;a<2;a++){let n=a<<7,i=o[e|n|It];for(let c=0;c<8;c++)i&1<<c&&X(o,s,e,a,c,r)}}function X(t,e,r,o,s,a){let n=Kt[s];for(;((r+=n)&136)==0&&(Qe(t,r,o,s,a),e[r]===l););}function it(t,e,r,o){if(e&136)return;let s=r<<7;t[e|s|ee]+=o}function Qe(t,e,r,o,s){let a=r<<7;s?t[e|a|It]|=1<<o:t[e|a|It]&=~(1<<o)}var ce=8*8*2,W,O,Z=class{constructor(){x(this,W,0);x(this,O,[pe()]);this.current=p(this,O)[0]}reset(){k(this,W,0);let e=this.current=p(this,O)[0];e.board.fill(l),e.attacks.fill(0),e.clock=0,e.moveNum=0,e.ep=136,e.status=j,e.turn=f,e.seen={},e.castles=0}set(e,r){q((e&136)==0,"Invalid set() coord");let o=this.current.board[e];if(o!==l){let s=C(o),a=E(o);ne(this,e,s,a)}if(this.current.board[e]=r,r!==l){let s=C(r),a=E(r);ae(this,e,s,a)}}get(e){return q((e&136)==0,"Invalid get() coord"),this.current.board[e]}putBoardHash(e){for(let r=p(this,W);r>=0;r--)if(e in p(this,O)[r].seen){let o=1+p(this,O)[r].seen[e];return this.current.seen[e]=o,o}return this.current.seen[e]=1,1}save(){let e=k(this,W,+p(this,W)+1);e===p(this,O).length&&p(this,O).push(pe()),this.current=p(this,O)[e],qe(p(this,O)[e-1],this.current)}restore(){if(p(this,W)>0){let e=k(this,W,+p(this,W)-1);this.current=p(this,O)[e]}}};W=new WeakMap,O=new WeakMap;function pe(){return{board:new Uint8Array(ce).fill(l),attacks:new Uint8Array(ce*2).fill(0),clock:0,moveNum:1,ep:136,status:j,turn:f,seen:{},castles:0}}function qe(t,e){e.board.set(t.board),e.attacks.set(t.attacks),e.clock=t.clock,e.moveNum=t.moveNum,e.ep=t.ep,e.status=t.status,e.turn=t.turn,e.seen={},e.castles=t.castles}var je=" PBNRQK  pbnrqk";function kt(t){let e="",r=0;for(let s=0;s<128;s+=16)for(let a=0;a<8;a++){let n=s|a,i=t.get(n);if(i===l){r++;continue}r&&(e+=r,r=0);let c=i&15;e+=je[c]}r&&(e+=r),e+=";";let o=t.current.castles;return e+=dt(R(o,f,!0)),e+=dt(R(o,f,!1)),e+=dt(R(o,A,!0)),e+=dt(R(o,A,!1)),e+=";"+dt((t.current.ep||136)&15),e}function dt(t){return t&8?"-":String(t)}var ue=[T,M,g,P,w,g,M,T],le=Array(8).fill(y);function Gt(){let t=new Z;return Nt(t,f,0,ue),Nt(t,f,16,le),Nt(t,A,96,le),Nt(t,A,112,ue),t.current.castles=At(0,7,112,119),t.putBoardHash(kt(t)),t}function Nt(t,e,r,o){for(let s=0;s<8;s++)t.set(r+s,ft(o[s],e,!1))}function fe(t,e,r){return $(t,e,r,0,0,0,0,0,0,0)}function me(t,e,r,o,s){return $(t,e,r,o,s,0,0,0,0,0)}function Lt(t,e,r,o,s,a){return $(t,e,r,0,0,o,s,a,0,0)}function $(t,e,r,o,s,a,n,i,c,u){return{what:t,from:e,dest:r,capture:o,captureCoord:s,castleRook:a,castleRookFrom:n,castleRookDest:i,promote:c,markEnPassant:u}}function b(t,e){t.current.ep=136;let r=bt(e.what),o=C(r),s=E(r);s===w&&(t.current.castles=Jt(t.current.castles,o)),s===T&&!nt(e.what)&&(t.current.castles=Ft(t.current.castles,e.from)),e.markEnPassant&&(t.current.ep=e.markEnPassant),e.promote&&(r=zt(r,e.promote)),t.set(e.dest,r),t.set(e.from,l),e.capture&&e.captureCoord!==e.dest&&t.set(e.captureCoord,l),e.castleRook&&(t.set(e.castleRookDest,bt(e.castleRook)),t.set(e.castleRookFrom,l)),C(r)&&t.current.moveNum++,e.capture||E(r)===y?t.current.clock=0:t.current.clock++,e.capture&&E(e.capture)===T&&!nt(e.capture)&&(t.current.castles=Ft(t.current.castles,e.captureCoord)),t.current.turn=1-t.current.turn}function Et(t,e){let r=1-e;for(let o=0;o<128;o+=16)for(let s=0;s<8;s++){let a=o|s,n=t.get(a);if(!(n===l||E(n)!==w||C(n)!==e)&&se(t,a,r))return!0}return!1}var xt=[16,1,-16,-1,17,-15,-17,15],ze=[31,33,14,18,-18,-14,-33,-31],Xe=[-1,1];function N(t,e){let r=[];for(let o=0;o<128;o+=16)for(let s=0;s<8;s++){let a=o|s,n=t.get(a);n!==l&&C(n)===e&&Ut(t,a,r)}return r}function Ut(t,e,r=[]){let o=t.get(e);switch(q(o!==l,"Listing moves of empty space"),t.save(),t.set(e,l),E(o)){case g:Ct(t,o,e,xt,4,8,8,r);break;case T:Ct(t,o,e,xt,0,4,8,r);break;case P:Ct(t,o,e,xt,0,8,8,r);break;case M:Ct(t,o,e,ze,0,8,1,r);break;case w:Ct(t,o,e,xt,0,8,1,r),Ze(t,o,e,r);break;case y:Je(t,o,e,r);break}return t.restore(),r}function Ct(t,e,r,o,s,a,n,i){let c=C(e),u=1-c;for(let m=s;m<a;m++){let S=o[m];for(let h=r+S,I=0;(h&136)==0&&I<n;h+=S,I++){let G=t.get(h);if(G===l){J(t,i,fe(e,r,h));continue}C(G)===u&&J(t,i,me(e,r,h,G,h));break}}}function Ze(t,e,r,o){if(nt(e))return;let s=C(e),a=t.current.castles,n=R(a,s,!0),i=R(a,s,!1),c=r&240;if((n&8)==0){let u=c|6,m=c|n,S=c|5;de(t,o,Lt(e,r,u,t.get(m),m,S))}if((i&8)==0){let u=c|2,m=c|i,S=c|3;de(t,o,Lt(e,r,u,t.get(m),m,S))}}function Je(t,e,r,o){let s=C(e),a=1-s,n=s===f?1:-1,i=r+16*n,c=r+32*n;if(i&136)return o;let u=c&136?P:0;t.get(i)===l&&(J(t,o,$(e,r,i,0,0,0,0,0,u,0)),!nt(e)&&(c&136)==0&&t.get(c)===l&&J(t,o,$(e,r,c,0,0,0,0,0,0,i)));let m=t.current.ep;for(let S of Xe){let h=i+S;if(h&136)continue;let I=t.get(h);if(h===m){let G=r+S,ot=t.get(G);J(t,o,$(e,r,h,ot,G,0,0,0,u,0))}else I!==l&&C(I)===a&&J(t,o,$(e,r,h,I,h,0,0,0,u,0))}return o}function J(t,e,r){let o=C(r.what);t.save(),b(t,r),Et(t,o)||e.push(r),t.restore()}function de(t,e,r){let o=C(r.what),s=Math.min(r.castleRookFrom,r.castleRookDest,r.from,r.dest),a=Math.max(r.castleRookFrom,r.castleRookDest,r.from,r.dest);for(let u=s;u<=a;u++){if(u===r.from||u===r.castleRookFrom)continue;if(t.get(u)!==l)return}t.save(),t.set(r.from,l),t.set(r.castleRookFrom,l);let n=Math.min(r.from,r.dest),i=Math.max(r.from,r.dest);for(let u=n;u<=i;u++)t.set(u,r.what);let c=Et(t,o);t.restore(),!c&&J(t,e,r)}function Ee(t){let e=0,r=Array(8).fill(0),o=0;for(let n=0;n<128;n+=16)for(let i=0;i<8;i++){let c=n|i,u=t.get(c);if(u===l)continue;let m=E(u);if(m===y||m===T||m===P)return!1;e++,m===g&&(o+=(c>>>4^c)&1),r[m]++}if(e===2)return!0;let s=r[g],a=r[M];return e===3&&(s===1||a===1)||e===s+2&&(o===0||o===s)}function Y(t,e){let r=1-e,o=Et(t,r),s=N(t,r).length>0,a=t.putBoardHash(kt(t)),n=tr(t,o,s,a);return{enemyInCheck:o,enemyCanMove:s,newGameStatus:n}}function tr(t,e,r,o){let s=t.current.status;return r?t.current.clock>=100?_t:o>=3?wt:Ee(t)?vt:s:e?z:at}var er=/[1-8]/,rr=/[PBNRQK]/,or=/[pbnrqk]/;function ct(t,e){e&&e.reset();let r=e||new Z;t=t.trim();let o=t.split(/\s+/g);if(o.length!==6)throw new d("Bad FEN string: Wrong number of sections");let s=o[0].split("/");if(s.length!==8)throw new d("Bad FEN string: Board data should have 8 ranks");for(let i=7;i>=0;i--){let c=0,u=s[7-i];for(let m=0;m<8;m++){let S=i<<4|m;if(c>=u.length)throw new d(`Bad FEN string: Rank ${i+1} had less than 8 files`);let h=u[c++];if(er.test(h)){let I=parseInt(h,10);for(let G=0;G<I;G++)r.set(S+G,l);m+=I-1}else if(rr.test(h)){let I=Ce(h);r.set(S,he(f,I,i))}else if(or.test(h)){let I=Ce(h);r.set(S,he(A,I,i))}}if(c<u.length)throw new d(`Bad FEN string: Rank ${i+1} had more than 8 files`)}let a=sr(o[1]);r.current.turn=a,r.current.castles=nr(o[2]),o[3]!=="-"&&(r.current.ep=U(o[3])),r.current.clock=Te(o[4]),r.current.moveNum=Te(o[5]);let n=Y(r,1-a);return r.current.status=n.newGameStatus,r}function Ce(t){switch(t.toLowerCase()){case"p":return y;case"b":return g;case"n":return M;case"r":return T;case"q":return P;case"k":return w}throw new d("Bad FEN string: Unknown piece: "+t)}function sr(t){switch(t){case"w":return f;case"b":return A}throw new d("Bad FEN string: Invalid turn: "+t)}function nr(t){if(t.length>4)throw new d("Bad FEN string: Castle eligibility list is too long");let e=136,r=136,o=136,s=136;if(t!=="-")for(let a=0;a<t.length;a++)switch(t[a]){case"K":r=7;break;case"Q":e=0;break;case"k":s=119;break;case"q":o=112;break;default:throw new d("Bad FEN string: Unknown character in castle eligibility list: "+t[a])}return At(e,r,o,s)}function he(t,e,r){return e===y?ft(e,t,!(r===1&&t===f||r===6&&t===A)):ft(e,t,!1)}function Te(t){let e=parseInt(t,10);if(isNaN(e))throw new d("Bad FEN string: Bad number: "+t);return e}var Se={"":y,B:g,N:M,R:T,Q:P,K:w},ar=/^(?:O-O(?:-O)?|0-0(?:-0)?)$/,ir=/^([BNRQK]?)([a-h]?)([1-8]?)(x?)([a-h][1-8])(?:=([BNRQ]))?(?:\s+|[!?]+|[+#]|[eE]\.?[pP]\.?|(?:1|0|1\/2|Â½)-(?:1|0|1\/2|Â½))*$/;function Rt(t,e){if(e=e.trim(),ar.test(e))return ye(t,e,e.length===5?s=>(s.castleRookDest&7)==3:s=>(s.castleRookDest&7)==5);let r=e.match(ir);if(!r)throw new B(`Couldn't parse: ${e}`);let o=ye(t,e,s=>U(r[5])===s.dest&&E(s.what)===Se[r[1]]&&(r[2]?(s.from&7)==r[2].charCodeAt(0)-97:!0)&&(r[3]?(s.from>>>4&7)==r[3].charCodeAt(0)-49:!0)&&(r[4]?s.capture!==0:s.capture===0));if(r[6]){if(E(o.what)!==y)throw new B(`Piece at ${r[5]} is not a pawn`);if(!o.promote)throw new B(`Pawn at ${r[5]} is not eligible for promotion`);o.promote=Se[r[6]]}return o}function ye(t,e,r){let o=null;for(let s=0;s<t.length;s++){let a=t[s];if(r(a)){if(o)throw new B(`${e} is ambiguous`);o=a}}if(o)return o;throw new B(`${e} is not a valid move`)}function Dt(t,e,r){let o;if(e.castleRook)o=e.castleRookFrom<e.from?"O-O-O":"O-O";else{let a=cr(t,e),n=ge(E(e.what)),i=e.capture?"x":"",c=v(e.dest),u=e.promote?"="+ge(e.promote):"";o=`${n}${a}${i}${c}${u}`}let s=r?pr(r):"";return`${o}${s}`}function cr(t,e){let r=v(e.from);if(E(e.what)===y&&e.capture)return r[0];let o=t.filter(n=>n.from!==e.from&&n.dest===e.dest&&E(n.what)===E(e.what));if(!o.length)return"";let[s,a]=lt(e.from);return o.every(n=>lt(n.from)[0]!==s)?r[0]:o.every(n=>lt(n.from)[1]!==a)?r[1]:r}function ge(t){switch(t){case g:return"B";case M:return"N";case T:return"R";case P:return"Q";case w:return"K";default:return""}}function pr(t){return t.enemyInCheck?t.enemyCanMove?"+":"#":""}var ur=/^([a-h][1-8])[- ]*([a-h][1-8])$/,lr={N:M,B:g,R:T,Q:P};function Me(t,e,r){let o=e.match(ur);return o?fr(t,o[1],o[2],r):mr(t,e)}function fr(t,e,r,o){let s=U(e),a=U(r);if(t.get(s)===l)throw new B(`Departure square (${e}) is empty`);let i=t.current.turn,c=N(t,i),u=c.find(h=>h.from===s&&h.dest===a);if(!u)throw new B(`Invalid move: ${e}${r}`);if(u.promote){if(o==null)throw new gt;if(u.promote=lr[o],!u.promote)throw new B(`Invalid promotion: ${o}`)}let m=t.current.moveNum;b(t,u);let S=Y(t,i);return t.current.status=S.newGameStatus,{num:m,side:i===f?"white":"black",from:e,dest:r,san:Dt(c,u,S),move:u}}function mr(t,e){let r=t.current.turn,o=N(t,r),s=Rt(o,e),a=t.current.moveNum;b(t,s);let n=Y(t,r);return t.current.status=n.newGameStatus,{num:a,side:r===f?"white":"black",from:v(s.from),dest:v(s.dest),san:Dt(o,s,n),move:s}}var dr=/^[A-Z][a-zA-Z0-9_]*$/,Er=/^[\u0020-\u007e]*$/;function tt(t,e){if(!dr.test(t))throw new Q("Invalid PGN tag name: "+t);if(!Er.test(e))throw new Q("Invalid characters in PGN tag value")}var Cr=/^\s/,hr=/^[\[\]().*]/,Tr=/^\d/,Sr=/^[a-z0-9]/i,yr=/^[-a-z0-9_+#=:/]/i,gr=/^\d+$/,Mr=/^(1-0|0-1|1\/2-1\/2)$/;function Pe(t){var n;let e=Ir(t),r={},o=[];for(;((n=e[0])==null?void 0:n.type)==="[";)Pr(e,r);let s=r.SetUp==="1"&&r.FEN?ct(r.FEN):Gt();Ar(e,s,o);let a=wr(e,s);if(r.Result&&a!==r.Result)throw new d("PGN Result tag has an incorrect game status");return{board:s,tags:r,moves:o,winner:vr(a)}}function Pr(t,e){let r=t.shift();ht(r,"[");let o=t.shift();ht(o,"Sym");let s=t.shift();ht(s,"Str");let a=t.shift();if(ht(a,"]"),tt(o.value,s.value),e[o.value])throw new d("Duplicate PGN tag: "+o.value);e[o.value]=s.value}function Ar(t,e,r){for(;;){let o=t.shift();if(!o)throw new d("PGN move list didn't have a conclusion");if(o.type==="Int"){if(e.current.moveNum!==o.value)throw new d(`PGN move list expected it to be turn ${o.value}, but the board is on ${e.current.moveNum}'`);continue}if(o.type!=="."&&o.type!=="Nag"){if(o.type==="*"){t.unshift(o);break}if(o.type==="("){let s=1;for(;s;){let a=t.shift();if(!a)throw new d("PGN move list didn't have a conclusion");a.type==="("?s++:a.type===")"&&s--}continue}if(o.type==="Sym"){if(Mr.test(o.value)){t.unshift(o);break}_r(e,r,o.value);continue}throw new d(`PGN data had unexpected data in the move list: ${Ae(o)}`)}}}function wr(t,e){let r=t.shift();if(!r)throw new d("PGN move list didn't have a conclusion");if(t.length)throw new d("PGN had extra moves after game ended");if(r.type==="*")return"*";ht(r,"Sym");let o=r;switch(o.value){case"1-0":case"0-1":return e.current.status===j&&(e.current.status=mt),o.value;case"1/2-1/2":{let s=Y(e,1-e.current.turn);return e.current.status=s.newGameStatus>=D?s.newGameStatus:D,o.value}default:throw new d(`PGN had an unexpected game end: ${o.value}`)}}function _r(t,e,r){let o=t.current.turn,s=N(t,o),a=Rt(s,r);e.push({num:t.current.moveNum,turn:t.current.turn,move:a,san:r}),b(t,a);let n=Y(t,o);t.current.turn=1-o,(n.newGameStatus<D||n.newGameStatus===at)&&(t.current.status=n.newGameStatus)}function vr(t){switch(t){case"1-0":return"white";case"0-1":return"black";case"1/2-1/2":return"draw";default:return null}}function Ir(t){let e=0,r=t.length,o=[],s=0;for(;e<r;){let a=t[e];if(Cr.test(a)){e++,a===`
`&&(s=e);continue}if(e===s&&a==="%"){for(;e<r&&t[++e]!==`
`;);continue}if(a===";"){for(;e<r&&t[++e]!==`
`;);continue}if(a==="{"){for(;e<r&&t[++e]!=="}";);e++;continue}if(hr.test(a)){e++,o.push({type:a});continue}if(a==='"'){let n="";for(;;){let i=t[++e];if(e>=r)throw new d("Invalid PGN: String reached the end without being closed.");if(i==='"'){e++;break}if(i==="\\"){let u=t[++e];if(e>=r)throw new d("Invalid PGN: String reached the end without being closed.");if(u==='"'||u==="\\")n+=u;else throw new d(`Invalid PGN string escape: '\\${u}'. Can only be '\\\\' or '\\"'.`);continue}let c=i.charCodeAt(0);if(c<32||c>126)throw new d("PGN strings can only contain printable ASCII characters.");n+=i}if(n.length>=256)throw new d("PGN strings must be at most 255 characters long.");o.push({type:"Str",value:n});continue}if(a==="$"){let n="";for(;e<r;){let i=t[++e];if(!Tr.test(i))break;n+=i}if(!n)throw new d("PGN $ characters must be followed by a digit");o.push({type:"Nag",value:parseInt(n,10)});continue}if(Sr.test(a)){let n=a;for(;e<r;){let i=t[++e];if(e>=r||!yr.test(i))break;n+=i}if(gr.test(n)){o.push({type:"Int",value:parseInt(n,10)});continue}for(let i=0;i<2;i++){let c=t[e];if(c!=="!"&&c!=="?")break;n+=c,e++}if(n.length>=256)throw new d("PGN symbols must be at most 255 characters long.");o.push({type:"Sym",value:n});continue}throw new d(`PGN has invalid character: ${a} at ${t.slice(e-20,e+20)}`)}return o}function ht(t,e){(!t||t.type!==e)&&new d(`Expected a '${e}' token, but got ${Ae(t)}.`)}function Ae(t){if(!t)return"the end-of-file";switch(t.type){case"[":case"]":case"(":case")":case".":case"*":return`a '${t.type}`;case"Int":return`the Integer '${t.value}'`;case"Str":return`the String '${t.value}'`;case"Sym":return`the Symbol '${t.value}'`;case"Nag":return`the NAG Code $${t.value}`;default:return`the unknown symbol: ${JSON.stringify(t)}`}}var we=80;function _e({winner:t,moves:e,tags:r}){let o=Gr(t);r=yt({Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:o},r);let s="";for(let n of Object.keys(r))s+=kr(n,r[n])+`
`;s+=`
`;let a=0;for(let n=0;n<e.length;n++){let i=e[n],c="";(!n||i.side==="white")&&(c+=i.num,c+=i.side==="white"?". ":"... "),c+=i.san,a+=c.length,a>we&&(s+=`
`,a=c.length),s+=c,a<we&&(s+=" ",a++)}return s+=o,s}function kr(t,e){return tt(t,e),e=e.replace(/["\\]/g,"\\$&"),`[${t} "${e}"]`}function Gr(t){switch(t){case"white":return"1-0";case"black":return"0-1";case"draw":return"1/2-1/2";default:return"*"}}var Nr={[j]:"active",[z]:"checkmate",[mt]:"resigned",[D]:"draw-other",[at]:"draw-stalemate",[wt]:"draw-repetition",[_t]:"draw-fifty-moves",[vt]:"draw-no-material"},_,et,F,pt,H,Tt=class{constructor(e){x(this,_,void 0);x(this,et,[]);x(this,F,null);x(this,pt,null);x(this,H,{});k(this,_,e),this.setTag("Date",new Date)}static NewStandardGame(){return new Tt(Gt())}static NewFromFEN(e){let r=new Tt(ct(e));return r.maybeRefreshWinner(),r.setTag("SetUp",!0),r.setTag("FEN",e),r}static NewFromPGN(e){let r=Pe(e),o=new Tt(r.board);return k(o,H,r.tags),p(o,et).push(...r.moves.map(s=>({num:s.num,side:s.turn===f?"white":"black",from:v(s.move.from),dest:v(s.move.dest),san:s.san,move:s.move}))),r.winner&&k(o,F,r.winner),o}getTags(){return yt({},p(this,H))}setTag(e,r){if(r==null){tt(e,""),delete p(this,H)[e];return}let o;typeof r=="boolean"?o=r?"1":"0":r instanceof Date?o=isNaN(r.valueOf())?"????.??.??":[r.getFullYear(),String(r.getMonth()+1).padStart(2,"0"),String(r.getDate()).padStart(2,"0")].join("."):o=String(r),tt(e,o),p(this,H)[e]=o}history(){return p(this,et).map(e=>({num:e.num,side:e.side,from:e.from,dest:e.dest,san:e.san}))}getStatus(){let e=p(this,_).current,r={state:Nr[e.status],turn:e.turn===f?"white":"black"};return p(this,F)&&(r.winner=p(this,F)),p(this,pt)&&(r.reason=p(this,pt)),r}isGameOver(){return Boolean(p(this,_).current.status)}move(e,r){if(this.isGameOver())throw new st;let o=Me(p(this,_),e,r);return p(this,et).push(o),this.maybeRefreshWinner(),this}allMoves(e){if(this.isGameOver())return[];let r=p(this,_).current.turn,o;if(e==null)o=N(p(this,_),r);else{let s=U(e),a=p(this,_).get(s);if(a===l||C(a)!==r)return[];o=Ut(p(this,_),s)}return o.map(s=>({from:v(s.from),dest:v(s.dest),promotion:Boolean(s.promote)}))}resignGame(e){if(this.isGameOver())throw new st;p(this,_).current.status=mt,k(this,F,e==="white"?"black":"white")}drawGame(e){if(this.isGameOver())throw new st;p(this,_).current.status=D,e&&k(this,pt,e)}toString(e="ascii"){switch(e){case"ascii":return Yt(p(this,_),!1);case"terminal":return Yt(p(this,_),!0);case"fen":return te(p(this,_));case"pgn":return _e({board:p(this,_),winner:p(this,F),moves:p(this,et),tags:p(this,H)});default:throw new Q(e)}}maybeRefreshWinner(){let e=p(this,_).current.status,r=p(this,_).current.turn;e===z?k(this,F,r===f?"black":"white"):e>=D&&k(this,F,"draw")}},ve=Tt;_=new WeakMap,et=new WeakMap,F=new WeakMap,pt=new WeakMap,H=new WeakMap;var V=Vt(2,32),ut=1e3;function Ie(t){if(isNaN(t)||t>ut||t<-ut||t===0)throw new Error("Out of range checkmate score: "+t);return t>0?V+ut-t:-V-ut-t}function ke(t){if(isNaN(t)||t>=V||t<=-V)throw new Error("Out of range move score: "+t);return t}function Ge(t){return t>=V?"+M"+(V+ut-t):t<=-V?"-M"+(t+V+ut):String(t)}function Ne(t,e,r,o,s){return xe(t,e,0,r,-Infinity,Infinity,o,s)}function xe(t,e,r,o,s,a,n,i){let c=1-e;if(Y(t,c).newGameStatus===z)return{score:Ie(-r),nodes:1};if(r>=o)return{score:ke(i(t)),nodes:1};let m=e===f?-Infinity:Infinity,S=[],I=[...N(t,e)].sort(n),G=0;for(let ot of I){t.save(),b(t,ot);let{score:K,nodes:Oe}=xe(t,c,r+1,o,s,a,n,i);if(t.restore(),G+=Oe,K===m)S.push(ot);else if(e===f){if(K>m&&(m=K,S=[ot]),s<K&&(s=K),s>=a)break}else if(e===A&&(K<m&&(m=K,S=[ot]),a>K&&(a=K),a<=s))break}return r?{score:m,nodes:G}:{score:m,move:xr(S),nodes:G}}function xr(t){return t[Math.floor(Math.random()*t.length)]}function Re(t){return t==="white"?f:A}var rt,St,Bt,Wt=class{constructor(e,r){x(this,rt,void 0);x(this,St,void 0);x(this,Bt,new Z);k(this,rt,e),k(this,St,r)}static NewForGame(e,r){return new Wt(e,Re(r))}takeTurn(){let e=p(this,Bt),r=p(this,rt).getStatus();if(r.state!=="active"){console.warn("Game over");return}let o=Re(r.turn);if(o!==p(this,St)){console.warn("Not my turn...");return}let s=p(this,rt).toString("fen");ct(s,e);let a=Date.now(),n=Ne(e,o,3,Rr,Br);if(!n.move)throw new Error("Need move list");let i=v(n.move.from)+v(n.move.dest);console.log("Best Move (%s) = [%s] in %d ms (%d nodes considered)",Ge(n.score),i,Date.now()-a,n.nodes),p(this,rt).move(i,"Q")}},Be=Wt;rt=new WeakMap,St=new WeakMap,Bt=new WeakMap;function Rr(t,e){return E(e.capture)-E(t.capture)}function Br(t){let e=Or(t),r=br(t);return e+.25*r}function Or(t){let e=0;for(let r=0;r<128;r+=16)for(let o=0;o<8;o++){let s=r|o,a=t.get(s);if(a===l)continue;let n=Yr(E(a));C(a)===f?e+=n:e-=n}return e}function br(t){return N(t,f).length-N(t,A).length}function Yr(t){switch(t){case y:return 1;case M:return 3;case g:return 3;case T:return 5;case P:return 9;case w:return 200;default:return 0}}return Fr;})();
